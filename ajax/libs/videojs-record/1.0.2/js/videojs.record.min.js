!function(e,i){"function"==typeof define&&define.amd?define(["videojs"],i):"object"==typeof module&&module.exports?module.exports=i(require("videojs")):e.returnExports=i(e.videojs)}(this,function(e){"use strict";var i=e.getComponent("Component"),t=e.getComponent("Button");e.RecordBase=e.extend(i,{IMAGE_ONLY:"image_only",AUDIO_ONLY:"audio_only",VIDEO_ONLY:"video_only",AUDIO_VIDEO:"audio_video",ANIMATION:"animation",RECORDRTC:"recordrtc",LIBVORBISJS:"libvorbis.js",isEdge:function(){return!(-1===navigator.userAgent.indexOf("Edge")||!navigator.msSaveBlob&&!navigator.msSaveOrOpenBlob)},isOpera:function(){return!!window.opera||-1!==navigator.userAgent.indexOf("OPR/")},isChrome:function(){return!this.isOpera()&&!this.isEdge()&&!!navigator.webkitGetUserMedia},constructor:function(e,t){i.call(this,e,t)}}),e.RecordRTCEngine=e.extend(e.RecordBase,{setup:function(e,i,t){this.inputStream=e,this.mediaType=i,this.debug=t,this.engine=new MRecordRTC,this.engine.mediaType=this.mediaType,this.engine.disableLogs=!this.debug,this.engine.bufferSize=this.bufferSize,this.engine.sampleRate=this.sampleRate,this.engine.quality=this.quality,this.engine.frameRate=this.frameRate,this.engine.addStream(this.inputStream)},start:function(){this.engine.startRecording()},stop:function(){this.engine.stopRecording(this.onStopRecording.bind(this))},onStopRecording:function(e,i){this.mediaURL=e;var t=this.player().recorder.getRecordType();this.engine.getBlob(function(e){switch(t){case this.AUDIO_ONLY:this.recordedData=e.audio,this.trigger("recordComplete");break;case this.VIDEO_ONLY:case this.AUDIO_VIDEO:void 0!==e.video&&(this.recordedData=e.video,t===this.AUDIO_VIDEO&&this.isChrome()&&(this.recordedData=e),this.trigger("recordComplete"));break;case this.ANIMATION:this.recordedData=e.gif,this.trigger("recordComplete")}}.bind(this))}}),e.LibVorbisEngine=e.extend(e.RecordBase,{setup:function(e,i,t){this.inputStream=e,this.mediaType=i,this.debug=t,this.options={workerURL:this.audioWorkerURL,moduleURL:this.audioModuleURL,encoderOptions:{channels:2,sampleRate:this.sampleRate,quality:.8}}},start:function(){this.chunks=[],this.audioContext=new AudioContext,this.audioSourceNode=this.audioContext.createMediaStreamSource(this.inputStream),this.scriptProcessorNode=this.audioContext.createScriptProcessor(this.bufferSize),libvorbis.OggVbrAsyncEncoder.create(this.options,this.onData.bind(this),this.onStopRecording.bind(this)).then(this.onEngineCreated.bind(this))},stop:function(){this.audioSourceNode.disconnect(this.scriptProcessorNode),this.scriptProcessorNode.disconnect(this.audioContext.destination),this.encoder.finish()},onEngineCreated:function(e){this.encoder=e,this.scriptProcessorNode.onaudioprocess=this.onAudioProcess.bind(this),this.audioSourceNode.connect(this.scriptProcessorNode),this.scriptProcessorNode.connect(this.audioContext.destination)},onAudioProcess:function(e){var i=e.inputBuffer,t=(i.length,i.getChannelData(0)),s=i.getChannelData(1),o=[t=new Float32Array(t),s=new Float32Array(s)];this.encoder.encode(o)},onData:function(e){this.chunks.push(e)},onStopRecording:function(){this.recordedData=new Blob(this.chunks,{type:"audio/ogg"}),this.mediaURL=URL.createObjectURL(this.recordedData),this.trigger("recordComplete")}}),e.Recorder=e.extend(e.RecordBase,{constructor:function(e,t){i.call(this,e,t),this.recordImage=this.options_.options.image,this.recordAudio=this.options_.options.audio,this.recordVideo=this.options_.options.video,this.recordAnimation=this.options_.options.animation,this.maxLength=this.options_.options.maxLength,this.debug=this.options_.options.debug,this.audioEngine=this.options_.options.audioEngine,this.audioWorkerURL=this.options_.options.audioWorkerURL,this.audioModuleURL=this.options_.options.audioModuleURL,this.audioBufferSize=this.options_.options.audioBufferSize,this.audioSampleRate=this.options_.options.audioSampleRate,this.animationFrameRate=this.options_.options.animationFrameRate,this.animationQuality=this.options_.options.animationQuality,this._recording=!1,this._processing=!1,this._deviceActive=!1,this.getUserMedia=(navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia).bind(navigator),this.player().one("ready",this.setupUI.bind(this))},setupUI:function(){switch(this.player().controlBar.addChild(this.player().cameraButton),this.player().controlBar.el().insertBefore(this.player().cameraButton.el(),this.player().controlBar.el().firstChild),this.player().controlBar.el().insertBefore(this.player().recordToggle.el(),this.player().controlBar.el().firstChild),void 0!==this.player().controlBar.remainingTimeDisplay&&(this.player().controlBar.remainingTimeDisplay.el().style.display="none"),void 0!==this.player().controlBar.liveDisplay&&(this.player().controlBar.liveDisplay.el().style.display="none"),this.getRecordType()){case this.AUDIO_ONLY:this.surfer=this.player().waveform,this.surfer&&(this.playhead=this.surfer.el().getElementsByTagName("wave")[1],this.playhead.style.display="none");break;case this.IMAGE_ONLY:case this.VIDEO_ONLY:case this.AUDIO_VIDEO:case this.ANIMATION:this.player().bigPlayButton.hide(),this.player().options_.controls&&(this.player().controlBar.progressControl.hide(),this.player().on("userinactive",function(e){this.player().userActive(!0)}),this.player().controlBar.show(),this.player().controlBar.el().style.display="flex")}this.player().off("timeupdate"),this.setDuration(this.maxLength),this.player().controlBar.playToggle.hide()},isRecording:function(){return this._recording},isProcessing:function(){return this._processing},isDestroyed:function(){return this.player()&&null===this.player().children()},getDevice:function(){switch(void 0===this.deviceReadyCallback&&(this.deviceReadyCallback=this.onDeviceReady.bind(this)),void 0===this.deviceErrorCallback&&(this.deviceErrorCallback=this.onDeviceError.bind(this)),void 0===this.engineStopCallback&&(this.engineStopCallback=this.onRecordComplete.bind(this)),this.getRecordType()){case this.AUDIO_ONLY:this.mediaType={audio:!0,video:!1},this.surfer.microphone.un("deviceReady",this.deviceReadyCallback),this.surfer.microphone.un("deviceError",this.deviceErrorCallback),this.surfer.microphone.on("deviceReady",this.deviceReadyCallback),this.surfer.microphone.on("deviceError",this.deviceErrorCallback),this.surfer.setupPlaybackEvents(!1),this.surfer.liveMode=!0,this.surfer.microphone.paused=!1,this.surfer.microphone.start();break;case this.IMAGE_ONLY:case this.VIDEO_ONLY:this.mediaType={audio:!1,video:!0},this.getUserMedia(this.mediaType,this.onDeviceReady.bind(this),this.onDeviceError.bind(this));break;case this.AUDIO_VIDEO:this.mediaType={audio:!0,video:!0},this.getUserMedia(this.mediaType,this.onDeviceReady.bind(this),this.onDeviceError.bind(this));break;case this.ANIMATION:this.mediaType={audio:!1,video:!1,gif:!0},this.getUserMedia({audio:!1,video:!0},this.onDeviceReady.bind(this),this.onDeviceError.bind(this))}},onDeviceReady:function(i){if(this._deviceActive=!0,this.stream=i,this.player().trigger("deviceReady"),this.player().deviceButton.hide(),this.setDuration(this.maxLength),this.setCurrentTime(0),this.player().controlBar.playToggle.hide(),this.off(this.player(),"timeupdate",this.playbackTimeUpdate),this.off(this.player(),"pause",this.onPlayerPause),this.off(this.player(),"play",this.onPlayerStart),this.getRecordType()!==this.IMAGE_ONLY){if(this.getRecordType()!==this.AUDIO_ONLY&&this.audioEngine===this.LIBVORBISJS)throw new Error("Currently libvorbis.js is only supported in audio-only mode.");this.audioEngine===this.RECORDRTC?this.engine=new e.RecordRTCEngine(this.player()):this.audioEngine===this.LIBVORBISJS&&(this.engine=new e.LibVorbisEngine(this.player())),this.engine.on("recordComplete",this.engineStopCallback),this.engine.bufferSize=this.audioBufferSize,this.engine.sampleRate=this.audioSampleRate,this.engine.audioWorkerURL=this.audioWorkerURL,this.engine.audioModuleURL=this.audioModuleURL,this.engine.quality=this.animationQuality,this.engine.frameRate=this.animationFrameRate,this.engine.setup(this.stream,this.mediaType,!this.debug);var t,s=[this.player().controlBar.currentTimeDisplay,this.player().controlBar.timeDivider,this.player().controlBar.durationDisplay];for(t in s)s[t].el().style.display="block",s[t].show();this.player().recordToggle.show()}else this.player().recordIndicator.disable(),this.retrySnapshot(),this.player().cameraButton.onStop(),this.player().cameraButton.show();this.getRecordType()!==this.AUDIO_ONLY&&(this.mediaElement=this.player().el().firstChild,this.mediaElement.controls=!1,this.mediaElement.muted=!0,this.displayVolumeControl(!1),this.load(URL.createObjectURL(this.stream)),this.mediaElement.play())},onDeviceError:function(e){this._deviceActive=!1,this.player().deviceErrorCode=e,this.player().trigger("deviceError")},start:function(){if(!this.isProcessing()){switch(this._recording=!0,this.player().controlBar.playToggle.hide(),this.getRecordType()){case this.AUDIO_ONLY:this.surfer.setupPlaybackEvents(!1),this.playhead.style.display="none",this.surfer.microphone.paused=!1,this.surfer.liveMode=!0,this.player().play();break;case this.VIDEO_ONLY:case this.AUDIO_VIDEO:this.startVideoPreview();break;case this.ANIMATION:this.player().recordCanvas.hide(),this.player().animationDisplay.hide(),this.mediaElement.style.display="block",this.captureFrame(),this.startVideoPreview()}this.getRecordType()!==this.IMAGE_ONLY?(this.startTime=(new Date).getTime(),this.countDown=this.setInterval(this.onCountDown.bind(this),100),this.engine.start()):this.createSnapshot(),this.player().trigger("startRecord")}},stop:function(){this.isProcessing()||(this._recording=!1,this._processing=!0,this.player().trigger("stopRecord"),this.getRecordType()!==this.IMAGE_ONLY?(this.clearInterval(this.countDown),this.engine&&this.engine.stop()):this.player().recordedData&&this.player().trigger("finishRecord"))},stopDevice:function(){this.isRecording()?(this.player().one("finishRecord",this.stopStream.bind(this)),this.stop()):this.stopStream()},stopStream:function(){if(this.stream){if(this.isChrome()){var e;switch(this.getRecordType()){case this.AUDIO_ONLY:this.surfer.microphone.stopDevice();break;case this.VIDEO_ONLY:case this.ANIMATION:case this.IMAGE_ONLY:(e=this.stream.getVideoTracks()[0]).stop();break;case this.AUDIO_VIDEO:e=this.stream.getTracks();for(var i in e)e[i].stop()}}else this.getRecordType()===this.AUDIO_ONLY?this.surfer.microphone.stopDevice():this.stream.stop();this._deviceActive=!1}},onRecordComplete:function(){switch(this.mediaURL=this.engine.mediaURL,this.getRecordType()){case this.AUDIO_ONLY:this.player().controlBar.playToggle.show(),this.player().recordedData=this.engine.recordedData,this.player().trigger("finishRecord"),this.player().one("pause",function(){this.surfer.setupPlaybackEvents(!0),this.player().loadingSpinner.show(),this.playhead.style.display="block",this.surfer.surfer.once("ready",function(){this._processing=!1}.bind(this)),this.load(this.player().recordedData)}.bind(this)),this.player().pause();break;case this.VIDEO_ONLY:case this.AUDIO_VIDEO:this.player().controlBar.playToggle.show(),this.player().recordedData=this.engine.recordedData,this.player().trigger("finishRecord"),this.off(this.player(),"pause",this.onPlayerPause),this.off(this.player(),"play",this.onPlayerStart),this.player().one("pause",function(){this._processing=!1,this.player().loadingSpinner.hide(),this.setDuration(this.streamDuration),this.on(this.player(),"timeupdate",this.playbackTimeUpdate),this.getRecordType()===this.AUDIO_VIDEO&&this.isChrome()&&(void 0===this.extraAudio&&(this.extraAudio=this.createEl("audio"),this.extraAudio.id="extraAudio",this.player().on("volumechange",this.onVolumeChange.bind(this))),this.extraAudio.src=URL.createObjectURL(this.player().recordedData.audio),this.on(this.player(),"pause",this.onPlayerPause)),this.on(this.player(),"play",this.onPlayerStart),this.getRecordType()===this.AUDIO_VIDEO&&(this.mediaElement.muted=!1,this.displayVolumeControl(!0)),this.load(this.mediaURL)}.bind(this)),this.player().pause();break;case this.ANIMATION:this.player().controlBar.playToggle.show(),this.player().recordedData=this.engine.recordedData,this.player().trigger("finishRecord"),this._processing=!1,this.player().loadingSpinner.hide(),this.setDuration(this.streamDuration),this.mediaElement.style.display="none",this.player().recordCanvas.show(),this.player().pause(),this.on(this.player(),"play",this.showAnimation),this.on(this.player(),"pause",this.hideAnimation)}},onVolumeChange:function(){var e=this.player().volume();this.player().muted()&&(e=0),this.extraAudio.volume=e},onCountDown:function(){var e=((new Date).getTime()-this.startTime)/1e3,i=this.maxLength;this.streamDuration=e,e>=i&&(e=i,this.stop()),this.setDuration(i),this.setCurrentTime(e,i)},setCurrentTime:function(e,i){switch(this.getRecordType()){case this.AUDIO_ONLY:this.surfer.setCurrentTime(e,i);break;case this.VIDEO_ONLY:case this.AUDIO_VIDEO:case this.ANIMATION:var t=Math.min(e,i);this.player().controlBar.currentTimeDisplay.el().firstChild.innerHTML=this.formatTime(t,i)}},setDuration:function(e){switch(this.getRecordType()){case this.AUDIO_ONLY:this.surfer.setDuration(e);break;case this.VIDEO_ONLY:case this.AUDIO_VIDEO:case this.ANIMATION:this.player().controlBar.durationDisplay.el().firstChild.innerHTML=this.formatTime(e,e)}},load:function(e){switch(this.getRecordType()){case this.AUDIO_ONLY:this.surfer.load(e);break;case this.IMAGE_ONLY:case this.VIDEO_ONLY:case this.AUDIO_VIDEO:case this.ANIMATION:this.mediaElement.src=e}},destroy:function(){switch(this.engine&&this.engine.off("recordComplete",this.engineStopCallback),this.stop(),this.stopDevice(),this.clearInterval(this.countDown),this.getRecordType()){case this.AUDIO_ONLY:this.surfer&&this.surfer.destroy();break;case this.IMAGE_ONLY:case this.VIDEO_ONLY:case this.AUDIO_VIDEO:case this.ANIMATION:this.player().dispose()}this._recording=!1,this._processing=!1,this._deviceActive=!1},getRecordType:function(){return this.recordImage?this.IMAGE_ONLY:this.recordAnimation?this.ANIMATION:this.recordAudio&&!this.recordVideo?this.AUDIO_ONLY:this.recordAudio&&this.recordVideo?this.AUDIO_VIDEO:!this.recordAudio&&this.recordVideo?this.VIDEO_ONLY:void 0},createSnapshot:function(){var e=this.captureFrame();this.player().recordedData=e.toDataURL("image/png"),this.mediaElement.style.display="none",this.player().recordCanvas.show(),this.stop()},retrySnapshot:function(){this._processing=!1,this.player().recordCanvas.hide(),this.player().el().firstChild.style.display="block"},captureFrame:function(){var e=this.player().recordCanvas.el().firstChild;return e.width=this.player().width(),e.height=this.player().height(),e.getContext("2d").drawImage(this.mediaElement,0,0,e.width,e.height),e},startVideoPreview:function(){this.off("timeupdate"),this.off("play"),this.mediaElement.muted=!0,this.displayVolumeControl(!1),this.load(URL.createObjectURL(this.stream)),this.mediaElement.play()},showAnimation:function(){var e=this.player().animationDisplay.el().firstChild;e.width=this.player().width(),e.height=this.player().height(),this.player().recordCanvas.hide(),e.src=this.mediaURL,this.player().animationDisplay.show()},hideAnimation:function(){this.player().recordCanvas.show(),this.player().animationDisplay.hide()},onPlayerStart:function(){this.player().seeking()&&(this.load(this.mediaURL),this.player().play()),this.getRecordType()===this.AUDIO_VIDEO&&this.isChrome()&&!this._recording&&(this.extraAudio.currentTime=this.player().currentTime(),this.extraAudio.play())},onPlayerPause:function(){this.extraAudio.pause()},playbackTimeUpdate:function(){this.setCurrentTime(this.player().currentTime(),this.streamDuration)},displayVolumeControl:function(e){void 0!==this.player().controlBar.volumeMenuButton&&(e=!0===e?"block":"none",this.player().controlBar.volumeMenuButton.el().style.display=e)},formatTime:function(e,i){i=i||e;var t=Math.floor(e%60),s=Math.floor(e/60%60),o=Math.floor(e/3600),r=Math.floor(i/60%60),a=Math.floor(i/3600),n=Math.floor(1e3*(e-t));return(isNaN(e)||e===1/0)&&(o=s=t=n="-"),i>0&&i<this.msDisplayMax?(n<100&&(n=n<10?"00"+n:"0"+n),n=":"+n):n="",o=o>0||a>0?o+":":"",s=((o||r>=10)&&s<10?"0"+s:s)+":",t=t<10?"0"+t:t,o+s+t+n}});var s,o,r,a,n,h;(s=e.extend(t,{constructor:function(e,i){t.call(this,e,i),this.on("click",this.onClick),this.on(e,"startRecord",this.onStart),this.on(e,"stopRecord",this.onStop)}})).prototype.onClick=function(e){e.stopImmediatePropagation();var i=this.player().recorder;i.isRecording()?i.stop():i.start()},s.prototype.onStart=function(){this.removeClass("vjs-icon-record-start"),this.addClass("vjs-icon-record-stop"),this.el().firstChild.firstChild.innerHTML=this.localize("Stop")},s.prototype.onStop=function(){this.removeClass("vjs-icon-record-stop"),this.addClass("vjs-icon-record-start"),this.el().firstChild.firstChild.innerHTML=this.localize("Record")},(o=e.extend(t,{constructor:function(e,i){t.call(this,e,i),this.on("click",this.onClick),this.on(e,"startRecord",this.onStart),this.on(e,"stopRecord",this.onStop)}})).prototype.onClick=function(e){e.stopImmediatePropagation();var i=this.player().recorder;i.isProcessing()?(i.retrySnapshot(),this.onStop()):i.start()},o.prototype.onStart=function(){this.removeClass("vjs-icon-photo-camera"),this.addClass("vjs-icon-photo-retry"),this.el().firstChild.firstChild.innerHTML=this.localize("Retry")},o.prototype.onStop=function(){this.removeClass("vjs-icon-photo-retry"),this.addClass("vjs-icon-photo-camera"),this.el().firstChild.firstChild.innerHTML=this.localize("Image")},(r=e.extend(t,{constructor:function(e,i){t.call(this,e,i),this.on("click",this.onClick)}})).prototype.onClick=function(e){e.stopImmediatePropagation(),this.player().recorder.getDevice()},(a=e.extend(i,{constructor:function(e,t){i.call(this,e,t),this.on(e,"startRecord",this.show),this.on(e,"stopRecord",this.hide)}})).prototype.disable=function(){this.off(this.player(),"startRecord",this.show),this.off(this.player(),"stopRecord",this.hide)},n=e.extend(i),h=e.extend(i);var d=function(e,t,s){var o={className:"vjs-"+e+"-button vjs-control vjs-icon-"+s,innerHTML:'<div class="vjs-control-content"><span class="vjs-control-text">'+t+"</span></div>"},r={role:"button","aria-live":"polite",tabIndex:0};return i.prototype.createEl("div",o,r)},c=function(){var e={className:"vjs-record"},t={tabIndex:0};return i.prototype.createEl("div",e,t)},l={image:!1,audio:!1,video:!1,animation:!1,maxLength:10,audioEngine:"recordrtc",audioBufferSize:4096,audioSampleRate:44100,audioWorkerURL:"",audioModuleURL:"",animationFrameRate:200,animationQuality:10,debug:!1},p=function(t){var p=e.mergeOptions(l,t),u=this;u.recorder=new e.Recorder(u,{el:c(),options:p}),u.addChild(u.recorder),u.deviceButton=new r(u,{el:d("device",u.localize("Device"),"device-perm")}),u.recorder.addChild(u.deviceButton),u.recordIndicator=new a(u,{el:i.prototype.createEl("div",{className:"vjs-record-indicator vjs-control"})}),u.recordIndicator.hide(),u.recorder.addChild(u.recordIndicator),u.recordCanvas=new n(u,{el:i.prototype.createEl("div",{className:"vjs-record-canvas",innerHTML:"<canvas></canvas>"})}),u.recordCanvas.hide(),u.recorder.addChild(u.recordCanvas),u.animationDisplay=new h(u,{el:i.prototype.createEl("div",{className:"vjs-animation-display",innerHTML:"<img />"})}),u.animationDisplay.hide(),u.recorder.addChild(u.animationDisplay),u.cameraButton=new o(u,{el:d("camera",u.localize("Image"),"photo-camera")}),u.cameraButton.hide(),u.recordToggle=new s(u,{el:d("record",u.localize("Record"),"record-start")}),u.recordToggle.hide()};return e.plugin("record",p),p});