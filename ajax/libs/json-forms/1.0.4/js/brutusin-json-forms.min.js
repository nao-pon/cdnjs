String.prototype.startsWith||(String.prototype.startsWith=function(e,t){return t=t||0,this.indexOf(e,t)===t}),String.prototype.endsWith||(String.prototype.endsWith=function(e,t){var n=this.toString();(void 0===t||t>n.length)&&(t=n.length),t-=e.length;var r=n.indexOf(e,t);return-1!==r&&r===t}),String.prototype.includes||(String.prototype.includes=function(){"use strict";return-1!==String.prototype.indexOf.apply(this,arguments)});var BrutusinForms=new Object;BrutusinForms.decorators=new Array,BrutusinForms.addDecorator=function(e){BrutusinForms.decorators[BrutusinForms.decorators.length]=e},BrutusinForms.postRender=null,BrutusinForms.instances=new Array,BrutusinForms.create=function(schema){function validateDepencyMapIsAcyclic(){var e=new Object;for(var t in dependencyMap)e.hasOwnProperty(t)||dfs(e,new Object,t)}function dfs(e,t,n){if(t.hasOwnProperty(n))return void(error="Schema dependency graph has cycles");if(t[n]=null,!e.hasOwnProperty(n)){e[n]=null;var r=dependencyMap[n];if(r)for(var a=0;a<r.length;a++)dfs(e,t,r[a]);delete t[n]}}function removeEmptiesAndNulls(e){if(e instanceof Array){if(0===e.length)return null;for(var t=new Array,n=0;n<e.length;n++)t[n]=removeEmptiesAndNulls(e[n]);return t}if(""===e)return null;if(e instanceof Object){var t=new Object;for(var r in e)if(!r.startsWith("$")||!r.endsWith("$")){var a=removeEmptiesAndNulls(e[r]);null!==a&&(t[r]=a)}return t}return e}function appendChild(e,t,n){e.appendChild(t);for(var r=0;r<BrutusinForms.decorators.length;r++)BrutusinForms.decorators[r](t,n)}function copyProperty(e,t,n){e.hasOwnProperty(n)&&(t[n]=e[n])}function createPseudoSchema(e){var t=new Object;return copyProperty(e,t,"type"),copyProperty(e,t,"title"),copyProperty(e,t,"description"),copyProperty(e,t,"default"),copyProperty(e,t,"required"),copyProperty(e,t,"enum"),t}function cleanSchemaMap(e){for(var t in schemaMap)e.startsWith(t)&&delete schemaMap[t]}function cleanData(e){var t=Expression.parse(e);t.visit(data,function(e,t,n){delete t[n]})}function populateSchemaMap(e,t){if("object"===t.type){var n=createPseudoSchema(t);n.properties=new Object,schemaMap[e]=n;for(var r in t.properties){var a=e+"."+r;n.properties[r]=a,populateSchemaMap(a,t.properties[r])}if(t.additionalProperties){var a=e+"[*]";n.additionalProperties=a,t.additionalProperties.hasOwnProperty("type")?populateSchemaMap(a,t.additionalProperties):populateSchemaMap(a,SCHEMA_ANY)}}else if("array"===t.type){var n=createPseudoSchema(t);n.items=e+"[#]",schemaMap[e]=n,populateSchemaMap(n.items,t.items)}else schemaMap[e]=t;if(t.dependsOn){for(var i=new Array,o=0;o<t.dependsOn.length;o++)t.dependsOn[o].startsWith("$")?i[o]=t.dependsOn[o]:e.endsWith("]")?i[o]=e+"."+t.dependsOn[o]:i[o]=e.substring(0,e.lastIndexOf("."))+"."+t.dependsOn[o];schemaMap[e].dependsOn=i;for(var o=0;o<i.length;o++){var l=dependencyMap[i[o]];l||(l=new Array,dependencyMap[i[o]]=l),l[l.length]=e}}}function renderTitle(e,t,n){if(e&&t){var r=document.createElement("label");"any"!=n.type&&"object"!=n.type&&"array"!=n.type&&(r.htmlFor=getInputId());var a=document.createTextNode(t+":");if(appendChild(r,a,n),n.description&&(r.title=n.description),n.required){var i=document.createElement("sup");appendChild(i,document.createTextNode("*"),n),appendChild(r,i,n),r.className="required"}appendChild(e,r,n)}}function createStaticPropertyProvider(e){var t=new Object;return t.getValue=function(){return e},t.onchange=function(e){},t}function createPropertyProvider(e,t){var n=new Object;return n.getValue=e,n.onchange=t,n}function getInitialValue(id){var ret;try{eval("ret = initialValue"+id.substring(1))}catch(e){ret=null}return ret}function getValue(schema,input){var value;return value=schema["enum"]?input.options[input.selectedIndex].value:input.value,""===value?null:("integer"===schema.type?value=parseInt(value):"number"===schema.type?value=parseFloat(value):"boolean"===schema.type?(value=input.checked,value||(value=!1)):"any"===schema.type&&value&&eval("value="+value),value)}function getSchemaId(e){return e.replace(/\["[^"]*"\]/g,"[*]").replace(/\[\d*\]/g,"[#]")}function getSchema(e){return schemaMap[e]}function onDependecyChanged(e){var t=dependencyMap[e];if(t&&obj.schemaResolver){var n=obj.schemaResolver(t,obj.getData());for(var r in n)if(JSON.stringify(schemaMap[r])!==JSON.stringify(n[r])){cleanSchemaMap(r),cleanData(r),populateSchemaMap(r,n[r]);var a=renderInfoMap[r];a&&render(a.titleContainer,a.container,r,a.parentObject,a.propertyProvider,a.value)}}}function getInputId(){return formId+"_"+inputCounter}function addAdditionalProperty(e,t,n,r,a){var i=getSchemaId(n),o=getSchema(i),l=t.tBodies[0],d=document.createElement("tr"),c=document.createElement("td");c.className="add-prop-name";var u=document.createElement("table"),s=document.createElement("tr"),p=document.createElement("td"),m=document.createElement("td"),h="$"+Object.keys(e).length+"$",f=document.createElement("td");f.className="prop-value";var v=document.createElement("input");v.type="text";var g=createPropertyProvider(function(){return v.value?v.value:h},function(t){t||(t=h),e[g.getValue()]=e[t],delete e[t]});v.onkeyup=function(){v.previousValue!==v.value&&(e.hasOwnProperty(v.value)?(v.validationFailed=!0,v.className.includes(" error")||(v.className+=" error")):(v.validationFailed=!1,v.className=v.className.replace(" error",""))),v.value||(v.validationFailed=!0,v.className.includes(" error")||(v.className+=" error"))},v.onblur=function(){if(!v.value)return void v.focus();if(v.previousValue!==v.value){if(e.hasOwnProperty(v.value))return void v.focus();g.onchange(v.previousValue),v.previousValue=v.value}};var y=document.createElement("button");appendChild(y,document.createTextNode("x"),o),y.onclick=function(){delete e[v.value],t.deleteRow(d.rowIndex),v.value=null,g.onchange(v.previousValue)},appendChild(p,v,o),appendChild(m,y,o),appendChild(s,p,o),appendChild(s,m,o),appendChild(u,s,o),appendChild(c,u,o),appendChild(d,c,o),appendChild(d,f,o),appendChild(l,d,o),appendChild(t,l,o),render(null,f,n,e,g,a),v.onkeyup(),r&&(v.value=r,v.onblur())}function addItem(e,t,n,r){var a=getSchemaId(n),i=getSchema(a),o=document.createElement("tbody"),l=document.createElement("tr");l.className="item";var d=document.createElement("td");d.className="item-index";var c=document.createElement("td");c.className="item-action";var u=document.createElement("td");u.className="item-value";var s=document.createElement("button");appendChild(s,document.createTextNode("x"),i);var p=function(){for(var e=0;e<t.rows.length;e++){var n=t.rows[e];n.cells[0].innerHTML=e+1}};s.onclick=function(){e.splice(l.rowIndex,1),t.deleteRow(l.rowIndex),p()},appendChild(c,s,i);var m=document.createTextNode(t.rows.length+1);appendChild(d,m,i),appendChild(l,d,i),appendChild(l,c,i),appendChild(l,u,i),appendChild(o,l,i),appendChild(t,o,i);var h=createPropertyProvider(function(){return l.rowIndex});render(null,u,n,e,h,r)}function clear(e){if(e)for(;e.firstChild;)e.removeChild(e.firstChild)}function render(e,t,n,r,a,i){var o=getSchemaId(n),l=getSchema(o);renderInfoMap[o]=new Object,renderInfoMap[o].titleContainer=e,renderInfoMap[o].container=t,renderInfoMap[o].parentObject=r,renderInfoMap[o].propertyProvider=a,renderInfoMap[o].value=i,clear(e),clear(t);var d=renderers[l.type];d&&!l.dependsOn&&(l.title?renderTitle(e,l.title,l):a&&renderTitle(e,a.getValue(),l),i||(i=initialValue?getInitialValue(n):l["default"]),d(t,n,r,a,i))}function validate(e){if(e.validationFailed)return e.focus(),!1;if(e.childNodes)for(var t=0;t<e.childNodes.length;t++)if(!validate(e.childNodes[t]))return!1;return!0}var SCHEMA_ANY={type:"any"},obj=new Object,renderers=new Object,schemaMap=new Object,dependencyMap=new Object,renderInfoMap=new Object,container,data,error,initialValue,inputCounter=0,formId="BrutusinForms#"+BrutusinForms.instances.length;populateSchemaMap("$",schema),validateDepencyMapIsAcyclic();var Expression=new Object;return Expression.parse=function(e){function t(e){if(null===e)return null;for(var t=new Array,n=null,r=0,a=0;a<e.length;a++)'"'===e.charAt(a)?null===n?n='"':'"'===n&&(n=null,t[t.length]=e.substring(r,a+1).trim(),r=a+1):"'"===e.charAt(a)?null===n?n="'":"'"===n&&(n=null,t[t.length]=e.substring(r,a+1).trim(),r=a+1):"["===e.charAt(a)?null===n&&(r!==a&&(t[t.length]=e.substring(r,a).trim()),t[t.length]="[",r=a+1):"]"===e.charAt(a)?null===n&&(r!==a&&(t[t.length]=e.substring(r,a).trim()),t[t.length]="]",r=a+1):"."===e.charAt(a)?null===n&&(r!==a&&(t[t.length]=e.substring(r,a).trim()),r=a+1):a===e.length-1&&(t[t.length]=e.substring(r,a+1).trim());return t}(null===e||0===e.length||"."===e)&&(e="$");for(var n=new Array,r=t(e),a=!1,i=0,o="",l=0;l<r.length;l++){var d=r[l];if("["===d){if(a)throw"Error parsing expression '"+e+"': Nested [ found";a=!0,i=0,o+=d}else if("]"===d){if(!a)throw"Error parsing expression '"+e+"': Unbalanced ] found";a=!1,o+=d,n[n.length]=o,o=""}else if(a){if(i>0)throw"Error parsing expression '"+e+"': Multiple tokens found inside a bracket";o+=d,i++}else n[n.length]=d;if(l===r.length-1&&a)throw"Error parsing expression '"+e+"': Unbalanced [ found"}var c=new Object;return c.exp=e,c.queue=n,c.visit=function(e,t){function n(e,r,a,i,o){if(null!=a){var l=r.shift();if("$"===l){e="$";var l=r.shift()}if(l)if(Array.isArray(a)){if(!l.startsWith("["))throw"Node '"+e+"' is of type array";var d=l.substring(1,l.length-1);if(d.equals("#"))for(var c=0;c<a.length;c++){var u=a[c];n(e+l,r.slice(0),u,a,c),n(e+"["+c+"]",r.slice(0),u,a,c)}else if("$"===d){var u=a[a.length-1];n(e+l,r.slice(0),u,a,a.length-1)}else{var s=parseInt(d);if(isNaN(s))throw"Element '"+d+"' of node '"+e+"' is not an integer, or the '$' last element symbol,  or the wilcard symbol '#'";if(0>s)throw"Element '"+d+"' of node '"+e+"' is lower than zero";var u=a[s];n(e+l,r.slice(0),u,a,s)}}else{if("object"!=typeof a)throw"boolean"==typeof a||"number"==typeof a||"string"==typeof a?"Node is leaf but still are tokens remaining: "+l:"Node type '"+typeof a+"' not supported for index field '"+e+"'";if("[*]"===l)for(var p in a){var u=a[p];n(e+l,r.slice(0),u,a,p),n(e+'["'+p+'"]',r.slice(0),u,a,p)}else{var u;if(l.startsWith("[")){var d=l.substring(1,l.length-1);if(!d.startsWith('"')&&!d.startsWith("'"))throw"Element '"+d+"' of node '"+e+"' must be a string expression or wilcard '*'";d=d.substring(1,d.length()-1),e+=l,u=a[d]}else e=e.length>0?e+"."+l:l,u=a[l];n(e,r,u,a,l)}}else t(a,i,o)}}n(c.exp,c.queue,e)},c},renderers.integer=function(e,t,n,r,a){renderers.string(e,t,n,r,a)},renderers.number=function(e,t,n,r,a){renderers.string(e,t,n,r,a)},renderers.any=function(e,t,n,r,a){renderers.string(e,t,n,r,a)},renderers.string=function(e,t,n,r,a){var i,o=getSchemaId(t),l=getSchema(o);if("any"===l.type)i=document.createElement("textarea"),a&&(i.value=JSON.stringify(a,null,4));else if(l["enum"]){if(i=document.createElement("select"),!l.required){var d=document.createElement("option"),c=document.createTextNode("");d.value="",appendChild(d,c,l),appendChild(i,d,l)}for(var u=0,s=0;s<l["enum"].length;s++){var d=document.createElement("option"),c=document.createTextNode(l["enum"][s]);d.value=l["enum"][s],appendChild(d,c,l),appendChild(i,d,l),a&&l["enum"][s]===a&&(u=s,l.required||u++)}i.selectedIndex=u}else i=document.createElement("input"),"integer"===l.type||"number"===l.type?(i.type="number",i.step="any","number"!=typeof a&&(a=null)):"email"===l.format?i.type="email":i.type="text",a&&(i.value=a);return i.schema=o,i.setAttribute("autocorrect","off"),i.onchange=function(){var e,t=!1;try{e=getValue(l,i),l.required&&!e&&(t=!0)}catch(a){t=!0}t?(i.validationFailed=!0,i.className.includes(" error")||(i.className+=" error"),e=null):(i.validationFailed=!1,i.className=i.className.replace(" error","")),n?n[r.getValue()]=e:data=e,onDependecyChanged(o)},l.description&&(i.title=l.description,i.placeholder=l.description),i.onchange(),i.id=getInputId(),inputCounter++,appendChild(e,i,l),n},renderers["boolean"]=function(e,t,n,r,a){var i=getSchemaId(t),o=getSchema(i),l=document.createElement("input");l.type="checkbox",l.schema=i,l.onchange=function(){n?n[r.getValue()]=getValue(o,l):data=getValue(o,l),onDependecyChanged(i)},a===!0&&(l.checked=!0),l.id=getInputId(),inputCounter++,o.description&&(l.title=o.description),l.onchange(),appendChild(e,l,o)},renderers.object=function(e,t,n,r,a){var i=getSchemaId(t),o=getSchema(i),l=new Object;n?(r.getValue()||0===r.getValue())&&(n[r.getValue()]=l):data=l;var d=document.createElement("table");d.className="object";var c=document.createElement("tbody");appendChild(d,c,o);for(var u in o.properties){var s=document.createElement("tr"),p=document.createElement("td");p.className="prop-name";var m=t+"."+u,h=document.createElement("td");h.className="prop-value",appendChild(c,s,o),appendChild(s,p,o),appendChild(s,h,o);var f=createStaticPropertyProvider(u),v=null;a&&(v=a[u]),render(p,h,m,l,f,v)}if(o.additionalProperties){var g=getSchema(o.additionalProperties),y=document.createElement("div");appendChild(y,d,o);var b=document.createElement("button");if(b.onclick=function(){addAdditionalProperty(l,d,t+"[*]")},g.description&&(b.title=g.description),appendChild(b,document.createTextNode("Add"),o),appendChild(y,b,o),a)for(var C in a)o.properties.hasOwnProperty(C)||addAdditionalProperty(l,d,t+'["'+u+'"]',C,a[C]);appendChild(e,y,o)}else appendChild(e,d,o)},renderers.array=function(e,t,n,r,a){var i=getSchemaId(t),o=getSchema(i),l=getSchema(o.items),d=new Array;n?(r.getValue()||0===r.getValue())&&(n[r.getValue()]=d):data=d,r&&(r.onchange=function(e){delete n[e],n[r.getValue()]=d});var c=document.createElement("div"),u=document.createElement("table");u.className="array",appendChild(c,u,o),appendChild(e,c,o);var s=document.createElement("button");if(s.onclick=function(){addItem(d,u,t+"[#]",null)},l.description&&(s.title=l.description),appendChild(s,document.createTextNode("Add item"),o),appendChild(c,u,o),appendChild(c,s,o),a&&a instanceof Array)for(var p=0;p<a.length;p++)addItem(d,u,t+"["+p+"]",a[p]);appendChild(e,c,o)},obj.render=function(e,t){container=e,initialValue=t;var n=document.createElement("form");if(n.className="brutusin-form",n.onsubmit=function(e){return!1},container?appendChild(container,n):appendChild(document.body,n),error){var r=document.createElement("label"),a=document.createTextNode(error);appendChild(r,a),r.className="error-message",appendChild(n,r)}else render(null,n,"$",null,null);rendered=!0,BrutusinForms.postRender&&BrutusinForms.postRender(obj)},obj.validate=function(){return validate(container)},obj.getData=function(){return container?removeEmptiesAndNulls(data):null},BrutusinForms.instances[BrutusinForms.instances.length]=obj,obj};