!function(e){"use strict";"function"==typeof define&&define.amd?define(["jquery","./grid.base","./jquery.fmatter","./grid.common"],e):"object"==typeof module&&module.exports?module.exports=function(l,t){return l||(l=window),void 0===t&&(t="undefined"!=typeof window?require("jquery"):require("jquery")(l)),require("./grid.base"),require("./jquery.fmatter"),require("./grid.common"),e(t),t}:e(jQuery)}(function(e){"use strict";var l=e.jgrid,t=function(){var t=e.makeArray(arguments);return t.unshift(""),t.unshift(""),t.unshift(this.p),l.feedback.apply(this,t)},i=function(l,t){var i=this.grid.fbRows;return null!=(l=null!=i&&i[0].cells.length>t?i[l.rowIndex]:l)&&null!=l.cells?e(l.cells[t]):e()};l.extend({editCell:function(r,a,n){return this.each(function(){var o,d,s,c,u=this,f=e(u),h=u.p,p=u.rows;if(u.grid&&!0===h.cellEdit&&null!=p&&null!=p[r]&&(r=parseInt(r,10),a=parseInt(a,10),!isNaN(r)&&!isNaN(a))){var v,C=p[r],m=null!=C?C.id:null,g=e(C),b=parseInt(h.iCol,10),w=parseInt(h.iRow,10),j=e(p[w]),q=h.savedRow;if(null!=m){if(h.selrow=m,h.knv||f.jqGrid("GridNav"),q.length>0&&j.length>0){if(!0===n&&r===w&&a===b)return;f.jqGrid("saveCell",q[0].id,q[0].ic)}else setTimeout(function(){e("#"+l.jqID(h.knv)).attr("tabindex","-1").focus()},1);if("subgrid"!==(o=(c=h.colModel[a]).name)&&"cb"!==o&&"rn"!==o){s=i.call(u,C,a);var G=c.editable;e.isFunction(G)&&(G=G.call(u,{rowid:m,iCol:a,iRow:r,cmName:o,cm:c,mode:"cell"}));var y=f.jqGrid("getGuiStyles","states.select","edit-cell"),x=f.jqGrid("getGuiStyles","states.hover","selected-row");if(!0!==G||!0!==n||s.hasClass("not-editable-cell"))h.noCellSelection||(b>=0&&w>=0&&(i.call(u,j[0],b).removeClass(y),j.removeClass(x)),s.addClass(y),g.addClass(x)),d=s.html().replace(/&#160;/gi,""),t.call(u,"onSelectCell",m,o,d,r,a);else{h.noCellSelection||(b>=0&&w>=0&&(i.call(u,j[0],b).removeClass(y),j.removeClass(x)),s.addClass(y),g.addClass(x)),c.edittype||(c.edittype="text"),v=c.edittype;try{d=e.unformat.call(u,s,{rowId:m,colModel:c},a)}catch(e){d="textarea"===v?s.text():s.html()}if(h.autoEncodeOnEdit&&(d=l.oldDecodePostedData(d)),("&nbsp;"===d||"&#160;"===d||1===d.length&&160===d.charCodeAt(0))&&(d=""),e.isFunction(h.formatCell)){var k=h.formatCell.call(u,m,o,d,r,a);void 0!==k&&(d=k)}t.call(u,"beforeEditCell",m,o,d,r,a),q.push({id:r,ic:a,name:o,v:d}),h.editingInfo[m]={mode:"cellEditing",savedRow:q[q.length-1],editable:{}},h.editingInfo[m].editable[o]=G;var E=e.extend({},c.editoptions||{},{id:r+"_"+o,name:o,rowId:m,mode:"cell",cm:c,iCol:a}),I=l.createEl.call(u,v,E,d,!0,e.extend({},l.ajaxOptions,h.ajaxSelectOptions||{})),R=s,S=!0===h.treeGrid&&o===h.ExpandColumn;S&&(R=s.children("span.cell-wrapperleaf,span.cell-wrapper")),R.html("").append(I).attr("tabindex","0"),S&&e(I).width(s.width()-s.children("div.tree-wrap").outerWidth()),l.bindEv.call(u,I,E),h.frozenColumns&&a<f.jqGrid("getNumberOfFrozenColumns")&&function(e,l){var t=e.height();Math.abs(t-l)>=1&&l>0&&(e.height(l),t=e.height(),Math.abs(l-t)>=1&&e.height(l+Math.round(l-t)))}(e(u.rows[C.rowIndex].cells[a]),s.height()),setTimeout(function(){e(I).focus()},0),e("input, select, textarea",s).on("keydown",function(l){if(27===l.keyCode&&(e("input.hasDatepicker",s).length>0?e(".ui-datepicker").is(":hidden")?f.jqGrid("restoreCell",r,a):e("input.hasDatepicker",s).datepicker("hide"):f.jqGrid("restoreCell",r,a)),13===l.keyCode&&!l.shiftKey)return f.jqGrid("saveCell",r,a),!1;if(9===l.keyCode){if(u.grid.hDiv.loading)return!1;l.shiftKey?f.jqGrid("prevCell",r,a):f.jqGrid("nextCell",r,a)}l.stopPropagation()}),t.call(u,"afterEditCell",m,o,d,r,a)}h.iCol=a,h.iRow=r}}}})},saveCell:function(r,a){return this.each(function(){var n=this,o=e(n),d=n.p,s=n.grid,c=l.info_dialog,u=l.jqID;if(s&&!0===d.cellEdit){var f=o.jqGrid("getGridRes","errors"),h=f.errcap,p=o.jqGrid("getGridRes","edit").bClose,v=d.savedRow,C=v.length>=1?0:null;if(null!==C){var m,g=n.rows[r],b=null!=g?g.id:null,w=null!=g?e(g):e(),j=d.colModel[a],q=j.name,G=i.call(n,g,a),y={},x=l.getEditedValue.call(n,G,j,y);if(x!==v[C].v){void 0!==(m=o.triggerHandler("jqGridBeforeSaveCell",[b,q,x,r,a]))&&(x=m),e.isFunction(d.beforeSaveCell)&&void 0!==(m=d.beforeSaveCell.call(n,b,q,x,r,a))&&(x=m);var k=l.checkValues.call(n,x,a,void 0,void 0,{oldValue:v[C].v,newValue:x,cmName:q,rowid:b,iCol:a,iRow:r,cm:j,tr:g,td:G,mode:"cell"}),E=j.formatoptions||{};if(null==k||!0===k||!0===k[0]){var I=o.triggerHandler("jqGridBeforeSubmitCell",[b,q,x,r,a])||{};if(e.isFunction(d.beforeSubmitCell)&&((I=d.beforeSubmitCell.call(n,b,q,x,r,a))||(I={})),e("input.hasDatepicker",G).length>0&&e("input.hasDatepicker",G).datepicker("hide"),"date"===j.formatter&&!0!==E.sendFormatted&&(x=e.unformat.date.call(n,x,j)),"remote"===d.cellsubmit)if(d.cellurl){var R={};R[q]=x;var S=d.prmNames,D=S.id,F=S.oper;R[D]=l.stripPref(d.idPrefix,b),R[F]=S.editoper,R=e.extend(I,R),d.autoEncodeOnEdit&&e.each(R,function(t,i){e.isFunction(i)||(R[t]=l.oldEncodePostedData(i))}),o.jqGrid("progressBar",{method:"show",loadtype:d.loadui,htmlcontent:o.jqGrid("getGridRes","defaults.savetext")||"Saving..."}),s.hDiv.loading=!0,e.ajax(e.extend({url:e.isFunction(d.cellurl)?d.cellurl.call(n,d.cellurl,r,a,b,x,q):d.cellurl,data:l.serializeFeedback.call(n,d.serializeCellData,"jqGridSerializeCellData",R),type:"POST",complete:function(l){if(s.endReq.call(n),(l.status<300||304===l.status)&&(0!==l.status||4!==l.readyState)){var i=o.triggerHandler("jqGridAfterSubmitCell",[n,l,R.id,q,x,r,a])||[!0,""];(!0===i||!0===i[0]&&e.isFunction(d.afterSubmitCell))&&(i=d.afterSubmitCell.call(n,l,R.id,q,x,r,a)),null==i||!0===i||!0===i[0]?(o.jqGrid("setCell",b,a,x,!1,!1,!0),G.addClass("dirty-cell"),w.addClass("edited"),t.call(n,"afterSaveCell",b,q,x,r,a),v.splice(0,1),delete d.editingInfo[b]):(c.call(n,h,i[1],p),o.jqGrid("restoreCell",r,a))}},error:function(l,t,i){o.triggerHandler("jqGridErrorCell",[l,t,i]),e.isFunction(d.errorCell)?(d.errorCell.call(n,l,t,i),o.jqGrid("restoreCell",r,a)):(c.call(n,h,l.status+" : "+l.statusText+"<br/>"+t,p),o.jqGrid("restoreCell",r,a))}},l.ajaxOptions,d.ajaxCellOptions||{}))}else try{c.call(n,h,f.nourl,p),o.jqGrid("restoreCell",r,a)}catch(e){}if("clientArray"===d.cellsubmit){if(o.jqGrid("setCell",b,a,"select"===j.edittype&&"select"!==j.formatter?y.text:x,!1,!1,!0),G.addClass("dirty-cell"),w.addClass("edited"),t.call(n,"afterSaveCell",b,q,x,r,a),d.frozenColumns&&a<o.jqGrid("getNumberOfFrozenColumns"))try{n.rows[g.rowIndex].cells[a].style.height=""}catch(e){}v.splice(0,1),delete d.editingInfo[b]}}else try{setTimeout(function(){var t=l.getRelativeRect.call(n,G);c.call(n,h,x+" "+k[1],p,{top:t.top,left:t.left+e(n).closest(".ui-jqgrid").offset().left})},50),o.jqGrid("restoreCell",r,a)}catch(e){}}else o.jqGrid("restoreCell",r,a)}setTimeout(function(){e("#"+u(d.knv)).attr("tabindex","-1").focus()},0)}})},restoreCell:function(l,r){return this.each(function(){var a,n,o,d=this.p,s=this.rows[l],c=s.id;if(this.grid&&!0===d.cellEdit){var u=d.savedRow,f=i.call(this,s,r);if(u.length>=1){if(e.isFunction(e.fn.datepicker))try{e("input.hasDatepicker",f).datepicker("hide")}catch(e){}if(n=d.colModel[r],!0===d.treeGrid&&null!=n&&n.name===d.ExpandColumn?f.children("span.cell-wrapperleaf,span.cell-wrapper").empty():f.empty(),f.attr("tabindex","-1"),a=u[0].v,null!=n&&(o=n.formatoptions||{},"date"===n.formatter&&!0!==o.sendFormatted&&(a=e.unformat.date.call(this,a,n)),e(this).jqGrid("setCell",c,r,a,!1,!1,!0),d.frozenColumns&&r<e(this).jqGrid("getNumberOfFrozenColumns")))try{this.rows[s.rowIndex].cells[r].style.height=""}catch(e){}t.call(this,"afterRestoreCell",c,a,l,r),u.splice(0,1),delete d.editingInfo[c]}setTimeout(function(){e("#"+d.knv).attr("tabindex","-1").focus()},0)}})},nextCell:function(l,t){return this.each(function(){var i,r,a,n=e(this),o=this.p,d=!1,s=this.rows;if(this.grid&&!0===o.cellEdit&&null!=s&&null!=s[l]){for(i=t+1;i<o.colModel.length;i++)if(r=(a=o.colModel[i]).editable,e.isFunction(r)&&(r=r.call(this,{rowid:s[l].id,iCol:i,iRow:l,cmName:a.name,cm:a,mode:"cell"})),!0===r){d=i;break}!1!==d?n.jqGrid("editCell",l,d,!0):o.savedRow.length>0&&n.jqGrid("saveCell",l,t)}})},prevCell:function(l,t){return this.each(function(){var i,r,a,n=e(this),o=this.p,d=!1,s=this.rows;if(this.grid&&!0===o.cellEdit&&null!=s&&null!=s[l]){for(i=t-1;i>=0;i--)if(r=(a=o.colModel[i]).editable,e.isFunction(r)&&(r=r.call(this,{rowid:s[l].id,iCol:i,iRow:l,cmName:a.name,cm:a,mode:"cell"})),!0===r){d=i;break}!1!==d?n.jqGrid("editCell",l,d,!0):o.savedRow.length>0&&n.jqGrid("saveCell",l,t)}})},GridNav:function(){return this.each(function(){var l,t,i=this,r=e(i),a=i.p,n=i.grid;if(n&&!0===a.cellEdit){var o=n.bDiv;a.knv=a.id+"_kn";var d=e("<div style='position:fixed;top:0px;width:1px;height:1px;' tabindex='0'><div tabindex='-1' style='width:1px;height:1px;' id='"+a.knv+"'></div></div>");e(d).insertBefore(n.cDiv),e("#"+a.knv).focus().keydown(function(e){var n=parseInt(a.iRow,10),o=parseInt(a.iCol,10);switch(t=e.keyCode,"rtl"===a.direction&&(37===t?t=39:39===t&&(t=37)),t){case 38:n-1>0&&(s(n-1,o,"vu"),r.jqGrid("editCell",n-1,o,!1));break;case 40:n+1<=i.rows.length-1&&(s(n+1,o,"vd"),r.jqGrid("editCell",n+1,o,!1));break;case 37:o-1>=0&&(s(n,l=c(o-1,"lft"),"h"),r.jqGrid("editCell",n,l,!1));break;case 39:o+1<=a.colModel.length-1&&(s(n,l=c(o+1,"rgt"),"h"),r.jqGrid("editCell",n,l,!1));break;case 13:o>=0&&n>=0&&r.jqGrid("editCell",n,o,!0);break;default:return!0}return!1})}function s(e,l,t){var r=i.rows[e];if("v"===t.substr(0,1)){var a=o.clientHeight,n=o.scrollTop,d=r.offsetTop+r.clientHeight,s=r.offsetTop;"vd"===t&&d>=n+a&&(o.scrollTop=o.scrollTop+r.clientHeight),"vu"===t&&s<n&&(o.scrollTop=o.scrollTop-r.clientHeight)}if("h"===t){var c=o.clientWidth,u=o.scrollLeft,f=r.cells[l],h=f.offsetLeft+f.clientWidth,p=f.offsetLeft;h>=c+parseInt(u,10)?o.scrollLeft=o.scrollLeft+f.clientWidth:p<u&&(o.scrollLeft=o.scrollLeft-f.clientWidth)}}function c(e,l){var t,i=0,r=a.colModel;if("lft"===l)for(i=e+1,t=e;t>=0;t--)if(!0!==r[t].hidden){i=t;break}if("rgt"===l)for(i=e-1,t=e;t<r.length;t++)if(!0!==r[t].hidden){i=t;break}return i}})},getChangedCells:function(t){var r=[];return t||(t="all"),this.each(function(){var a=this,n=a.p,o=l.htmlDecode,d=a.rows;a.grid&&!0===n.cellEdit&&e(d).each(function(l){var s={};if(e(this).hasClass("edited")){var c=this;e(this.cells).each(function(r){var u=n.colModel[r],f=u.name,h=i.call(a,c,r);if("cb"!==f&&"subgrid"!==f&&"rn"!==f&&("dirty"!==t||h.hasClass("dirty-cell")))try{s[f]=e.unformat.call(a,h[0],{rowId:d[l].id,colModel:u},r)}catch(e){s[f]=o(h.html())}}),s.id=this.id,r.push(s)}})}),r}})});
//# sourceMappingURL=grid.celledit.js.map