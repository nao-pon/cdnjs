!function(t,e){if("function"==typeof define&&define.amd)define("shopify-buy",["module"],e);else if("undefined"!=typeof exports)e(module);else{var n={exports:{}};e(n),t.ShopifyBuy=n.exports}}(this,function(t){"use strict";function e(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)}function n(t,e){function n(){var n=this.super;this.super=function(){return e.apply(this,arguments)};var r=t.apply(this,arguments);return this.super=n,r}return n.wrappedFunction=t,n}function r(t,e,r){var i=Object.getPrototypeOf(r);t.forEach(function(t){var o=Object.getOwnPropertyDescriptor(e,t),c=i.hasOwnProperty(t)&&Object.getOwnPropertyDescriptor(i,t);if("function"==typeof c.value&&"function"==typeof o.value){var s=n(o.value,c.value);Object.defineProperty(r,t,{value:s})}else Object.defineProperty(r,t,o)})}function i(t){var e=arguments.length<=1||void 0===arguments[1]?Object:arguments[1],i=n(t.constructor,e),o=Object.getOwnPropertyNames(t).filter(function(t){return!O(["constructor","static"],t)});m(i,e),i.prototype=Object.create(e.prototype),r(o,t,i.prototype),i.prototype.constructor=i;var c=t.static;if(c){var s=Object.getOwnPropertyNames(c);r(s,c,i)}return i}function o(t){var n=function(){var e=void 0;e=console[t]?Function.prototype.bind.call(console[t],console):Function.prototype.bind.call(console.log,console),e.apply(void 0,arguments)};return function(){var t=[].concat(Array.prototype.slice.call(arguments));t.unshift("[JS-BUY-SDK]: "),n.apply(void 0,e(t))}}function c(t){return t.reduce(function(t,e){return t.indexOf(e)<0&&t.push(e),t},[])}function s(t,e){var n=void 0;if(e.headers&&Object.keys(e.headers).forEach(function(t){"authorization"===t.toLowerCase()&&(n=e.headers[t])}),n){var r=n.split(" ").slice(-1)[0];try{var i=atob(r),o=void 0;return o=t.indexOf("?")>-1?t+"&_x_http_authorization="+i:t+"?_x_http_authorization="+i}catch(t){}}return t}function a(t,e,n){return new Promise(function(r,i){function o(){i(new Error("There was an error with the XDR"))}var c=new XDomainRequest;c.onload=function(){try{var t=JSON.parse(c.responseText);r({json:t,originalResponse:c,isJSON:!0})}catch(t){r({text:c.responseText,originalResponse:c,isText:!0})}},c.onerror=o,c.ontimeout=o,c.open(t,s(e,n)),c.send(n.data)})}function u(t){if(t.status>=200&&t.status<300)return t;var e=new Error(t.statusText);throw e.status=t.status,e.response=t,e}function l(t){return t.json().then(function(e){return{json:e,originalResponse:t,isJSON:!0}}).catch(function(){var e=t.clone();return e.text().then(function(t){return{text:t,originalResponse:e,isText:!0}})})}function f(t,e){var n=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],r=new XMLHttpRequest;return"withCredentials"in r?(n.method=t,n.mode="cors",fetch(e,n).then(u).then(l)):a.apply(void 0,arguments)}function h(){return++M}function p(t){if(t&&t[E])return t[E];if(void 0===t)return"(undefined)";if(null===t)return"(null)";var e="undefined"==typeof t?"undefined":y(t),n=void 0;switch(e){case"number":n=D[t],n||(n=D[t]="nu"+t);break;case"string":n=R[t],n||(n=R[t]="st"+h());break;case"boolean":n=t?"(true)":"(false)";break;default:if(t===Object){n="(Object)";break}if(t===Array){n="(Array)";break}n=K+"."+h(),null===t[E]?t[E]=n:(k.value=n,Object.defineProperty(t,E,k))}return n}function d(t,e){return t===e||Object.keys(t).every(function(n){return t[n]instanceof Date?t[n].toString()===e[n].toString():"object"===y(t[n])?d(t[n],e[n]):t[n]===e[n]})}function v(t,e){var n=void 0;switch(t){case"all":n=function(){return this.fetchAll(e)};break;case"one":n=function(){return this.fetch.apply(this,[e].concat(Array.prototype.slice.call(arguments)))};break;case"query":n=function(){return this.fetchQuery.apply(this,[e].concat(Array.prototype.slice.call(arguments)))}}return n}function b(){var t="undefined"==typeof window,e="function"==typeof require;return t&&e}var y="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol?"symbol":typeof t},g=void 0;g="function"==typeof Object.assign?Object.assign:function(t){if(void 0===t||null===t)throw new TypeError("Cannot convert undefined or null to object");var e=Object(t),n=[].slice.call(arguments,1);return n.length>0&&n.forEach(function(t){if(void 0!==t&&null!==t){var n=void 0;for(n in t)t.hasOwnProperty(n)&&(e[n]=t[n])}}),e};var m=g,j=void 0;j=Array.prototype.includes?function(t){var e=[].slice.call(arguments,1);return Array.prototype.includes.apply(t,e)}:function(t,e){var n=Object(t),r=parseInt(n.length,10)||0;if(0===r)return!1;var i=parseInt(arguments[1],10)||0,o=void 0;for(i>=0?o=i:(o=r+i,o<0&&(o=0));o<r;){var c=n[o];if(e===c||e!==e&&c!==c)return!0;o++}return!1};var O=j,w=i({constructor:function(){},static:{extend:function(t){return i(t,this)}}}),x=w.extend({constructor:function(){},debug:o("debug"),info:o("info"),warn:o("warn"),error:o("error")}),_=new x,S=w.extend({constructor:function(t){var e=this;Object.keys(this.deprecatedProperties).forEach(function(n){if(t.hasOwnProperty(n)){var r=e.deprecatedProperties[n],i=e[r];i(t[n],t)}}),this.requiredProperties.forEach(function(n){if(!t.hasOwnProperty(n))throw new Error("new Config() requires the option '"+n+"'");e[n]=t[n]})},deprecatedProperties:{myShopifyDomain:"transformMyShopifyDomain"},transformMyShopifyDomain:function(t,e){_.warn("Config - ","myShopifyDomain is deprecated, please use domain and provide the full shop domain."),e.domain=t+".myshopify.com"},requiredProperties:["apiKey","appId","domain"],apiKey:"",appId:"",domain:"",myShopifyDomain:""}),I=void 0,A=w.extend({constructor:function(){var t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],e=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];this.attrs=t,m(this,e)},attrs:null,serializer:null,adapter:null,shopClient:null}),z=A.extend({constructor:function(){this.super.apply(this,arguments),this.selected=this.values[0]},get name(){return this.attrs.name},get values(){return this.attrs.values},get selected(){return this._selected},set selected(t){if(!O(this.values,t))throw new Error("Invalid option selection for "+this.name+".");return this._selected=t,t}}),F=A.extend({constructor:function(){this.super.apply(this,arguments)},get id(){return this.attrs.variant.id},get productId(){return this.attrs.product.id},get title(){return this.attrs.variant.title},get productTitle(){return this.attrs.product.title},get compareAtPrice(){return this.attrs.variant.compare_at_price},get price(){return this.attrs.variant.price},get grams(){return this.attrs.variant.grams},get optionValues(){return this.attrs.variant.option_values},get available(){return this.attrs.variant.available},get image(){var t=this.id,e=this.attrs.product.images,n=e[0],r=e.filter(function(e){return e.variant_ids.indexOf(t)!==-1})[0];return r||n},get imageVariants(){var t=this.image;if(!t)return[];var e=this.image.src,n=e.lastIndexOf("."),r=e.slice(0,n),i=e.slice(n),o=[{name:"pico",dimension:"16x16"},{name:"icon",dimension:"32x32"},{name:"thumb",dimension:"50x50"},{name:"small",dimension:"100x100"},{name:"compact",dimension:"160x160"},{name:"medium",dimension:"240x240"},{name:"large",dimension:"480x480"},{name:"grande",dimension:"600x600"},{name:"1024x1024",dimension:"1024x1024"},{name:"2048x2048",dimension:"2048x2048"}];return o.forEach(function(t){t.src=r+"_"+t.name+i}),o},checkoutUrl:function(){var t=arguments.length<=0||void 0===arguments[0]?1:arguments[0],e=this.config,n="https://"+e.domain+"/cart",r=this.id+":"+parseInt(t,10),i="api_key="+e.apiKey;return n+"/"+r+"?"+i}}),T="https://widgets.shopifyapps.com/assets/no-image.svg",P=A.extend({constructor:function(){this.super.apply(this,arguments)},get id(){return this.attrs.product_id},get title(){return this.attrs.title},get description(){return this.attrs.body_html},get images(){return this.attrs.images},get memoized(){return this._memoized=this._memoized||{},this._memoized},get options(){if(this.memoized.options)return this.memoized.options;var t=this.attrs.options,e=this.variants;return this.memoized.options=t.map(function(t){var n=t.name,r=e.reduce(function(e,n){var r=n.optionValues.filter(function(e){return e.name===t.name})[0];return e.push(r.value),e},[]),i=c(r);return new z({name:n,values:i})}),this.memoized.options},get variants(){var t=this;return this.attrs.variants.map(function(e){return new F({variant:e,product:t},{config:t.config})})},get selections(){return this.options.map(function(t){return t.selected})},get selectedVariant(){var t=this.selections.join(" / ");return this.variants.filter(function(e){return e.title===t})[0]||null},get selectedVariantImage(){return this.selectedVariant?this.selectedVariant.image:null}}),C=w.extend({constructor:function(t){this.config=t},rootKeyForType:function(t){return t.slice(0,-1)+"_listing"},models:{collections:A,products:P},modelForType:function(t){return this.models[t]},deserializeSingle:function(t){var e=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],n=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],r=e[this.rootKeyForType(t)],i=this.modelFromAttrs(t,r,n);return i},deserializeMultiple:function(t){var e=this,n=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],r=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],i=n[this.rootKeyForType(t)+"s"];return i.map(function(n){var i=e.modelFromAttrs(t,n,r);return i})},modelFromAttrs:function(t,e,n){var r=this.modelForType(t);return n.config=this.config,new r(e,n)}}),q=w.extend({ajax:f,constructor:function(t){this.config=t},get base64ApiKey(){return btoa(this.config.apiKey)},get baseUrl(){var t=this.config,e=t.domain,n=t.appId;return"https://"+e+"/api/apps/"+n},get headers(){return{Authorization:"Basic "+this.base64ApiKey,"Content-Type":"application/json","X-SDK-Variant":"javascript","X-SDK-Version":I}},pathForType:function(t){return"/"+t.slice(0,-1)+"_listings"},buildUrl:function(t,e,n){switch(t){case"multiple":return this.buildMultipleUrl(e,n);case"single":return this.buildSingleUrl(e,n);default:return""}},buildMultipleUrl:function(t){var e=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],n=""+this.baseUrl+this.pathForType(t),r=Object.keys(e);if(r.length>0){var i=r.map(function(t){var n=void 0;return n=Array.isArray(e[t])?e[t].join(","):e[t],t+"="+encodeURIComponent(n)}).join("&");return n+"?"+i}return n},buildSingleUrl:function(t,e){return""+this.baseUrl+this.pathForType(t)+"/"+e},fetchMultiple:function(){var t=this.buildUrl.apply(this,["multiple"].concat(Array.prototype.slice.call(arguments)));return this.ajax("GET",t,{headers:this.headers}).then(function(t){return t.json})},fetchSingle:function(){var t=this.buildUrl.apply(this,["single"].concat(Array.prototype.slice.call(arguments)));return this.ajax("GET",t,{headers:this.headers}).then(function(t){return t.json})}}),E="shopify-buy-uuid",K="shopify-buy."+Date.now(),k={writable:!0,configurable:!0,enumerable:!0,value:null},M=0,D={},R={},U=A.extend({constructor:function(){this.super.apply(this,arguments)},get id(){return this.attrs[E]},get variant_id(){return this.attrs.variant_id},get product_id(){return this.attrs.product_id},get image(){return this.attrs.image},get title(){return this.attrs.title},get quantity(){return this.attrs.quantity},set quantity(t){var e=parseInt(t,10);if(e<0)throw new Error("Quantities must be positive");if(e!==parseFloat(t))throw new Error("Quantities must be whole numbers");return this.attrs.quantity=e,this.attrs.quantity},get properties(){return this.attrs.properties||{}},set properties(t){return this.attrs.properties=t||{},t},get variant_title(){return this.attrs.variant_title},get price(){return this.attrs.price},get compare_at_price(){return this.attrs.compare_at_price},get line_price(){return(this.quantity*parseFloat(this.price)).toFixed(2)},get grams(){return this.attrs.grams}}),N=void 0;N="undefined"==typeof global?window:global;var J=N,L=A.extend({constructor:function(){this.super.apply(this,arguments)},get id(){return this.attrs[E]},get lineItems(){return(this.attrs.line_items||[]).map(function(t){return new U(t)})},get lineItemCount(){return this.lineItems.reduce(function(t,e){return t+e.quantity},0)},get subtotal(){var t=this.lineItems.reduce(function(t,e){return t+parseFloat(e.line_price)},0);return t.toFixed(2)},get checkoutUrl(){var t=this.config,e="https://"+t.domain+"/cart",n=this.lineItems.map(function(t){return t.variant_id+":"+t.quantity}),r="api_key="+t.apiKey;if("function"==typeof J.ga){var i=void 0;J.ga(function(t){i=t.get("linkerParam")}),i&&(r+="&"+i)}return e+"/"+n+"?"+r},addVariants:function(){var t=[].concat(Array.prototype.slice.call(arguments)).map(function(t){var e={image:t.variant.image,variant_id:t.variant.id,product_id:t.variant.productId,title:t.variant.productTitle,quantity:parseInt(t.quantity,10),properties:t.properties||{},variant_title:t.variant.title,price:t.variant.price,compare_at_price:t.variant.compareAtPrice,grams:t.variant.grams};return p(e),e}),n=this.attrs.line_items;n.push.apply(n,e(t));var r=n.reduce(function(t,e){var n=t.filter(function(t){return t.variant_id===e.variant_id&&d(t.properties,e.properties)})[0];return n?n.quantity=n.quantity+e.quantity:t.push(e),t},[]);return this.attrs.line_items=r.reduce(function(t,e){return e.quantity>=1&&t.push(e),t},[]),this.updateModel()},updateLineItem:function(t,e){if(e<1)return this.removeLineItem(t);var n=this.lineItems.filter(function(e){return e.id===t})[0];return n?(n.quantity=e,this.updateModel()):new Promise(function(e,n){n(new Error("line item with id: "+t+" not found in cart#"+this.id))})},removeLineItem:function(t){var e=this.lineItems.length,n=this.lineItems.filter(function(e){return e.id!==t}),r=n.length;return r<e?(this.attrs.line_items=n.map(function(t){return t.attrs}),this.updateModel()):new Promise(function(e,n){n(new Error("line item with id: "+t+" not found in cart#"+this.id))})},clearLineItems:function(){return this.attrs.line_items=[],this.updateModel()},updateModel:function(){var t=this;return this.shopClient.update("carts",this).then(function(e){return m(t.attrs,e.attrs),t})}}),Q=w.extend({constructor:function(t){this.config=t},rootKeyForType:function(t){return t.slice(0,-1)},modelForType:function(){return L},deserializeSingle:function(t){var e=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],n=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],r=e[this.rootKeyForType(t)],i=this.modelFromAttrs(t,r,n);return i},modelFromAttrs:function(t,e,n){var r=this.modelForType(t);return n.config=this.config,new r(e,n)},serialize:function(t,e){var n=this.rootKeyForType(t),r={},i=m({},e.attrs);return r[n]=i,delete i.attributes,Object.keys(i).forEach(function(t){var e=i[t];(null===e||"string"==typeof e&&0===e.length)&&delete i[t]}),r}}),V=A.extend({constructor:function(t){if(Object.keys(t).indexOf("referenceId")<0)throw new Error("Missing key referenceId of reference. References to null are not allowed");this.super.apply(this,arguments)},get id(){return this.attrs[E]},get referenceId(){return this.attrs.referenceId},set referenceId(t){return this.attrs.referenceId=t,t}}),X=w.extend({constructor:function(t){this.config=t},modelForType:function(){return V},deserializeSingle:function(t){var e=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],n=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],r=this.modelForType(t);return new r(e,n)},serialize:function(t,e){var n=m({},e.attrs);return n}}),B=w.extend({constructor:function(){this.localStorageAvailable=this.storageAvailable("localStorage"),this.cache={}},setItem:function(t,e){return this.localStorageAvailable?localStorage.setItem(t,JSON.stringify(e)):this.cache[t]=e,e},getItem:function(t){if(!this.localStorageAvailable)return this.cache[t]||null;var e=localStorage.getItem(t);try{return JSON.parse(e)}catch(t){return null}},storageAvailable:function(t){try{var e=J[t],n="__storage_test__";return e.setItem(n,n),e.removeItem(n),!0}catch(t){return!1}}}),G=w.extend({constructor:function(){this.store=new B},idKeyForType:function(){return E},fetchSingle:function(t,e){var n=this;return new Promise(function(r,i){var o=n.store.getItem(n.storageKey(t,e));return null===o?void i(new Error(t+"#"+e+" not found")):void r(o)})},create:function(t,e){var n=this;return new Promise(function(r){var i=n.identify(e);n.store.setItem(n.storageKey(t,i),e),r(e)})},update:function(t,e,n){var r=this;return new Promise(function(i){r.store.setItem(r.storageKey(t,e),n),i(n)})},storageKey:function(t,e){return t+"."+e},identify:function(t){var e=Object.keys(t);return p(1===e.length&&"object"===y(t[e[0]])?t[e[0]]:t)}}),H=w.extend({constructor:function(t){this.config=t,this.serializers={products:C,collections:C,carts:Q,references:X},this.adapters={products:q,collections:q,carts:G,references:G}},config:null,get serializers(){return m({},this.shadowedSerializers)},set serializers(t){this.shadowedSerializers=m({},t)},get adapters(){return m({},this.shadowedAdapters)},set adapters(t){this.shadowedAdapters=m({},t)},fetchAll:function(t){var e=this,n=new this.adapters[t](this.config);return n.fetchMultiple(t).then(function(r){return e.deserialize(t,r,n,null,{multiple:!0})})},fetch:function(t,e){var n=this,r=new this.adapters[t](this.config);return r.fetchSingle(t,e).then(function(e){return n.deserialize(t,e,r,null,{single:!0})})},fetchQuery:function(t,e){var n=this,r=new this.adapters[t](this.config);return r.fetchMultiple(t,e).then(function(e){return n.deserialize(t,e,r,null,{multiple:!0})})},create:function(t){var e=this,n=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],r=new this.adapters[t](this.config),i=new this.serializers[t](this.config),o=i.modelForType(t),c=new o(n,{shopClient:this}),s=i.serialize(t,c);return r.create(t,s).then(function(n){return e.deserialize(t,n,r,i,{single:!0})})},update:function(t,e){var n=this,r=e.adapter,i=e.serializer,o=i.serialize(t,e),c=e.attrs[r.idKeyForType(t)];return r.update(t,c,o).then(function(e){return n.deserialize(t,e,r,i,{single:!0})})},deserialize:function(t,e,n,r){var i=arguments.length<=4||void 0===arguments[4]?{}:arguments[4],o=r||new this.serializers[t](this.config),c={shopClient:this,adapter:n,serializer:o,type:t},s=void 0;return s=i.multiple?o.deserializeMultiple(t,e,c):o.deserializeSingle(t,e,c)},createCart:function(){var t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],e={line_items:[]},n={};return m(n,e),m(n,t),this.create("carts",n)},updateCart:function(t){return this.update("carts",t)},fetchCart:v("one","carts"),fetchAllProducts:v("all","products"),fetchAllCollections:v("all","collections"),fetchProduct:v("one","products"),fetchCollection:v("one","collections"),fetchQueryProducts:v("query","products"),fetchQueryCollections:v("query","collections"),fetchRecentCart:function(){var t=this;return this.fetch("references",this.config.domain+".recent-cart").then(function(e){var n=e.referenceId;return t.fetchCart(n)}).catch(function(){return t.createCart().then(function(e){var n={referenceId:e.id};return n[E]=t.config.domain+".recent-cart",t.create("references",n),e})})}}),Y=J.fetch;if(!Y&&b()){var W=require;J.fetch=W("node-fetch"),J.Response=J.fetch.Response}var Z=J.btoa;!Z&&b()&&(J.btoa=function(t){return new Buffer(t).toString("base64")});var $={ShopClient:H,Config:S,version:I,NO_IMAGE_URI:T,buildClient:function(){var t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],e=new this.Config(t);return new this.ShopClient(e)}};t.exports=$});