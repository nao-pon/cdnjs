"use strict";angular.module("gridster",[]).controller("GridsterCtrl",function(){return{grid:[],$preview:null,$element:null,opts:null,columns:5,colWidth:null,rowHeight:null,gridHeight:2,margins:[10,10],isMobile:!1,init:function(a,b,c){this.opts=c,this.$element=a,this.$preview=b,this.redraw()},setMargins:function(a){this.margins=a},setColumns:function(a){this.columns=a},getColumns:function(){return this.columns},setColWidth:function(a){this.colWidth="auto"===a?(this.$element.width()-this.margins[1])/this.columns:a},setRowHeight:function(a){this.rowHeight="match"===a?this.colWidth:a},getRowHeight:function(){return this.rowHeight},destroy:function(){this.grid&&(this.grid.length=0),this.opts=this.margins=this.grid=this.$element=this.$preview=null},redraw:function(){this.opts.margins&&(this.margins=this.opts.margins),this.opts.columns&&this.setColumns(this.opts.columns),this.opts.colWidth&&this.setColWidth(this.opts.colWidth),this.opts.rowHeight&&this.setRowHeight(this.opts.rowHeight),this.isMobile=$(window).width()<=this.opts.mobileBreakPoint;for(var a=0,b=this.grid.length;b>a;++a){var c=this.grid[a];if(c)for(var d=0,e=c.length;e>d;++d)if(c[d]){var f=c[d],g=f.$element;this.setElementPosition(g,f.row,f.column),this.setElementHeight(g,f.height),this.setElementWidth(g,f.width)}}},canItemOccupy:function(a,b,c){return b>-1&&c>-1&&a.width+c<=this.columns},autoSetItemPosition:function(a){for(var b=0;100>b;++b)for(var c=0;c<this.columns;++c){var d=this.getItem(b,c),e=this.canItemOccupy(a,b,c);if(!d&&e)return this.putItem(a,b,c),void 0}throw new Error("Unable to place item!")},getItems:function(a,b,c,d,e){var f=[];c&&d||(c=d=1),!e||e instanceof Array||(e=[e]);for(var g=0;d>g;++g)for(var h=0;c>h;++h){var i=this.getItem(a+g,b+h,e);!i||e&&-1!==e.indexOf(i)||-1!==f.indexOf(i)||f.push(i)}return f},removeItem:function(a){for(var b=0,c=this.grid.length;c>b;++b){var d=this.grid[b];if(d){var e=d.indexOf(a);if(-1!==e){d[e]=null;break}}}this.floatItemsUp(),updateHeight()},getItem:function(a,b,c){!c||c instanceof Array||(c=[c]);for(var d=1;a>-1;){for(var e=1,f=b;f>-1;){if(this.grid[a]){var g=this.grid[a][f];if(g&&(!c||-1===c.indexOf(g))&&g.width>=e&&g.height>=d)return this.grid[a][f]}++e,--f}--a,++d}return null},putItems:function(a){for(var b=0,c=a.length;c>b;++b)this.putItem(a[b])},putItem:function(a,b,c){if(("undefined"==typeof b||null===b)&&(b=a.row,c=a.column,"undefined"==typeof b||null===b))return this.autoSetItemPosition(a),void 0;if(this.canItemOccupy(a,b,c)||(c=Math.min(this.columns-a.width,Math.max(0,c)),b=Math.max(0,b)),a&&null!==a.oldRow&&"undefined"!=typeof a.oldRow){if(a.oldRow===b&&a.oldColumn===c)return a.row=b,a.column=c,void 0;var d=this.grid[a.oldRow];d&&d[a.oldColumn]===a&&(d[a.oldColumn]=null)}a.oldRow=a.row=b,a.oldColumn=a.column=c,this.moveOverlappingItems(a),this.grid[b]||(this.grid[b]=[]),this.grid[b][c]=a},moveOverlappingItems:function(a){var b=this.getItems(a.row,a.column,a.width,a.height,a);this.moveItemsDown(b,a.row+a.height)},moveItemsDown:function(a,b){if(a&&0!==a.length){var c,d,e,f={};for(d=0,e=a.length;e>d;++d){c=a[d];var g=f[c.column];("undefined"==typeof g||c.row<g)&&(f[c.column]=c.row)}for(d=0,e=a.length;e>d;++d){c=a[d];var h=b-f[c.column];this.putItem(c,c.row+h,c.column)}}},floatItemsUp:function(){for(var a=0,b=this.grid.length;b>a;++a){var c=this.grid[a];if(c)for(var d=0,e=c.length;e>d;++d)c[d]&&this.floatItemUp(c[d])}},floatItemUp:function(a){for(var b=a.column,c=a.height,d=a.width,e=null,f=null,g=a.row-1;g>-1;){var h=this.getItems(g,b,d,c,a);if(0!==h.length)break;e=g,f=b,--g}null!==e&&this.putItem(a,e,f)},updateHeight:function(a){var b=this.opts.minRows;a||(a=0);for(var c=this.grid.length;c>=0;--c){var d=this.grid[c];if(d)for(var e=0,f=d.length;f>e;++e)d[e]&&(b=Math.max(b,c+a+d[e].height))}this.gridHeight=Math.min(this.opts.maxRows,b)},pixelsToRows:function(a,b){return b===!0?Math.ceil(a/this.rowHeight):b===!1?Math.floor(a/this.rowHeight):Math.round(a/this.rowHeight)},pixelsToColumns:function(a,b){return b===!0?Math.ceil(a/this.colWidth):b===!1?Math.floor(a/this.colWidth):Math.round(a/this.colWidth)},setElementPosition:function(a,b,c){a.removeClass("ui-draggable-dragging"),this.isMobile?a.css({margin:this.margins[0]+"px",top:"auto",left:"auto"}):a.css({margin:0,top:b*this.rowHeight+this.margins[0],left:c*this.colWidth+this.margins[1]})},setElementHeight:function(a,b){a.removeClass("ui-resizable-resizing"),this.isMobile?a.css("height","auto"):a.css("height",b*this.rowHeight-this.margins[0]+"px")},setElementWidth:function(a,b){a.removeClass("ui-resizable-resizing"),this.isMobile?a.css("width","auto"):a.css("width",b*this.colWidth-this.margins[1]+"px")}}}).directive("gridster",["$parse","$timeout",function(a,b){return{restrict:"EAC",controller:"GridsterCtrl",link:function(c,d,e,f){var g=e.gridster,h={colWidth:"auto",rowHeight:"match",columns:6,margins:[10,10],defaultHeight:1,defaultWidth:2,minRows:2,maxRows:100,mobileBreakPoint:600},i=a(g);g&&(h=$.extend(!0,h,i(c))),d.addClass("gridster"),d.removeClass("gridster-loaded");var j=$('<div class="gridster-item gridster-preview-holder"></div>').appendTo(d);c.$watch(function(){return f.gridHeight},function(a){f.$element.css("height",a*f.rowHeight+f.margins[0]+"px")}),c.$watch(function(){return f.isMobile},function(a){a?f.$element.addClass("gridster-mobile"):f.$element.removeClass("gridster-mobile")});var k=$(window).width();$(window).on("resize",function(){var a=$(window).width();a===k||d.find(".ui-draggable-dragging, .ui-resizable-resizing").length>0||(d.removeClass("gridster-loaded"),f.redraw(),d.addClass("gridster-loaded"),c.$apply())}),d.bind("$destroy",function(){try{this.$preview.remove(),f.destroy()}catch(a){}}),f.init(d,j,h),b(function(){f.floatItemsUp(),d.addClass("gridster-loaded")},0)}}}]).controller("GridsterItemCtrl",function(){return{$element:null,gridster:null,dragging:!1,resizing:!1,row:null,column:null,width:null,height:null,init:function(a,b){this.$element=a,this.gridster=b,this.width=b.opts.defaultWidth,this.height=b.opts.defaultHeight},destroy:function(){this.gridster=null,this.$element=null},toJSON:function(){return{row:this.row,column:this.column,height:this.height,width:this.width}},setPosition:function(a,b){this.gridster.putItem(this,a,b),this.gridster.floatItemsUp(),this.gridster.updateHeight(this.dragging?this.height:0),this.dragging?this.gridster.setElementPosition(this.gridster.$preview,this.row,this.column):this.gridster.setElementPosition(this.$element,this.row,this.column)},setDimension:function(a,b){var c=a.toLowerCase(),d=c.charAt(0).toUpperCase(),e=d+c.substr(1);if(""!==b){b||(b=this.gridster.opts["default"+e]),b=parseInt(b,10);var f=!(this[c]===b&&this["old"+e]&&this["old"+e]===b);this["old"+e]=this[c]=b,this.resizing?(this.gridster.setElementPosition(this.gridster.$preview,this.row,this.column),this.gridster["setElement"+e](this.gridster.$preview,b)):this.gridster["setElement"+e](this.$element,b),f&&(this.gridster.moveOverlappingItems(this),this.gridster.floatItemsUp(),this.gridster.updateHeight(this.dragging?this.height:0))}},setHeight:function(a){this.setDimension("height",a)},setWidth:function(a){this.setDimension("width",a)}}}).directive("gridsterItem",["$parse","$controller",function(a,b){return{restrict:"EAC",require:"^gridster",link:function(c,d,e,f){var g=e.gridsterItem,h={},i=b("GridsterItemCtrl");g&&(h=a(g)(c)),i.init(d,f,h),d.addClass("gridster-item"),d.draggable({handle:f.opts.draggable&&f.opts.draggable.handle?f.opts.draggable.handle:null,refreshPositions:!0,start:function(){i.dragging=!0,f.$preview.show(),f.setElementWidth(f.$preview,i.width),f.setElementHeight(f.$preview,i.height),f.setElementPosition(f.$preview,i.row,i.column),f.updateHeight(i.height),c.$apply()},drag:function(a,b){i.row=f.pixelsToRows(b.position.top),i.column=f.pixelsToColumns(b.position.left),c.$apply()},stop:function(a,b){i.row=f.pixelsToRows(b.position.top),i.column=f.pixelsToColumns(b.position.left),i.dragging=!1,f.$preview.hide(),i.setPosition(i.row,i.column),f.updateHeight(),c.$apply()}}),d.resizable({handles:"n, e, s, w, ne, se, sw, nw",minHeight:f.rowHeight,minWidth:f.colWidth,start:function(){i.resizing=!0,i.dragging=!0,f.$preview.fadeIn(300),f.setElementWidth(f.$preview,i.width),f.setElementHeight(f.$preview,i.height),c.$apply()},resize:function(a,b){i.row=f.pixelsToRows(b.position.top,!1),i.column=f.pixelsToColumns(b.position.left,!1),i.width=f.pixelsToColumns(b.size.width,!0),i.height=f.pixelsToRows(b.size.height,!0),c.$apply(),f.opts.resize&&f.opts.resize.resize&&(f.opts.resize.resize(a,b,d),c.$apply())},stop:function(a,b){i.row=f.pixelsToRows(b.position.top,!1),i.column=f.pixelsToColumns(b.position.left,!1),i.width=f.pixelsToColumns(b.size.width,!0),i.height=f.pixelsToRows(b.size.height,!0),i.resizing=!1,i.dragging=!1,f.$preview.fadeOut(300),i.setPosition(i.row,i.column),i.setHeight(i.height),i.setWidth(i.width),c.$apply(),f.opts.resize&&f.opts.resize.stop&&(f.opts.resize.stop(a,b,d),c.$apply())}});var j,k,l,m;return h.width&&(j=a(h.width),c.$watch(h.width,function(a){i.width=a}),i.width=j(c)),h.height&&(k=a(h.height),c.$watch(h.height,function(a){i.height=a}),i.height=k(c)),h.row&&(l=a(h.row),c.$watch(h.row,function(a){i.row=a}),i.row=l(c)),h.column&&(m=a(h.column),c.$watch(h.column,function(a){i.column=a}),i.column=m(c)),c.$watch(function(){return i.row},function(){i.setPosition(i.row,i.column),l&&l.assign(c,i.row),m&&m.assign(c,i.column)}),c.$watch(function(){return i.column},function(){i.setPosition(i.row,i.column),l&&l.assign(c,i.row),m&&m.assign(c,i.column)}),c.$watch(function(){return i.height},function(a){i.setHeight(a),k&&k.assign(c,i.height)}),c.$watch(function(){return i.width},function(a){i.setWidth(a),j&&j.assign(c,i.width)}),d.bind("$destroy",function(){try{f.removeItem(i)}catch(a){}try{i.destroy()}catch(a){}try{d.draggable("destroy")}catch(a){}try{d.resizable("destroy")}catch(a){}})}}}]);