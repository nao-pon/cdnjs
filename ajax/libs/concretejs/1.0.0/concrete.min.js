/*
 * Concrete v1.0.0
 * A lightweight Html5 Canvas framework that enables hit detection, layer support, 
 * pixel ratio management, exports, and downloads
 * Release Date: 2-4-2017
 * https://github.com/ericdrowell/concrete
 * Licensed under the MIT or GPL Version 2 licenses.
 *
 * Copyright (C) 2017 Eric Rowell @ericdrowell
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */
!function(){var t={},i=0;t.pixelRatio=function(){return window&&window.navigator&&window.navigator.userAgent&&!/PhantomJS/.test(window.navigator.userAgent)?2:1}(),t.viewports=[],t.Viewport=function(e){e||(e={}),this.width=0,this.height=0,this.layers=[],this.id=i++,this.container=document.createElement("div"),this.container.className="concrete-container",this.container.style.display="inline-block",this.container.style.position="relative",e.width&&e.height&&this.setSize(e.width,e.height),e.container.innerHTML="",e.container.appendChild(this.container),t.viewports.push(this)},t.Viewport.prototype={add:function(t){return this.layers.push(t),t.setSize(t.width||this.width,t.height||this.height),t.viewport=this,this.container.appendChild(t.container),this},setSize:function(t,i){return this.width=t,this.height=i,this.container.style.width=this.width+"px",this.container.style.height=this.height+"px",this},getIntersection:function(t,i){var e,n,s,h=this.layers,o=h.length;for(e=o-1;e>=0;e--)if(n=h[e],s=n.hit.getIntersection(t,i),null!==s)return s;return null},toScene:function(i){i||(i={});var e=new t.Scene({pixelRatio:i.pixelRatio,width:this.width,height:this.height});return this.layers.forEach(function(t){e.context.drawImage(t.scene.canvas,0,0,t.width,t.height)}),e},getIndex:function(){var i,e=t.viewports,n=e.length,s=0;for(s=0;n>s;s++)if(i=e[s],this.id===i.id)return s;return null},destroy:function(){this.layers.forEach(function(t){t.destroy()}),t.viewports.splice(this.getIndex(),1)}},t.Layer=function(e){e||(e={}),this.x=0,this.y=0,this.width=0,this.height=0,this.id=i++,this.hit=new t.Hit,this.scene=new t.Scene,this.container=document.createElement("div"),this.container.className="concrete-layer",this.container.style.display="inline-block",this.container.style.position="absolute",this.container.appendChild(this.hit.canvas),this.container.appendChild(this.scene.canvas),e.x&&e.y&&this.setPosition(e.x,e.y),e.width&&e.height&&this.setSize(e.width,e.height)},t.Layer.prototype={setPosition:function(t,i){return this.x=t,this.container.style.left=t+"px",this.y=i,this.container.style.top=i+"px",this},setSize:function(t,i){return this.width=t,this.container.style.width=t+"px",this.height=i,this.container.style.height=i+"px",this.scene.setSize(t,i),this.hit.setSize(t,i),this},moveUp:function(){var t=this.getIndex(),i=this.viewport,e=i.layers;return t<e.length-1&&(e[t]=e[t+1],e[t+1]=this,i.container.insertBefore(this.container,i.container.children[t+2])),this},moveDown:function(){var t=this.getIndex(),i=this.viewport,e=i.layers;return t>0&&(e[t]=e[t-1],e[t-1]=this,i.container.insertBefore(this.container,i.container.children[t-1])),this},moveToTop:function(){var t=this.getIndex(),i=this.viewport,e=i.layers;e.splice(t,1),e.push(this),i.container.appendChild(this.container)},moveToBottom:function(){var t=this.getIndex(),i=this.viewport,e=i.layers;return e.splice(t,1),e.unshift(this),i.container.insertBefore(this.container,i.container.firstChild),this},getIndex:function(){var t,i=this.viewport.layers,e=i.length,n=0;for(n=0;e>n;n++)if(t=i[n],this.id===t.id)return n;return null},destroy:function(){this.viewport.layers.splice(this.getIndex(),1),this.viewport.container.removeChild(this.container)}},t.Scene=function(e){e||(e={}),this.width=0,this.height=0,this.pixelRatio=e.pixelRatio||t.pixelRatio,this.id=i++,this.canvas=document.createElement("canvas"),this.canvas.className="concrete-scene-canvas",this.canvas.style.display="inline-block",this.canvas.style.position="absolute",this.context=this.canvas.getContext("2d"),e.width&&e.height&&this.setSize(e.width,e.height)},t.Scene.prototype={setSize:function(t,e){return this.width=t,this.height=e,this.id=i++,this.canvas.width=t*this.pixelRatio,this.canvas.style.width=t+"px",this.canvas.height=e*this.pixelRatio,this.canvas.style.height=e+"px",1!==this.pixelRatio&&this.context.scale(this.pixelRatio,this.pixelRatio),this},clear:function(){return this.context.clearRect(0,0,this.width*this.pixelRatio,this.height*this.pixelRatio),this},toImage:function(t){var i=this,e=new Image,n=this.canvas.toDataURL("image/png");e.onload=function(){e.width=i.width,e.height=i.height,t(e)},e.src=n},download:function(t){var i,e,n=this.canvas.toDataURL("image/png"),s=document.createElement("a");t||(t={}),i=t.fileName||"canvas.png",n=n.replace(/^data:image\/[^;]*/,"data:application/octet-stream"),s.setAttribute("href",n),s.setAttribute("target","_blank"),s.setAttribute("download",i),document.createEvent?(e=document.createEvent("MouseEvents"),e.initEvent("click",!0,!0),s.dispatchEvent(e)):s.click&&s.click()}},t.Hit=function(t){t||(t={}),this.width=0,this.height=0,this.canvas=document.createElement("canvas"),this.canvas.className="concrete-hit-canvas",this.canvas.style.display="none",this.canvas.style.position="relative",this.context=this.canvas.getContext("2d"),this.hitColorIndex=0,this.keyToColor={},this.colorToKey={},t.width&&t.height&&this.setSize(t.width,t.height)},t.Hit.prototype={setSize:function(t,i){return this.width=t,this.height=i,this.canvas.width=t,this.canvas.style.width=t+"px",this.canvas.height=i,this.canvas.style.height=i+"px",this},clear:function(){return this.context.clearRect(0,0,this.width,this.height),this},getIntersection:function(t,i){var e,n,s,h,o,a,r;return e=this.context.getImageData(Math.round(t),Math.round(i),1,1).data,n=e[0],h=e[1],s=e[2],o=e[3],a=this.rgbToInt(n,h,s),r=this.colorToKey[a],void 0!==r&&255===o?r:null},registerKey:function(t){var i;return this.keyToColor[t]||(i=this.hitColorIndex++,this.colorToKey[i]=t,this.keyToColor[t]=i),this},rgbToInt:function(t,i,e){return(t<<16)+(i<<8)+e},getColorFromKey:function(t){var i;for(this.registerKey(t),i=this.keyToColor[t].toString(16);i.length<6;)i="0"+i;return"#"+i}},window.Concrete=t}();