/*!
 * vuefire v2.0.0-alpha.4
 * (c) 2017 Eduardo San Martin Morote
 * Released under the MIT License.
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.Vuefire={})}(this,function(e){"use strict";function t(e){return Object.defineProperty(e.data(),"id",{value:e.id})}function n(e,t,r,i){void 0===r&&(r=""),void 0===i&&(i=[{},{}]),t=t||{};var o=Object.getOwnPropertyDescriptor(e,"id");return o&&!o.enumerable&&Object.defineProperty(i[0],"id",o),Object.keys(e).reduce(function(i,o){var s=e[o];"function"==typeof s.isEqual?(i[0][o]=t[o]||s.path,i[1][r+o]=s):Array.isArray(s)?(i[0][o]=Array(s.length).fill(null),n(s,t[o]||{},r+o+".",[i[0][o],i[1]])):(f=s)&&"object"==typeof f?(i[0][o]={},n(s,t[o]||{},r+o+".",[i[0][o],i[1]])):i[0][o]=s;var f;return i},i)}function r(e,t,n){var r=(""+t).split("."),i=r.pop(),o=r.reduce(function(e,t){return e[t]},e);isFinite(i)?o.splice(i,1,n):o[i]=n}function i(e){for(var t in e)e[t].unsub()}function o(e){var n=e.subs,o=e.refs,f=e.target,u=e.path,c=(e.data,e.depth),a=e.resolve,d=Object.keys(o);if(Object.keys(n).filter(function(e){return d.indexOf(e)<0}).forEach(function(e){n[e].unsub(),delete n[e]}),!d.length)return a();if(++c>3)throw new Error("more than 5 nested refs");d.forEach(function(e){var d=n[e],l=o[e];if(d){if(d.path===l.path)return;d.unsub()}n[e]={unsub:function(e){var n=e.ref,o=e.target,f=e.path,u=e.depth,c=e.resolve,a=Object.create(null),d=n.onSnapshot(function(e){e.exists?s({snapshot:t(e),target:o,path:f,subs:a,depth:u,resolve:c}):(r(o,f,null),c())});return function(){d(),i(a)}}({ref:l,target:f,path:u+"."+e,depth:c,resolve:a}),path:l.path}})}function s(e){var t=e.snapshot,i=e.target,s=e.path,f=e.subs,u=e.depth;void 0===u&&(u=0);var c,a,d=e.resolve,l=n(t,(c=i,a=s,a.split(".").reduce(function(e,t){return e[t]},c))),p=l[0],h=l[1];r(i,s,p),o({data:p,subs:f,refs:h,target:i,path:s,depth:u,resolve:d})}function f(e){var r=e.vm,f=e.key,u=e.ref;return new Promise(function(e,c){var a;a=u.where?function(e){var r,s=e.vm,f=e.key,u=e.collection,c=e.resolve,a=e.reject,d=s[f]=[],l=c,p=[],h={added:function(e){var r=e.newIndex,i=e.doc;p.splice(r,0,Object.create(null));var s=p[r],f=n(t(i)),u=f[0],a=f[1];d.splice(r,0,u),o({data:u,refs:a,subs:s,target:d,path:r,depth:0,resolve:c.bind(null,i)})},modified:function(e){var r=e.oldIndex,i=e.newIndex,s=e.doc,f=p.splice(r,1)[0];p.splice(i,0,f);var u=d.splice(r,1)[0],a=n(t(s),u),l=a[0],h=a[1];d.splice(i,0,l),o({data:l,refs:h,subs:f,target:d,path:i,depth:0,resolve:c})},removed:function(e){var t=e.oldIndex;d.splice(t,1),i(p.splice(t,1)[0])}},v=u.onSnapshot(function(e){var t=e.docChanges;if(!r&&t.length){r=!0;var n=0,i=t.length,o=t.reduce(function(e,t){return e[t.doc.id]=!1,e},Object.create(null));c=function(e){e.id in o&&++n>=i&&(l(s[f]),c=function(e){})}}t.forEach(function(e){h[e.type](e)}),t.length||c()},a);return function(){v(),p.forEach(i)}}({vm:r,key:f,collection:u,resolve:e,reject:c}):function(e){var n=e.vm,r=e.key,o=e.document,f=e.resolve,u=e.reject,c=Object.create(null);f=function(e,t){var n;return function(){if(!n)return n=!0,e(t())}}(f,function(){return n[r]});var a=o.onSnapshot(function(e){e.exists?s({snapshot:t(e),target:n,path:r,subs:c,resolve:f}):f()},u);return function(){a(),i(c)}}({vm:r,key:f,document:u,resolve:e,reject:c}),r._firestoreUnbinds[f]=a})}e.default=function(e,t){var n=e.config.optionMergeStrategies;n.firestore=n.provide,e.mixin({created:function(){var e=this,t=this.$options.firestore;this._firestoreUnbinds=Object.create(null),this.$firestoreRefs=Object.create(null);var n="function"==typeof t?t.call(this):t;n&&Object.keys(n).forEach(function(t){e.$bind(t,n[t])})},beforeDestroy:function(){for(var e in this._firestoreUnbinds)this._firestoreUnbinds[e]();this._firestoreUnbinds=null,this.$firestoreRefs=null}}),e.prototype.$bind=function(e,t){this._firestoreUnbinds[e]&&this.$unbind(e);var n=f({vm:this,key:e,ref:t});return this.$firestoreRefs[e]=t,n},e.prototype.$unbind=function(e){this._firestoreUnbinds[e](),delete this._firestoreUnbinds[e],delete this.$firestoreRefs[e]}},Object.defineProperty(e,"__esModule",{value:!0})});