/*!
 * vuefire v2.0.0-alpha.9
 * (c) 2018 Eduardo San Martin Morote
 * Released under the MIT License.
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.Vuefire=t()}(this,function(){"use strict";function k(e){return Object.defineProperty(e.data(),"id",{value:e.id})}function m(i,o,s,e){void 0===s&&(s=""),void 0===e&&(e=[{},{}]),o=o||{};var t=Object.getOwnPropertyDescriptor(i,"id");return t&&!t.enumerable&&Object.defineProperty(e[0],"id",t),Object.keys(i).reduce(function(e,t){var n,r=i[t];return r&&"function"==typeof r.isEqual?(e[0][t]=o[t]||r.path,e[1][s+t]=r):Array.isArray(r)?(e[0][t]=Array(r.length).fill(null),m(r,o[t],s+t+".",[e[0][t],e[1]])):r instanceof Date||null==r||r.longitude&&r.latitude?e[0][t]=r:(n=r)&&"object"==typeof n?(e[0][t]={},m(r,o[t],s+t+".",[e[0][t],e[1]])):e[0][t]=r,e},e)}function $(e,t,n){var r=(""+t).split("."),i=r.pop(),o=r.reduce(function(e,t){return e[t]},e);isFinite(i)?o.splice(i,1,n):o[i]=n}function U(e){for(var t in e)e[t].unsub()}function O(e,p){var h=e.subs,v=e.refs,b=e.target,y=e.path,g=(e.data,e.depth),j=e.resolve,t=Object.keys(v);if(Object.keys(h).filter(function(e){return t.indexOf(e)<0}).forEach(function(e){h[e].unsub(),delete h[e]}),!t.length||++g>p.maxRefDepth)return j(y);var m=0,O=t.length,x=Object.create(null);t.forEach(function(e){var t,n,r,i,o,s,u,c,f,a=h[e],l=v[e],d=y+"."+e;if(x[d]=!0,a){if(a.path===l.path)return;a.unsub()}h[e]={unsub:(t={ref:l,target:b,path:d,depth:g,resolve:function(e){e in x&&++m>=O&&j(y)}.bind(null,d)},n=p,r=t.ref,i=t.target,o=t.path,s=t.depth,u=t.resolve,c=Object.create(null),f=r.onSnapshot(function(e){e.exists?_({snapshot:k(e),target:i,path:o,subs:c,depth:s,resolve:u},n):($(i,o,null),u(o))}),function(){f(),U(c)}),path:l.path}})}function _(e,t){var n=e.snapshot,r=e.target,i=e.path,o=e.subs,s=e.depth;void 0===s&&(s=0);var u,c=e.resolve,f=m(n,(u=r,i.split(".").reduce(function(e,t){return e[t]},u))),a=f[0],l=f[1];$(r,i,a),O({data:a,subs:o,refs:l,target:r,path:i,depth:s,resolve:c},t)}function i(e,b){var y=e.vm,g=e.key,j=e.ref;return void 0===b&&(b={maxRefDepth:2}),new Promise(function(e,t){var n,r,f,o,s,u,i,a,c,l,d,p,h,v;j.where?(f=b,s=(r={vm:y,key:g,collection:j,resolve:e,reject:t}).vm,u=r.key,i=r.collection,a=r.resolve,c=r.reject,l=s[u]=[],d=a,p=[],h={added:function(e){var t=e.newIndex,n=e.doc;p.splice(t,0,Object.create(null));var r=p[t],i=m(k(n)),o=i[0],s=i[1];l.splice(t,0,o),O({data:o,refs:s,subs:r,target:l,path:t,depth:0,resolve:a.bind(null,n)},f)},modified:function(e){var t=e.oldIndex,n=e.newIndex,r=e.doc,i=p.splice(t,1)[0];p.splice(n,0,i);var o=l.splice(t,1)[0],s=m(k(r),o),u=s[0],c=s[1];l.splice(n,0,u),O({data:u,refs:c,subs:i,target:l,path:n,depth:0,resolve:a},f)},removed:function(e){var t=e.oldIndex;l.splice(t,1),U(p.splice(t,1)[0])}},v=i.onSnapshot(function(e){var t=e.docChanges;if(!o&&t.length){o=!0;var n=0,r=t.length,i=t.reduce(function(e,t){return e[t.doc.id]=!1,e},Object.create(null));a=function(e){e.id in i&&++n>=r&&(d(s[u]),a=function(e){})}}t.forEach(function(e){h[e.type](e)}),t.length||a()},c),n=function(){v(),p.forEach(U)}):n=function(e,t){var n,r,i,o=e.vm,s=e.key,u=e.document,c=e.resolve,f=e.reject,a=Object.create(null);n=c,r=function(){return o[s]},c=function(){if(!i)return i=!0,n(r())};var l=u.onSnapshot(function(e){e.exists?_({snapshot:k(e),target:o,path:s,subs:a,resolve:c},t):c()},f);return function(){l(),U(a)}}({vm:y,key:g,document:j,resolve:e,reject:t},b),y._firestoreUnbinds[g]=n})}return function(e){var t=e.config.optionMergeStrategies;t.firestore=t.provide,e.mixin({created:function(){var t=this,e=this.$options.firestore;this._firestoreUnbinds=Object.create(null),this.$firestoreRefs=Object.create(null);var n="function"==typeof e?e.call(this):e;n&&Object.keys(n).forEach(function(e){t.$bind(e,n[e])})},beforeDestroy:function(){for(var e in this._firestoreUnbinds)this._firestoreUnbinds[e]();this._firestoreUnbinds=null,this.$firestoreRefs=null}}),e.prototype.$bind=function(e,t,n){this._firestoreUnbinds[e]&&this.$unbind(e);var r=i({vm:this,key:e,ref:t},n);return this.$firestoreRefs[e]=t,r},e.prototype.$unbind=function(e){this._firestoreUnbinds[e](),delete this._firestoreUnbinds[e],delete this.$firestoreRefs[e]}}});