/*!
 * vuefire v2.0.0-alpha.3
 * (c) 2017 Eduardo San Martin Morote
 * Released under the MIT License.
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.Vuefire={})}(this,function(e){"use strict";function t(e){return Object.defineProperty(e.data(),"id",{value:e.id})}function n(e,t,r,i){void 0===r&&(r=""),void 0===i&&(i=[{},{}]),t=t||{};var o=Object.getOwnPropertyDescriptor(e,"id");return o&&!o.enumerable&&Object.defineProperty(i[0],"id",o),Object.keys(e).reduce(function(i,o){var s=e[o];"function"==typeof s.isEqual?(i[0][o]=t[o]||s.path,i[1][r+o]=s):Array.isArray(s)?(i[0][o]=Array(s.length).fill(null),n(s,t[o]||{},r+o+".",[i[0][o],i[1]])):(u=s)&&"object"==typeof u?(i[0][o]={},n(s,t[o]||{},r+o+".",[i[0][o],i[1]])):i[0][o]=s;var u;return i},i)}function r(e,t,n){var r=(""+t).split("."),i=r.pop();return r.reduce(function(e,t){return e[t]},e)[i]=n}function i(e){for(var t in e)e[t].unsub()}function o(e){var n=e.subs,o=e.refs,u=e.target,f=e.path,c=(e.data,e.depth),a=e.resolve,d=Object.keys(o);if(Object.keys(n).filter(function(e){return d.indexOf(e)<0}).forEach(function(e){n[e].unsub(),delete n[e]}),!d.length)return a();if(++c>3)throw new Error("more than 5 nested refs");d.forEach(function(e){var d=n[e],l=o[e];if(d){if(d.path===l.path)return;d.unsub()}n[e]={unsub:function(e){var n=e.ref,o=e.target,u=e.path,f=e.depth,c=e.resolve,a=Object.create(null),d=n.onSnapshot(function(e){e.exists?s({snapshot:t(e),target:o,path:u,subs:a,depth:f,resolve:c}):(r(o,u,null),c())});return function(){d(),i(a)}}({ref:l,target:u,path:f+"."+e,depth:c,resolve:a}),path:l.path}})}function s(e){var t=e.snapshot,i=e.target,s=e.path,u=e.subs,f=e.depth;void 0===f&&(f=0);var c,a,d=e.resolve,l=n(t,(c=i,a=s,a.split(".").reduce(function(e,t){return e[t]},c))),p=l[0],h=l[1];r(i,s,p),o({data:p,subs:u,refs:h,target:i,path:s,depth:f,resolve:d})}function u(e){var r=e.vm,u=e.key,f=e.ref;return new Promise(function(e,c){var a;a=f.where?function(e){var r,s=e.vm,u=e.key,f=e.collection,c=e.resolve,a=e.reject,d=s[u]=[],l=c,p=[],h={added:function(e){var r=e.newIndex,i=e.doc;p.splice(r,0,Object.create(null));var s=p[r],u=n(t(i)),f=u[0],a=u[1];d.splice(r,0,f),o({data:f,refs:a,subs:s,target:d,path:r,depth:0,resolve:c.bind(null,i)})},modified:function(e){var r=e.oldIndex,i=e.newIndex,s=e.doc,u=p.splice(r,1)[0];p.splice(i,0,u);var f=d.splice(r,1)[0],a=n(t(s),f),l=a[0],h=a[1];d.splice(i,0,l),o({data:l,refs:h,subs:u,target:d,path:i,depth:0,resolve:c})},removed:function(e){var t=e.oldIndex;d.splice(t,1),i(p.splice(t,1)[0])}},v=f.onSnapshot(function(e){var t=e.docChanges;if(!r&&t.length){r=!0;var n=0,i=t.length,o=t.reduce(function(e,t){return e[t.doc.id]=!1,e},Object.create(null));c=function(e){e.id in o&&++n>=i&&(l(s[u]),c=function(e){})}}t.forEach(function(e){h[e.type](e)}),t.length||c()},a);return function(){v(),p.forEach(i)}}({vm:r,key:u,collection:f,resolve:e,reject:c}):function(e){var n=e.vm,r=e.key,o=e.document,u=e.resolve,f=e.reject,c=Object.create(null);u=function(e,t){var n;return function(){if(!n)return n=!0,e(t())}}(u,function(){return n[r]});var a=o.onSnapshot(function(e){e.exists?s({snapshot:t(e),target:n,path:r,subs:c,resolve:u}):u()},f);return function(){a(),i(c)}}({vm:r,key:u,document:f,resolve:e,reject:c}),r._firestoreUnbinds[u]=a})}e.default=function(e,t){var n=e.config.optionMergeStrategies;n.firestore=n.provide,e.mixin({created:function(){var e=this,t=this.$options.firestore;this._firestoreUnbinds=Object.create(null),this.$firestoreRefs=Object.create(null);var n="function"==typeof t?t.call(this):t;n&&Object.keys(n).forEach(function(t){e.$bind(t,n[t])})},beforeDestroy:function(){for(var e in this._firestoreUnbinds)this._firestoreUnbinds[e]();this._firestoreUnbinds=null,this.$firestoreRefs=null}}),e.prototype.$bind=function(e,t){this._firestoreUnbinds[e]&&this.$unbind(e);var n=u({vm:this,key:e,ref:t});return this.$firestoreRefs[e]=t,n},e.prototype.$unbind=function(e){this._firestoreUnbinds[e](),delete this._firestoreUnbinds[e],delete this.$firestoreRefs[e]}},Object.defineProperty(e,"__esModule",{value:!0})});