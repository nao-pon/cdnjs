define(function(e){function n(n,i,l){var u=this,s=e("./shape");e("./shape/circle"),e("./shape/ellipse"),e("./shape/line"),e("./shape/polygon"),e("./shape/brokenLine"),e("./shape/rectangle"),e("./shape/ring"),e("./shape/sector"),e("./shape/text"),e("./shape/heart"),e("./shape/droplet"),e("./shape/path"),e("./shape/image"),e("./shape/beziercurve"),e("./shape/star"),e("./shape/isogon");var d;if(void 0===l.shape)d=s;else{d={};for(var c in l.shape)d[c]=l.shape[c];d.get=function(e){return d[e]||s.get(e)}}var h=new t(d),f=new r(i,h,d),v=new o(i,h,f,d),p=[],g=new(e("./animation/animation"))({stage:{update:function(){u.update(p)}}});g.start(),u.getId=function(){return n},u.addShape=function(e){return h.add(e),u},u.delShape=function(e){return h.del(e),u},u.modShape=function(e,n){return h.mod(e,n),u},u.addHoverShape=function(e){return h.addHover(e),u},u.render=function(e){return f.render(e),u},u.refresh=function(e){return f.refresh(e),u},u.update=function(e,n){return f.update(e,n),u},u.resize=function(){return f.resize(),u},u.animate=function(n,t,r){var o=e("./tool/util"),i=h.get(n);if(i){var l;if(t){for(var u=t.split("."),s=i,d=0,c=u.length;d<c;d++)s&&(s=s[u[d]]);s&&(l=s)}else l=i;return l?(void 0===i.__aniCount&&(i.__aniCount=0),0===i.__aniCount&&p.push(i),i.__aniCount++,g.animate(l,r).done(function(){if(0===--i.__aniCount){var e=o.indexOf(p,i);p.splice(e,1)}})):void a.log('Property "'+t+'" is not existed in shape '+n)}a.log('Shape "'+n+'" not existed')},u.showLoading=function(e){return f.showLoading(e),u},u.hideLoading=function(){return f.hideLoading(),u},u.newShapeId=function(e){return h.newShapeId(e)},u.getWidth=function(){return f.getWidth()},u.getHeight=function(){return f.getHeight()},u.toDataURL=function(e,n){return f.toDataURL(e,n)},u.on=function(e,n){return v.on(e,n),u},u.un=function(e,n){return v.un(e,n),u},u.clear=function(){return h.del(),f.clear(),u},u.dispose=function(){g.stop(),g=null,p=null,u.clear(),u=null,h.dispose(),h=null,f.dispose(),f=null,v.dispose(),v=null,a.delInstance(n)}}function t(n){function t(e){e.hoverable||e.onclick||e.draggable||e.onmousemove||e.onmouseover||e.onmouseout||e.onmousedown||e.onmouseup||e.ondragenter||e.ondragover||e.ondragleave||e.ondrop?e.__silent=!1:e.__silent=!0,Math.abs(e.rotation[0])>1e-4||Math.abs(e.position[0])>1e-4||Math.abs(e.position[1])>1e-4||Math.abs(e.scale[0]-1)>1e-4||Math.abs(e.scale[1]-1)>1e-4?e.__needTransform=!0:e.__needTransform=!1,e.style=e.style||{},e.style.__rect=null}function r(e){return(e||"")+ ++L}function o(e){var n={shape:"circle",id:e.id||w.newShapeId(),zlevel:0,draggable:!1,clickable:!1,hoverable:!0,position:[0,0],rotation:[0,0,0],scale:[1,1,0,0]};return b.merge(n,e,{overwrite:!0,recursive:!0}),t(n),y[n.id]=n,M[n.zlevel]=M[n.zlevel]||[],M[n.zlevel].push(n),_=Math.max(_,n.zlevel),C[n.zlevel]=!0,w}function i(e){return y[e]}function l(e){if(void 0!==e){if(y[e]){C[y[e].zlevel]=!0;for(var n=M[y[e].zlevel],t=[],r=0,o=n.length;r<o;r++)n[r].id!=e&&t.push(n[r]);M[y[e].zlevel]=t,delete y[e]}}else y={},M=[],S=[],_=0,C={all:!0};return w}function u(e,n){var r=y[e];return r&&(C[r.zlevel]=!0,b.merge(r,n,{overwrite:!0,recursive:!0}),t(r),C[r.zlevel]=!0,_=Math.max(_,r.zlevel)),w}function s(e,t,r){var o=y[e];if(o.__needTransform=!0,!o.ondrift||o.ondrift&&!o.ondrift(o,t,r))if(a.catchBrushException)try{n.get(o.shape).drift(o,t,r)}catch(e){a.log(e,"drift error of "+o.shape,o)}else n.get(o.shape).drift(o,t,r);return C[o.zlevel]=!0,w}function d(e){return e.rotation&&Math.abs(e.rotation[0])>1e-4||e.position&&(Math.abs(e.position[0])>1e-4||Math.abs(e.position[1])>1e-4)||e.scale&&(Math.abs(e.scale[0]-1)>1e-4||Math.abs(e.scale[1]-1)>1e-4)?e.__needTransform=!0:e.__needTransform=!1,S.push(e),w}function c(){return S=[],w}function h(){return S.length>0}function f(e,n){if(n||(n={hover:!1,normal:"down"}),n.hover)for(var t=0,r=S.length;t<r;t++)if(e(S[t]))return w;var o,i;if(void 0!==n.normal)switch(n.normal){case"down":for(r=M.length-1;r>=0;r--)if(o=M[r])for(i=o.length;i--;)if(e(o[i]))return w;break;case"up":for(var t=0,r=M.length;t<r;t++)if(o=M[t]){i=o.length;for(var a=0;a<i;a++)if(e(o[a]))return w}break;default:for(var t in y)if(e(y[t]))return w}return w}function v(){return _}function p(){return C}function g(){return C={},w}function m(e){return C[e]=!0,w}function E(){y=null,M=null,S=null,w=null}var b=e("./tool/util"),w=this,L=0,y={},M=[],S=[],_=0,C={};w.newShapeId=r,w.add=o,w.get=i,w.del=l,w.addHover=d,w.delHover=c,w.hasHoverShape=h,w.mod=u,w.drift=s,w.iterShape=f,w.getMaxZlevel=v,w.getChangedZlevel=p,w.clearChangedZlevel=g,w.setChangedZlevle=m,w.dispose=E}function r(n,t,r){function o(){var e=n.currentStyle||document.defaultView.getComputedStyle(n);return n.clientWidth-e.paddingLeft.replace(/\D/g,"")-e.paddingRight.replace(/\D/g,"")}function i(){var e=n.currentStyle||document.defaultView.getComputedStyle(n);return n.clientHeight-e.paddingTop.replace(/\D/g,"")-e.paddingBottom.replace(/\D/g,"")}function l(){var e=t.getMaxZlevel();if(D<e){for(var n=D+1;n<=e;n++)x[n]=u(n,"canvas"),V.insertBefore(x[n],x.hover),G_vmlCanvasManager&&G_vmlCanvasManager.initElement(x[n]),H[n]=x[n].getContext("2d"),1!=O&&H[n].scale(O,O);D=e}}function u(e,n){var t=document.createElement(n);return t.style.position="absolute",t.style.width=N+"px",t.style.height=R+"px",t.setAttribute("width",N*O),t.setAttribute("height",R*O),t.setAttribute("data-id",e),t}function s(e){return function(n){if((e.all||e[n.zlevel])&&!n.invisible){var t=H[n.zlevel];if(t){if(!n.onbrush||n.onbrush&&!n.onbrush(t,n,!1))if(a.catchBrushException)try{r.get(n.shape).brush(t,n,!1,f)}catch(e){a.log(e,"brush error of "+n.shape,n)}else r.get(n.shape).brush(t,n,!1,f)}else a.log("can not find the specific zlevel canvas!")}}}function d(e){var n=H.hover;if(!e.onbrush||e.onbrush&&!e.onbrush(n,e,!0))if(a.catchBrushException)try{r.get(e.shape).brush(n,e,!0,f)}catch(n){a.log(n,"hoverBrush error of "+e.shape,e)}else r.get(e.shape).brush(n,e,!0,f)}function c(e){return b()&&E(),l(),t.iterShape(s({all:!0}),{normal:"up"}),t.clearChangedZlevel(),"function"==typeof e&&e(),z}function h(e){l();var n=t.getChangedZlevel();if(n.all)v();else for(var r in n)H[r]&&H[r].clearRect(0,0,N*O,R*O);return t.iterShape(s(n),{normal:"up"}),t.clearChangedZlevel(),"function"==typeof e&&e(),z}function f(e,n){for(var r,o=0,i=e.length;o<i;o++)r=e[o],t.mod(r.id,r);return h(n),z}function v(){for(var e in H)"hover"!=e&&H[e].clearRect(0,0,N*O,R*O);return z}function p(){return g(),t.iterShape(d,{hover:!0}),t.delHover(),z}function g(){return H&&H.hover&&H.hover.clearRect(0,0,N*O,R*O),z}function m(n){var r=e("./tool/loadingEffect");return r.stop(C),n=n||{},n.effect=n.effect||T.loadingEffect,n.canvasSize={width:N,height:R},C=r.start(n,t.addHover,p),z.loading=!0,z}function E(){return e("./tool/loadingEffect").stop(C),g(),z.loading=!1,z}function b(){return z.loading}function w(){return N}function L(){return R}function y(){var e,n,r;if(V.style.display="none",e=o(),n=i(),V.style.display="",N!=e||n!=R){N=e,R=n,V.style.width=N+"px",V.style.height=R+"px";for(var a in x)(r=x[a]).setAttribute("width",N),r.setAttribute("height",R),r.style.width=N+"px",r.style.height=R+"px";t.setChangedZlevle("all"),h()}return z}function M(){b()&&E(),n.innerHTML="",n=null,t=null,r=null,V=null,x=null,H=null,z=null}function S(){return x.hover}function _(e,n){if(G_vmlCanvasManager)return null;var o=u("image","canvas");x.bg.appendChild(o);var i=o.getContext("2d");1!=O&&i.scale(O,O),i.fillStyle="#fff",i.rect(0,0,N*O,R*O),i.fill(),t.iterShape(function(e){if(!e.invisible&&(!e.onbrush||e.onbrush&&!e.onbrush(i,e,!1)))if(a.catchBrushException)try{r.get(e.shape).brush(i,e,!1,f)}catch(n){a.log(n,"brush error of "+e.shape,e)}else r.get(e.shape).brush(i,e,!1,f)},{normal:"up"});var l=o.toDataURL(e,n);return i=null,x.bg.removeChild(o),l}var C,T=e("./config"),z=this,x={},H={},D=0,V=document.createElement("div");V.onselectstart=function(){return!1};var N,R,O=window.devicePixelRatio||1;z.render=c,z.refresh=h,z.update=f,z.clear=v,z.refreshHover=p,z.clearHover=g,z.showLoading=m,z.hideLoading=E,z.isLoading=b,z.getWidth=w,z.getHeight=L,z.resize=y,z.dispose=M,z.getDomHover=S,z.toDataURL=_,function(){V.innerHTML="",n.innerHTML="",N=o(),R=i(),V.style.position="relative",V.style.overflow="hidden",V.style.width=N+"px",V.style.height=R+"px",n.appendChild(V),x={},H={},D=t.getMaxZlevel(),x.bg=u("bg","div"),V.appendChild(x.bg);for(var e=0;e<=D;e++)x[e]=u(e,"canvas"),V.appendChild(x[e]),G_vmlCanvasManager&&G_vmlCanvasManager.initElement(x[e]),H[e]=x[e].getContext("2d"),1!=O&&H[e].scale(O,O);x.hover=u("hover","canvas"),x.hover.id="_zrender_hover_",V.appendChild(x.hover),G_vmlCanvasManager&&G_vmlCanvasManager.initElement(x.hover),H.hover=x.hover.getContext("2d"),1!=O&&H.hover.scale(O,O)}()}function o(n,t,r,o){function i(e){D=e||window.event,A=null,I=!1,N.dispatch(x.EVENT.RESIZE,D)}function a(e){D=_(e),A?A&&A.clickable&&M(A,x.EVENT.CLICK):M(A,x.EVENT.CLICK),u(D)}function l(e){D=_(e),M(A,x.EVENT.MOUSEWHEEL),u(D)}function u(e){r.isLoading()||(D=_(e),X=B,Y=W,B=R(D),W=O(D),m(),k=!1,t.iterShape(S,{normal:"down"}),k||((!U||A&&A.id!=U.id)&&(c(),w()),A=null,t.delHover(),r.clearHover()),U&&(t.drift(U.id,B-X,W-Y),t.addHover(U)),M(A,x.EVENT.MOUSEMOVE),(U||k||t.hasHoverShape())&&r.refreshHover(),U||k&&A.draggable?n.style.cursor="move":k&&A.clickable?n.style.cursor="pointer":n.style.cursor="default")}function s(e){var t=(D=_(e)).toElement||D.relatedTarget;if(t!=n)for(;t&&9!=t.nodeType;){if(t==n)return void u(e);t=t.parentNode}D.zrenderX=X,D.zrenderY=Y,n.style.cursor="default",I=!1,c(),L(),y(),r.isLoading()||r.refreshHover()}function d(){M(A,x.EVENT.MOUSEOVER)}function c(){M(A,x.EVENT.MOUSEOUT)}function h(e){D=_(e),I=!0,G=A,M(A,x.EVENT.MOUSEDOWN)}function f(e){D=_(e),n.style.cursor="default",I=!1,G=null,M(A,x.EVENT.MOUSEUP),L(),y()}function v(e){H.stop(e),D=_(e,!0),V=new Date,h(D)}function p(e){H.stop(e),u(D=_(e,!0))}function g(e){H.stop(e),f(D=_(e,!0)),r.clearHover(),new Date-V<x.EVENT.touchClickDelay&&(A=null,B=D.zrenderX,W=D.zrenderY,t.iterShape(S,{normal:"down"}),A||(B+=10,t.iterShape(S,{normal:"down"})),A||(B-=20,t.iterShape(S,{normal:"down"})),A||(B+=10,W+=10,t.iterShape(S,{normal:"down"})),A||(W-=20,t.iterShape(S,{normal:"down"})),A&&(D.zrenderX=B,D.zrenderY=W),a(D))}function m(){I&&A&&A.draggable&&!U&&G==A&&(Z=!0,(U=A).invisible=!0,t.mod(U.id,U),M(U,x.EVENT.DRAGSTART),r.refresh())}function E(){U&&M(A,x.EVENT.DRAGENTER,U)}function b(){U&&M(A,x.EVENT.DRAGOVER,U)}function w(){U&&M(A,x.EVENT.DRAGLEAVE,U)}function L(){U&&(U.invisible=!1,t.mod(U.id,U),r.refresh(),M(A,x.EVENT.DROP,U))}function y(){U&&(M(U,x.EVENT.DRAGEND),A=null),Z=!1,U=null}function M(e,n,t){var r="on"+n,o={type:n,event:D,target:e};t&&(o.dragged=t),e?e[r]&&e[r](o)||N.dispatch(n,D,o):t||N.dispatch(n,D)}function S(e){return(!U||U.id!=e.id)&&(!e.__silent&&(!!o.get(e.shape).isCover(e,B,W)&&(e.hoverable&&t.addHover(e),A!=e&&(c(),w(),A=e,E()),d(),b(),k=!0,!0)))}function _(e,t){if(t){var r="touchend"!=(D=e).type?D.targetTouches[0]:D.changedTouches[0];r&&(D.zrenderX=r.clientX-n.offsetLeft+document.body.scrollLeft,D.zrenderY=r.clientY-n.offsetTop+document.body.scrollTop)}else{var o=(D=e||window.event).toElement||D.relatedTarget||D.srcElement||D.target;o&&o!=P&&(D.zrenderX=(void 0!==D.offsetX?D.offsetX:D.layerX)+o.offsetLeft,D.zrenderY=(void 0!==D.offsetY?D.offsetY:D.layerY)+o.offsetTop)}return D}function C(e,n){return N.bind(e,n),N}function T(e,n){return N.unbind(e,n),N}function z(){window.removeEventListener?(window.removeEventListener("resize",i),n.removeEventListener("click",a),n.removeEventListener("mousewheel",l),n.removeEventListener("DOMMouseScroll",l),n.removeEventListener("mousemove",u),n.removeEventListener("mouseout",s),n.removeEventListener("mousedown",h),n.removeEventListener("mouseup",f),n.removeEventListener("touchstart",v),n.removeEventListener("touchmove",p),n.removeEventListener("touchend",g)):(window.detachEvent("onresize",i),n.detachEvent("onclick",a),n.detachEvent("onmousewheel",l),n.detachEvent("onmousemove",u),n.detachEvent("onmouseout",s),n.detachEvent("onmousedown",h),n.detachEvent("onmouseup",f)),n=null,P=null,t=null,r=null,o=null,T(),N=null}var x=e("./config"),H=e("./tool/event");H.Dispatcher.call(this);var D,V,N=this,R=H.getX,O=H.getY,k=!1,A=null,G=null,U=null,I=!1,Z=!1,X=0,Y=0,B=0,W=0,P=r.getDomHover();N.on=C,N.un=T,N.dispose=z,function(){window.addEventListener?(window.addEventListener("resize",i),n.addEventListener("click",a),n.addEventListener("mousewheel",l),n.addEventListener("DOMMouseScroll",l),n.addEventListener("mousemove",u),n.addEventListener("mouseout",s),n.addEventListener("mousedown",h),n.addEventListener("mouseup",f),n.addEventListener("touchstart",v),n.addEventListener("touchmove",p),n.addEventListener("touchend",g)):(window.attachEvent("onresize",i),n.attachEvent("onclick",a),n.attachEvent("onmousewheel",l),n.attachEvent("onmousemove",u),n.attachEvent("onmouseout",s),n.attachEvent("onmousedown",h),n.attachEvent("onmouseup",f))}()}e("./lib/excanvas");var i={},a=i,l=0,u={};return i.init=function(e,t){var r=new n(++l+"",e,t||{});return u[l]=r,r},i.dispose=function(e){if(e)e.dispose();else{for(var n in u)u[n].dispose();u={}}return i},i.getInstance=function(e){return u[e]},i.delInstance=function(e){return u[e]&&(u[e]=null,delete u[e]),i},i.catchBrushException=!1,i.debugMode=0,i.log=function(){if(0!==i.debugMode){if(1==i.debugMode)for(var e in arguments)throw new Error(arguments[e]);else if(i.debugMode>1)for(var e in arguments)console.log(arguments[e]);return i}},i});