!function(e){if("function"==typeof require&&"undefined"!=typeof module){var n=require("sockjs-client");if(!n)throw new Error("vertx-eventbus.js requires sockjs-client, see http://sockjs.org");e(n)}else if("function"==typeof define&&define.amd)define("vertx-eventbus",["sockjs"],e);else{if(void 0===this.SockJS)throw new Error("vertx-eventbus.js requires sockjs-client, see http://sockjs.org");EventBus=e(this.SockJS)}}(function(e){function n(e,n){if(e){if(!n)return e;for(var t in e)e.hasOwnProperty(t)&&void 0===n[t]&&(n[t]=e[t])}return n||{}}var t=function(n,r){var o=this;r=r||{},this.pingInterval=r.vertxbus_ping_interval||5e3,this.pingTimerID=null,this.reconnectEnabled=!1,this.reconnectAttempts=0,this.reconnectTimerID=null,this.maxReconnectAttempts=r.vertxbus_reconnect_attempts_max||1/0,this.reconnectDelayMin=r.vertxbus_reconnect_delay_min||1e3,this.reconnectDelayMax=r.vertxbus_reconnect_delay_max||5e3,this.reconnectExponent=r.vertxbus_reconnect_exponent||2,this.randomizationFactor=r.vertxbus_randomization_factor||.5;this.defaultHeaders=null,this.onerror=function(e){try{console.error(e)}catch(e){}};var s=function(){o.sockJSConn=new e(n,null,r),o.state=t.CONNECTING,o.handlers={},o.replyHandlers={},o.sockJSConn.onopen=function(){o.enablePing(!0),o.state=t.OPEN,o.onopen&&o.onopen(),o.reconnectTimerID&&(o.reconnectAttempts=0,o.onreconnect&&o.onreconnect())},o.sockJSConn.onclose=function(e){o.state=t.CLOSED,o.pingTimerID&&clearInterval(o.pingTimerID),o.reconnectEnabled&&o.reconnectAttempts<o.maxReconnectAttempts&&(o.sockJSConn=null,o.reconnectTimerID=setTimeout(s,function(){var e=o.reconnectDelayMin*Math.pow(o.reconnectExponent,o.reconnectAttempts);if(o.randomizationFactor){var n=Math.random(),t=Math.floor(n*o.randomizationFactor*e);e=0==(1&Math.floor(10*n))?e-t:e+t}return 0|Math.min(e,o.reconnectDelayMax)}()),++o.reconnectAttempts),o.onclose&&o.onclose(e)},o.sockJSConn.onmessage=function(e){var n=JSON.parse(e.data);if(n.replyAddress&&Object.defineProperty(n,"reply",{value:function(e,t,r){o.send(n.replyAddress,e,t,r)}}),o.handlers[n.address])for(var t=o.handlers[n.address],r=0;r<t.length;r++)"err"===n.type?t[r]({failureCode:n.failureCode,failureType:n.failureType,message:n.message}):t[r](null,n);else if(o.replyHandlers[n.address]){var s=o.replyHandlers[n.address];delete o.replyHandlers[n.address],"err"===n.type?s({failureCode:n.failureCode,failureType:n.failureType,message:n.message}):s(null,n)}else if("err"===n.type)o.onerror(n);else try{console.warn("No handler found for message: ",n)}catch(e){}}};s()};if(t.prototype.send=function(e,r,o,s){if(this.state!=t.OPEN)throw new Error("INVALID_STATE_ERR");"function"==typeof o&&(s=o,o={});var i={type:"send",address:e,headers:n(this.defaultHeaders,o),body:r};if(s){var a="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e,n){return n=16*Math.random(),("y"==e?3&n|8:0|n).toString(16)});i.replyAddress=a,this.replyHandlers[a]=s}this.sockJSConn.send(JSON.stringify(i))},t.prototype.publish=function(e,r,o){if(this.state!=t.OPEN)throw new Error("INVALID_STATE_ERR");this.sockJSConn.send(JSON.stringify({type:"publish",address:e,headers:n(this.defaultHeaders,o),body:r}))},t.prototype.registerHandler=function(e,r,o){if(this.state!=t.OPEN)throw new Error("INVALID_STATE_ERR");"function"==typeof r&&(o=r,r={}),this.handlers[e]||(this.handlers[e]=[],this.sockJSConn.send(JSON.stringify({type:"register",address:e,headers:n(this.defaultHeaders,r)}))),this.handlers[e].push(o)},t.prototype.unregisterHandler=function(e,r,o){if(this.state!=t.OPEN)throw new Error("INVALID_STATE_ERR");var s=this.handlers[e];if(s){"function"==typeof r&&(o=r,r={});var i=s.indexOf(o);-1!=i&&(s.splice(i,1),0===s.length&&(this.sockJSConn.send(JSON.stringify({type:"unregister",address:e,headers:n(this.defaultHeaders,r)})),delete this.handlers[e]))}},t.prototype.close=function(){this.state=t.CLOSING,this.enableReconnect(!1),this.sockJSConn.close()},t.CONNECTING=0,t.OPEN=1,t.CLOSING=2,t.CLOSED=3,t.prototype.enablePing=function(e){var n=this;if(e){var t=function(){n.sockJSConn.send(JSON.stringify({type:"ping"}))};n.pingInterval>0&&(t(),n.pingTimerID=setInterval(t,n.pingInterval))}else n.pingTimerID&&(clearInterval(n.pingTimerID),n.pingTimerID=null)},t.prototype.enableReconnect=function(e){var n=this;n.reconnectEnabled=e,!e&&n.reconnectTimerID&&(clearTimeout(n.reconnectTimerID),n.reconnectTimerID=null,n.reconnectAttempts=0)},"undefined"==typeof exports)return t;"undefined"!=typeof module&&module.exports?exports=module.exports=t:exports.EventBus=t});