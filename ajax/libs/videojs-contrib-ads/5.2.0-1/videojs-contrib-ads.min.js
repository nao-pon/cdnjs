/*
 * videojs-contrib-ads
 * @version 5.2.0-1
 * @copyright 2018 Brightcove, Inc.
 * @license Apache-2.0
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("video.js")):"function"==typeof define&&define.amd?define(["video.js"],t):e.videojsContribAds=t(e.videojs)}(this,function(e){"use strict";function t(e){"playing"===e.type?i(this,e):"ended"===e.type?o(this,e):"loadstart"===e.type||"loadeddata"===e.type||"loadedmetadata"===e.type?r(this,e):"play"===e.type?c(this,e):this.ads.isInAdMode()&&(this.ads.isContentResuming()?d(this,"content",e):d(this,"ad",e))}function n(e){e.ads.cancelPlayTimeout||e.ads.stitchedAds()||(e.ads.cancelPlayTimeout=e.setTimeout(function(){e.ads.cancelPlayTimeout=null,e.paused()||e.pause(),e.ads._cancelledPlay=!0},1))}e=e&&e.hasOwnProperty("default")?e["default"]:e;var a,s=function(e,t){t.isImmediatePropagationStopped=function(){return!0},t.cancelBubble=!0,t.isPropagationStopped=function(){return!0}},d=function(e,t,n){s(0,n),e.trigger({type:t+n.type,state:e.ads.state,originalEvent:n})},i=function(e,t){e.ads.isInAdMode()&&(e.ads.isContentResuming()?e.ads._contentEnding&&d(e,"content",t):e.ads._cancelledPlay?s(0,t):d(e,"ad",t))},o=function(e,t){if(e.ads.isInAdMode()){if(e.ads.isContentResuming())return;d(e,"ad",t)}else d(e,"content",t)},r=function(e,t){if(!("loadstart"===t.type&&!e.ads._hasThereBeenALoadStartDuringPlayerLife||"loadeddata"===t.type&&!e.ads._hasThereBeenALoadedData||"loadedmetadata"===t.type&&!e.ads._hasThereBeenALoadedMetaData))if(e.ads.isAdPlaying())d(e,"ad",t);else{if(e.currentSrc()!==e.ads.contentSrc)return;d(e,"content",t)}},c=function(e,t){var n=e.ads._cancelledPlay&&!e.ads.isInAdMode();e.ads.isAdPlaying()?d(e,"ad",t):(e.ads.isContentResuming()||n)&&d(e,"content",t)},u="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},l="undefined"!=typeof window?window:void 0!==u?u:"undefined"!=typeof self?self:{},f={},p=(Object.freeze||Object)({"default":f}),h=p&&f||p,m=void 0!==u?u:"undefined"!=typeof window?window:{};"undefined"!=typeof document?a=document:(a=m["__GLOBAL_DOCUMENT_CACHE@4"])||(a=m["__GLOBAL_DOCUMENT_CACHE@4"]=h);var y=a,g="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},v=function(e,t){return t?encodeURIComponent(e):e},T=function(e,t,n){if(e&&e[n])for(var a=e[n],s=Object.keys(a),d=0;d<s.length;d++){t["{mediainfo."+n+"."+s[d]+"}"]=a[s[d]]}},b={};b.processMetadataTracks=function(e,t){for(var n=e.textTracks(),a=function(n){"metadata"===n.kind&&(e.ads.cueTextTracks.setMetadataTrackMode(n),t(e,n))},s=0;s<n.length;s++)a(n[s]);n.addEventListener("addtrack",function(e){a(e.track)})},b.setMetadataTrackMode=function(e){},b.getSupportedAdCue=function(e,t){return t},b.isSupportedAdCue=function(e,t){return!0},b.getCueId=function(e,t){return t.id};var _=function(e,t){return t!==undefined&&e.ads.includedCues[t]},A=function(e,t){t!==undefined&&""!==t&&(e.ads.includedCues[t]=!0)};b.processAdTrack=function(t,n,a,s){t.ads.includedCues={};for(var d=0;d<n.length;d++){var i=n[d],o=this.getSupportedAdCue(t,i);if(!this.isSupportedAdCue(t,i))return void e.log.warn("Skipping as this is not a supported ad cue.",i);var r=this.getCueId(t,i),c=i.startTime;if(_(t,r))return void e.log("Skipping ad already seen with ID "+r);s&&s(t,o,r,c),a(t,o,r,c),A(t,r)}};var k=e.getTech("Html5").Events,S=function(e){var t=e.$(".vjs-tech");t&&t.removeAttribute("poster")},C={timeout:5e3,prerollTimeout:100,postrollTimeout:100,debug:!1,stitchedAds:!1},P=function(a){var s=this,d=e.mergeOptions(C,a),i=k.concat(["firstplay","loadedalldata","playing"]);s.on(i,t),s.setTimeout(function(){s.ads._hasThereBeenALoadStartDuringPlayerLife||""===s.src()||e.log.error("videojs-contrib-ads has not seen a loadstart event 5 seconds after being initialized, but a source is present. This indicates that videojs-contrib-ads was initialized too late. It must be initialized immediately after video.js in the same tick. As a result, some ads will not play and some media events will be incorrect. For more information, see https://github.com/videojs/videojs-contrib-ads#important-note-about-initialization")},5e3),s.on("ended",function(){s.hasClass("vjs-has-started")||s.addClass("vjs-has-started")}),s.on(["addurationchange","adcanplay"],function(){s.ads.snapshot&&s.currentSrc()===s.ads.snapshot.currentSrc||s.ads.isAdPlaying()&&(s.ads.stitchedAds()||s.play())}),s.on("nopreroll",function(){s.ads.nopreroll_=!0}),s.on("nopostroll",function(){s.ads.nopostroll_=!0}),s.on(["ads-ad-started","playing"],function(){s.removeClass("vjs-ad-loading")}),s.on("playing",function(){s.ads._cancelledPlay=!1}),s.one("loadstart",function(){s.ads._hasThereBeenALoadStartDuringPlayerLife=!0}),s.on("loadeddata",function(){s.ads._hasThereBeenALoadedData=!0}),s.on("loadedmetadata",function(){s.ads._hasThereBeenALoadedMetaData=!0}),s.ads={state:"content-set",disableNextSnapshotRestore:!1,_contentEnding:!1,_contentHasEnded:!1,_hasThereBeenALoadStartDuringPlayerLife:!1,_hasThereBeenALoadedData:!1,_hasThereBeenALoadedMetaData:!1,_inLinearAdMode:!1,adType:null,VERSION:"__VERSION__",reset:function(){s.ads.disableNextSnapshotRestore=!1,s.ads._contentEnding=!1,s.ads._contentHasEnded=!1,s.ads.snapshot=null,s.ads.adType=null,s.ads._hasThereBeenALoadedData=!1,s.ads._hasThereBeenALoadedMetaData=!1,s.ads._cancelledPlay=!1,s.ads._stitchedAds=!1},startLinearAdMode:function(){"preroll?"!==s.ads.state&&"content-playback"!==s.ads.state&&"postroll?"!==s.ads.state||(s.ads._inLinearAdMode=!0,s.trigger("adstart"))},endLinearAdMode:function(){"ad-playback"===s.ads.state&&(s.ads._inLinearAdMode=!1,s.trigger("adend"),s.removeClass("vjs-ad-loading"))},skipLinearAdMode:function(){"ad-playback"!==s.ads.state&&s.trigger("adskip")},stitchedAds:function(e){return e!==undefined&&(this._stitchedAds=!!e),this._stitchedAds},videoElementRecycled:function(){if(s.ads.shouldPlayContentBehindAd(s))return!1;if(!this.snapshot)throw new Error("You cannot use videoElementRecycled while there is no snapshot.");var e=s.tech_.src()!==this.snapshot.src,t=s.currentSrc()!==this.snapshot.currentSrc;return e||t},isLive:function(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:s;return t.duration()===Infinity||"8"===e.browser.IOS_VERSION&&0===t.duration()},shouldPlayContentBehindAd:function(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:s;return!e.browser.IS_IOS&&!e.browser.IS_ANDROID&&t.duration()===Infinity},shouldUseSnapshots:function(){return!this.shouldPlayContentBehindAd()&&!this.stitchedAds()},isInAdMode:function(){return"ads-ready?"===s.ads.state||"preroll?"===s.ads.state||"ad-playback"===s.ads.state||"content-resuming"===s.ads.state},isContentResuming:function(){return"content-resuming"===s.ads.state},isAdPlaying:function(){return this._inLinearAdMode}},s.ads.stitchedAds(d.stitchedAds),s.ads.cueTextTracks=b,s.ads.adMacroReplacement=function(t,n,a){n===undefined&&(n=!1);var s={};a!==undefined&&(s=a),s["{player.id}"]=this.options_["data-player"],s["{mediainfo.id}"]=this.mediainfo?this.mediainfo.id:"",s["{mediainfo.name}"]=this.mediainfo?this.mediainfo.name:"",s["{mediainfo.description}"]=this.mediainfo?this.mediainfo.description:"",s["{mediainfo.tags}"]=this.mediainfo?this.mediainfo.tags:"",s["{mediainfo.reference_id}"]=this.mediainfo?this.mediainfo.reference_id:"",s["{mediainfo.duration}"]=this.mediainfo?this.mediainfo.duration:"",s["{mediainfo.ad_keys}"]=this.mediainfo?this.mediainfo.ad_keys:"",s["{player.duration}"]=this.duration(),s["{timestamp}"]=(new Date).getTime(),s["{document.referrer}"]=y.referrer,s["{window.location.href}"]=l.location.href,s["{random}"]=Math.floor(1e12*Math.random()),T(this.mediainfo,s,"custom_fields"),T(this.mediainfo,s,"customFields");for(var d in s)t=t.split(d).join(v(s[d],n));return t=t.replace(/{pageVariable\.([^}]+)}/g,function(t,a){for(var s=void 0,d=l,i=a.split("."),o=0;o<i.length;o++)o===i.length-1?s=d[i[o]]:d=d[i[o]];var r=void 0===s?"undefined":g(s);return null===s?"null":s===undefined?(e.log.warn('Page variable "'+a+'" not found'),""):"string"!==r&&"number"!==r&&"boolean"!==r?(e.log.warn('Page variable "'+a+'" is not a supported type'),""):v(String(s),n)})}.bind(s),function(e){e.ads.contentSrc=e.currentSrc();var t=function(){if("ad-playback"!==e.ads.state){var t=e.currentSrc();t!==e.ads.contentSrc&&(e.trigger({type:"contentupdate",oldValue:e.ads.contentSrc,newValue:t}),e.ads.contentSrc=t)}};e.on("loadstart",t),e.setTimeout(t,1)}(s),s.on("contentupdate",s.ads.reset);var o={"content-set":{events:{adscanceled:function(){this.state="content-playback"},adsready:function(){this.state="ads-ready"},play:function(){this.state="ads-ready?",n(s),S(s)},adserror:function(){this.state="content-playback"},adskip:function(){this.state="content-playback"}}},"ads-ready":{events:{play:function(){this.state="preroll?",n(s)},adskip:function(){this.state="content-playback"},adserror:function(){this.state="content-playback"}}},"preroll?":{enter:function(){s.ads.stitchedAds()?s.trigger("readyforpreroll"):s.ads.nopreroll_?(s.trigger("readyforpreroll"),s.setTimeout(function(){s.trigger("nopreroll")},1)):(s.addClass("vjs-ad-loading"),s.ads.adTimeoutTimeout=s.setTimeout(function(){s.trigger("adtimeout")},d.prerollTimeout),s.ads._hasThereBeenALoadStartDuringPlayerLife?s.trigger("readyforpreroll"):s.one("loadstart",function(){s.trigger("readyforpreroll")}))},leave:function(){s.clearTimeout(s.ads.adTimeoutTimeout)},events:{play:function(){n(s)},adstart:function(){this.state="ad-playback",s.ads.adType="preroll"},adskip:function(){this.state="content-playback"},adtimeout:function(){this.state="content-playback"},adserror:function(){this.state="content-playback"},nopreroll:function(){this.state="content-playback"}}},"ads-ready?":{enter:function(){s.ads.stitchedAds()||(s.addClass("vjs-ad-loading"),s.ads.adTimeoutTimeout=s.setTimeout(function(){s.trigger("adtimeout")},d.timeout))},leave:function(){s.ads.stitchedAds()||(s.clearTimeout(s.ads.adTimeoutTimeout),s.removeClass("vjs-ad-loading"))},events:{play:function(){n(s)},adscanceled:function(){this.state="content-playback"},adsready:function(){this.state="preroll?"},adskip:function(){this.state="content-playback"},adtimeout:function(){this.state="content-playback"},adserror:function(){this.state="content-playback"}}},"ad-playback":{enter:function(){s.ads.shouldUseSnapshots()&&(this.snapshot=function(t){var n=void 0;n=e.browser.IS_IOS&&t.ads.isLive(t)&&t.seekable().length>0?t.currentTime()-t.seekable().end(0):t.currentTime();var a=t.$(".vjs-tech"),s=t.textTracks?t.textTracks():[],d=[],i={ended:t.ended(),currentSrc:t.currentSrc(),src:t.tech_.src(),currentTime:n,type:t.currentType()};a&&(i.nativePoster=a.poster,i.style=a.getAttribute("style"));for(var o=0;o<s.length;o++){var r=s[o];d.push({track:r,mode:r.mode}),r.mode="disabled"}return i.suppressedTracks=d,i}(s)),s.ads.shouldPlayContentBehindAd(s)&&(this.preAdVolume_=s.volume(),s.volume(0)),s.addClass("vjs-ad-playing"),s.hasClass("vjs-live")&&s.removeClass("vjs-live"),S(s),s.ads.cancelPlayTimeout&&s.setTimeout(function(){s.clearTimeout(s.ads.cancelPlayTimeout),s.ads.cancelPlayTimeout=null},1)},leave:function(){s.removeClass("vjs-ad-playing"),s.ads.isLive(s)&&s.addClass("vjs-live"),s.ads.shouldUseSnapshots()&&function(t,n){if(!0!==t.ads.disableNextSnapshotRestore){var a=t.$(".vjs-tech"),s=20,d=n.suppressedTracks,i=void 0,o=function(){for(var e=0;e<d.length;e++)(i=d[e]).track.mode=i.mode},r=function(){var a=void 0;e.browser.IS_IOS&&t.ads.isLive(t)?n.currentTime<0&&(a=t.seekable().length>0?t.seekable().end(0)+n.currentTime:t.currentTime(),t.currentTime(a)):n.ended?t.currentTime(t.duration()):t.currentTime(n.currentTime),n.ended||t.play(),t.ads.shouldRemoveAutoplay_&&(t.autoplay(!1),t.ads.shouldRemoveAutoplay_=!1)},c=function u(){if(t.off("contentcanplay",u),t.ads.tryToResumeTimeout_&&(t.clearTimeout(t.ads.tryToResumeTimeout_),t.ads.tryToResumeTimeout_=null),(a=t.el().querySelector(".vjs-tech")).readyState>1)return r();if(a.seekable===undefined)return r();if(a.seekable.length>0)return r();if(s--)t.setTimeout(u,50);else try{r()}catch(n){e.log.warn("Failed to resume the content after an advertisement",n)}};n.nativePoster&&(a.poster=n.nativePoster),"style"in n&&a.setAttribute("style",n.style||""),t.ads.videoElementRecycled()?(t.one("contentloadedmetadata",o),e.browser.IS_IOS&&!t.autoplay()&&(t.autoplay(!0),t.ads.shouldRemoveAutoplay_=!0),t.src({src:n.currentSrc,type:n.type}),t.one("contentcanplay",c),t.ads.tryToResumeTimeout_=t.setTimeout(c,2e3)):(o(),t.ended()||t.play())}else t.ads.disableNextSnapshotRestore=!1}(s,this.snapshot),s.ads.shouldPlayContentBehindAd(s)&&s.volume(this.preAdVolume_)},events:{adend:function(){this.state="content-resuming",s.ads.adType=null},adserror:function(){s.ads.endLinearAdMode()}}},"content-resuming":{enter:function(){this._contentHasEnded&&(s.clearTimeout(s.ads._fireEndedTimeout),s.ads._fireEndedTimeout=s.setTimeout(function(){s.trigger("ended")},1e3))},leave:function(){s.clearTimeout(s.ads._fireEndedTimeout)},events:{contentupdate:function(){this.state="content-set"},contentresumed:function(){this.state="content-playback"},playing:function(){this.state="content-playback"},ended:function(){this.state="content-playback"}}},"postroll?":{enter:function(){s.ads._contentEnding=!0,s.ads.nopostroll_?s.setTimeout(function(){s.ads.state="content-resuming",s.trigger("ended")},1):s.ads.stitchedAds()||(s.addClass("vjs-ad-loading"),s.ads.adTimeoutTimeout=s.setTimeout(function(){s.trigger("adtimeout")},d.postrollTimeout))},leave:function(){s.ads.stitchedAds()||(s.clearTimeout(s.ads.adTimeoutTimeout),s.removeClass("vjs-ad-loading"))},events:{adstart:function(){this.state="ad-playback",s.ads.adType="postroll"},adskip:function(){this.state="content-resuming",s.setTimeout(function(){s.trigger("ended")},1)},adtimeout:function(){this.state="content-resuming",s.setTimeout(function(){s.trigger("ended")},1)},adserror:function(){this.state="content-resuming",s.setTimeout(function(){s.trigger("ended")},1)},contentupdate:function(){this.state="ads-ready?"}}},"content-playback":{enter:function(){s.ads.cancelPlayTimeout&&(s.clearTimeout(s.ads.cancelPlayTimeout),s.ads.cancelPlayTimeout=null),s.trigger({type:"contentplayback",triggerevent:s.ads.triggerevent}),s.ads._cancelledPlay&&s.paused()&&s.play()},events:{adsready:function(){s.trigger("readyforpreroll")},adstart:function(){this.state="ad-playback","preroll"!==s.ads.adType&&(s.ads.adType="midroll")},contentupdate:function(){s.paused()?this.state="content-set":this.state="ads-ready?"},contentended:function(){this._contentHasEnded?this.state="content-resuming":(this._contentEnding=!1,this._contentHasEnded=!0,this.state="postroll?")}}}},r=function(t){var n=s.ads.state,a=o[n].events;if(a){var i=a[t.type];i&&i.apply(s.ads)}if(n!==s.ads.state){var r=n,c=s.ads.state;s.ads.triggerevent=t.type,o[r].leave&&o[r].leave.apply(s.ads),o[c].enter&&o[c].enter.apply(s.ads),d.debug&&e.log("ads",s.ads.triggerevent+" triggered: "+r+" -> "+c)}},c=function(){var t=s.textTracks();if(!s.ads.shouldPlayContentBehindAd(s)&&s.ads.isAdPlaying()&&s.tech_.featuresNativeTextTracks&&e.browser.IS_IOS&&!Array.isArray(s.textTracks()))for(var n=0;n<t.length;n++){var a=t[n];"showing"===a.mode&&(a.mode="disabled")}};s.ready(function(){s.textTracks().addEventListener("change",c)}),s.on(k.concat(["adtimeout","contentupdate","contentplaying","contentended","contentresumed","adstart","adend","adskip","adsready","adserror","adscanceled","nopreroll"]),r),s.on("dispose",function(){s.textTracks().removeEventListener("change",c)}),s.paused()||r({type:"play"})};return(e.registerPlugin||e.plugin)("ads",P),P});