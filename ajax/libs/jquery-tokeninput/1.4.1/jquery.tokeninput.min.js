!function(e){var t={hintText:"Type in a search term",noResultsText:"No results",searchingText:"Searching...",deleteText:"&times;",searchDelay:300,minChars:1,tokenLimit:null,jsonContainer:null,method:"GET",contentType:"json",queryParam:"q",tokenDelimiter:",",preventDuplicates:!1,prePopulate:null,animateDropdown:!0,onResult:null,onAdd:null,onDelete:null},n={tokenList:"token-input-list",token:"token-input-token",tokenDelete:"token-input-delete-token",selectedToken:"token-input-selected-token",highlightedToken:"token-input-highlighted-token",dropdown:"token-input-dropdown",dropdownItem:"token-input-dropdown-item",dropdownItem2:"token-input-dropdown-item2",selectedDropdownItem:"token-input-selected-dropdown-item",inputToken:"token-input-input-token"},o={BEFORE:0,AFTER:1,END:2},i={BACKSPACE:8,TAB:9,RETURN:13,ESC:27,LEFT:37,UP:38,RIGHT:39,DOWN:40,COMMA:188};e.fn.tokenInput=function(n,o){var i=e.extend({},t,o||{},{url:n});return this.each(function(){new e.TokenList(this,i)})},e.TokenList=function(t,s){function a(e){return e>=48&&e<=90||e>=96&&e<=111||e>=186&&e<=192||e>=219&&e<=222}function l(t,n){var o=e("<li><p>"+n+"</p> </li>").addClass(s.classes.token).insertBefore(N);e("<span>"+s.deleteText+"</span>").addClass(s.classes.tokenDelete).appendTo(o).click(function(){return p(e(this).parent()),!1});var i={id:t,name:n};e.data(o.get(0),"tokeninput",i),E.push(i);var a=e.map(E,function(e){return e.id});return L.val(a.join(s.tokenDelimiter)),x+=1,o}function r(t){var n=e.data(t.get(0),"tokeninput"),o=s.onAdd;if(x>0&&s.preventDuplicates){var i=null;if(b.children().each(function(){var t=e(this),o=e.data(t.get(0),"tokeninput");if(o&&o.id===n.id)return i=t,!1}),i)return u(i),N.insertAfter(i),void A.focus()}if(l(n.id,n.name),null!==s.tokenLimit&&x>=s.tokenLimit)return A.hide(),void f();A.focus(),A.val(""),f(),e.isFunction(o)&&o(n)}function u(e){e.addClass(s.classes.selectedToken),F=e.get(0),A.val(""),f()}function c(e,t){e.removeClass(s.classes.selectedToken),F=null,t===o.BEFORE?N.insertBefore(e):t===o.AFTER?N.insertAfter(e):N.appendTo(b),A.focus()}function d(t){var n=F;F&&c(e(F),o.END),n===t.get(0)?c(t,o.END):u(t)}function p(t){var n=e.data(t.get(0),"tokeninput"),o=s.onDelete;t.remove(),F=null,A.focus(),E=e.grep(E,function(e){return e.id!==n.id});var i=e.map(E,function(e){return e.id});L.val(i.join(s.tokenDelimiter)),x-=1,null!==s.tokenLimit&&A.show().val("").focus(),e.isFunction(o)&&o(n)}function f(){j.hide().empty(),I=null}function h(){s.searchingText&&j.html("<p>"+s.searchingText+"</p>").show()}function k(){s.hintText&&j.html("<p>"+s.hintText+"</p>").show()}function m(e,t){return e.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+t+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>")}function g(t,n){if(n&&n.length){j.empty();var o=e("<ul>").appendTo(j).mouseover(function(t){v(e(t.target).closest("li"))}).mousedown(function(t){return r(e(t.target).closest("li")),!1}).hide();e.each(n,function(n,i){var a=e("<li>"+m(i.name,t)+"</li>").appendTo(o);n%2?a.addClass(s.classes.dropdownItem):a.addClass(s.classes.dropdownItem2),0===n&&v(a),e.data(a.get(0),"tokeninput",{id:i.id,name:i.name})}),j.show(),s.animateDropdown?o.slideDown("fast"):o.show()}else s.noResultsText&&j.html("<p>"+s.noResultsText+"</p>").show()}function v(t){t&&(I&&T(e(I)),t.addClass(s.classes.selectedDropdownItem),I=t.get(0))}function T(e){e.removeClass(s.classes.selectedDropdownItem),I=null}function C(t){var n=A.val().toLowerCase();n&&n.length&&(F&&c(e(F),o.AFTER),n.length>=s.minChars?(h(),t?w(n):(clearTimeout(y),y=setTimeout(function(){w(n)},s.searchDelay))):f())}function w(t){var n=R.get(t);if(n)g(t,n);else{var o={};if(o.data={},s.url.indexOf("?")>-1){var i=s.url.split("?");o.url=i[0];var a=i[1].split("&");e.each(a,function(e,t){var n=t.split("=");o.data[n[0]]=n[1]})}else o.url=s.url;o.data[s.queryParam]=t,o.type=s.method,o.success=function(n){e.isFunction(s.onResult)&&(n=s.onResult.call(this,n)),R.add(t,s.jsonContainer?n[s.jsonContainer]:n),A.val().toLowerCase()===t&&g(t,s.jsonContainer?n[s.jsonContainer]:n)},o.dataType=s.contentType,s.crossDomain&&(o.dataType="jsonp"),e.ajax(o)}}void 0===s.crossDomain&&(s.crossDomain=location.href.split(/\/+/g)[1]!==s.url.split(/\/+/g)[1]),s.classes?s.classes=e.extend({},n,s.classes):s.theme?(s.classes={},e.each(n,function(e,t){s.classes[e]=t+"-"+s.theme})):s.classes=n;var y,D,E=[],x=0,R=new e.TokenList.Cache,A=e('<input type="text"  autocomplete="off">').css({outline:"none"}).focus(function(){null!==s.tokenLimit&&s.tokenLimit===x||k()}).blur(function(){f()}).bind("keyup keydown blur update",function(){if(D!==(D=A.val())){var e=D.replace(/&/g,"&amp;").replace(/\s/g," ").replace(/</g,"&lt;").replace(/>/g,"&gt;");B.html(e),A.width(B.width()+30)}}).keydown(function(t){var n,s;switch(t.keyCode){case i.LEFT:case i.RIGHT:case i.UP:case i.DOWN:if(e(this).val()){var l=null;return(l=t.keyCode===i.DOWN||t.keyCode===i.RIGHT?e(I).next():e(I).prev()).length&&v(l),!1}n=N.prev(),s=N.next(),n.length&&n.get(0)===F||s.length&&s.get(0)===F?t.keyCode===i.LEFT||t.keyCode===i.UP?c(e(F),o.BEFORE):c(e(F),o.AFTER):t.keyCode!==i.LEFT&&t.keyCode!==i.UP||!n.length?t.keyCode!==i.RIGHT&&t.keyCode!==i.DOWN||!s.length||u(e(s.get(0))):u(e(n.get(0)));break;case i.BACKSPACE:if(n=N.prev(),!e(this).val().length)return F?p(e(F)):n.length&&u(e(n.get(0))),!1;1===e(this).val().length?f():setTimeout(function(){C(!1)},5);break;case i.TAB:case i.RETURN:case i.COMMA:if(I)return r(e(I)),!1;break;case i.ESC:return f(),!0;default:a(t.keyCode)&&setTimeout(function(){C(!1)},5)}}),L=e(t).hide().val("").focus(function(){A.focus()}).blur(function(){A.blur()}),F=null,I=null,b=e("<ul />").addClass(s.classes.tokenList).click(function(t){var n=e(t.target).closest("li");n&&n.get(0)&&e.data(n.get(0),"tokeninput")?d(n):(F&&c(e(F),o.END),A.focus())}).mouseover(function(t){var n=e(t.target).closest("li");n&&F!==this&&n.addClass(s.classes.highlightedToken)}).mouseout(function(t){var n=e(t.target).closest("li");n&&F!==this&&n.removeClass(s.classes.highlightedToken)}).insertBefore(L),j=e("<div>").addClass(s.classes.dropdown).insertAfter(b).hide(),N=e("<li />").addClass(s.classes.inputToken).appendTo(b).append(A),B=e("<tester/>").insertAfter(A).css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:A.css("fontSize"),fontFamily:A.css("fontFamily"),fontWeight:A.css("fontWeight"),letterSpacing:A.css("letterSpacing"),whiteSpace:"nowrap"});L.val(""),li_data=s.prePopulate,li_data&&li_data.length&&e.each(li_data,function(e,t){l(t.id,t.name)})},e.TokenList.Cache=function(t){var n=e.extend({max_size:500},t),o={},i=0,s=function(){o={},i=0};this.add=function(e,t){i>n.max_size&&s(),o[e]||(i+=1),o[e]=t},this.get=function(e){return o[e]}}}(jQuery);