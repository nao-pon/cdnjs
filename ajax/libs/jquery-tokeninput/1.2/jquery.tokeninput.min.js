!function(e){e.fn.tokenInput=function(n,t){var o=e.extend({url:n,hintText:"Type in a search term",noResultsText:"No results",searchingText:"Searching...",searchDelay:300,minChars:1,tokenLimit:null,jsonContainer:null,method:"GET",contentType:"json",queryParam:"q",onResult:null,onAdd:null,onDelete:null,crossDomain:!1},t);return o.classes=e.extend({tokenList:"token-input-list",token:"token-input-token",tokenDelete:"token-input-delete-token",selectedToken:"token-input-selected-token",highlightedToken:"token-input-highlighted-token",dropdown:"token-input-dropdown",dropdownItem:"token-input-dropdown-item",dropdownItem2:"token-input-dropdown-item2",selectedDropdownItem:"token-input-selected-dropdown-item",inputToken:"token-input-input-token"},t.classes),this.each(function(){new e.TokenList(this,o)})},e.TokenList=function(n,t){function o(e){return e>=48&&e<=90||e>=96&&e<=111||e>=186&&e<=192||e>=219&&e<=222}function i(n,t){return e(n.target).closest(t)}function s(n,o){var i=e("<li><p>"+o+"</p> </li>").addClass(t.classes.token).insertBefore(O);e("<span>&times;</span>").addClass(t.classes.tokenDelete).appendTo(i).click(function(){return d(e(this).parent()),!1}),e.data(i.get(0),"tokeninput",{id:n,name:o}),D.val("").focus(),c();var s=n+",";return x.val(x.val()+s),y++,i}function a(n){var o=e.data(n.get(0),"tokeninput"),i=(s(o.id,o.name),t.onAdd);null!==t.tokenLimit&&y>=t.tokenLimit&&(D.hide(),c()),e.isFunction(i)&&i(o.id)}function l(e){e.addClass(t.classes.selectedToken),L=e.get(0),D.val(""),c()}function u(e,n){e.removeClass(t.classes.selectedToken),L=null,n===w.BEFORE?O.insertBefore(e):n===w.AFTER?O.insertAfter(e):O.appendTo(F),D.focus()}function r(n){L===n.get(0)?u(n,w.END):(L&&u(e(L),w.END),l(n))}function d(n){var o=e.data(n.get(0),"tokeninput"),i=t.onDelete;n.remove(),L=null,D.focus();var s=x.val(),a=s.indexOf(o.id+","),l=s.indexOf(",",a)+1;l>=s.length?x.val(s.slice(0,a)):x.val(s.slice(0,a)+s.slice(l,s.length)),y--,null!==t.tokenLimit&&D.show().val("").focus(),e.isFunction(i)&&i(o.id)}function c(){I.hide().empty(),A=null}function p(){I.html("<p>"+t.searchingText+"</p>").show()}function f(){I.html("<p>"+t.hintText+"</p>").show()}function h(e,n){return e.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+n+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>")}function k(n,o){if(o&&o.length){I.empty();var s=e("<ul>").appendTo(I).mouseover(function(e){m(i(e,"li"))}).mousedown(function(e){return a(i(e,"li")),!1}).hide();e.each(o,function(o,i){var a=e("<li>"+h(i.name,n)+"</li>").appendTo(s);o%2?a.addClass(t.classes.dropdownItem):a.addClass(t.classes.dropdownItem2),0===o&&m(a),e.data(a.get(0),"tokeninput",{id:i.id,name:i.name})}),I.show(),s.slideDown("fast")}else I.html("<p>"+t.noResultsText+"</p>").show()}function m(n){n&&(A&&T(e(A)),n.addClass(t.classes.selectedDropdownItem),A=n.get(0))}function T(e){e.removeClass(t.classes.selectedDropdownItem),A=null}function g(n){var o=D.val().toLowerCase();o&&o.length&&(L&&u(e(L),w.AFTER),o.length>=t.minChars?(p(),n?v(o):(clearTimeout(C),C=setTimeout(function(){v(o)},t.searchDelay))):c())}function v(n){var o=R.get(n);if(o)k(n,o);else{var i={};if(i.data={},t.url.indexOf("?")>-1){var s=t.url.split("?");i.url=s[0];for(var a=s[1].split("&"),l=0;l<a.length;l++){var u=a[l].split("=");i.data[u[0]]=u[1]}}else i.url=t.url;i.data[t.queryParam]=n,i.type=t.method,i.success=function(o){e.isFunction(t.onResult)&&(o=t.onResult.call(this,o)),R.add(n,t.jsonContainer?o[t.jsonContainer]:o),k(n,t.jsonContainer?o[t.jsonContainer]:o)},i.contentType=t.contentType,t.crossDomain&&(i.dataType="jsonp"),e.ajax(i)}}var C,w={BEFORE:0,AFTER:1,END:2},E={BACKSPACE:8,TAB:9,RETURN:13,ESC:27,LEFT:37,UP:38,RIGHT:39,DOWN:40,COMMA:188},y=0,R=new e.TokenList.Cache,D=e('<input type="text"  autocomplete="off">').css({outline:"none"}).focus(function(){null!==t.tokenLimit&&t.tokenLimit===y||f()}).blur(function(){c()}).keydown(function(n){var t,i;switch(n.keyCode){case E.LEFT:case E.RIGHT:case E.UP:case E.DOWN:if(e(this).val()){var s=null;return(s=n.keyCode===E.DOWN||n.keyCode===E.RIGHT?e(A).next():e(A).prev()).length&&m(s),!1}t=O.prev(),i=O.next(),t.length&&t.get(0)===L||i.length&&i.get(0)===L?n.keyCode===E.LEFT||n.keyCode===E.UP?u(e(L),w.BEFORE):u(e(L),w.AFTER):n.keyCode!==E.LEFT&&n.keyCode!==E.UP||!t.length?n.keyCode!==E.RIGHT&&n.keyCode!==E.DOWN||!i.length||l(e(i.get(0))):l(e(t.get(0)));break;case E.BACKSPACE:if(t=O.prev(),!e(this).val().length)return L?d(e(L)):t.length&&l(e(t.get(0))),!1;1===e(this).val().length?c():setTimeout(function(){g(!1)},5);break;case E.TAB:case E.RETURN:case E.COMMA:if(A)return a(e(A)),!1;break;case E.ESC:return c(),!0;default:o(n.keyCode)&&setTimeout(function(){g(!1)},5)}}),x=e(n).hide().focus(function(){D.focus()}).blur(function(){D.blur()}),L=null,A=null,F=e("<ul />").addClass(t.classes.tokenList).insertBefore(x).click(function(n){var t=i(n,"li");if(t&&t.get(0)!==O.get(0))return r(t),!1;D.focus(),L&&u(e(L),w.END)}).mouseover(function(e){var n=i(e,"li");n&&L!==this&&n.addClass(t.classes.highlightedToken)}).mouseout(function(e){var n=i(e,"li");n&&L!==this&&n.removeClass(t.classes.highlightedToken)}).mousedown(function(e){if(i(e,"li"))return!1}),I=e("<div>").addClass(t.classes.dropdown).insertAfter(F).hide(),O=e("<li />").addClass(t.classes.inputToken).appendTo(F).append(D);x.val(""),li_data=t.prePopulate,li_data&&li_data.length&&e.each(li_data,function(e,n){s(n.id,n.name)})},e.TokenList.Cache=function(n){var t=e.extend({max_size:50},n),o={},i=0,s=function(){o={},i=0};this.add=function(e,n){i>t.max_size&&s(),o[e]||i++,o[e]=n},this.get=function(e){return o[e]}}}(jQuery);