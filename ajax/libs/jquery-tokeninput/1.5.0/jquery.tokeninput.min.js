!function(e){var t={hintText:"Type in a search term",noResultsText:"No results",searchingText:"Searching...",deleteText:"&times;",searchDelay:300,minChars:1,tokenLimit:null,jsonContainer:null,method:"GET",contentType:"json",queryParam:"q",tokenDelimiter:",",preventDuplicates:!1,prePopulate:null,processPrePopulate:!1,animateDropdown:!0,onResult:null,onAdd:null,onDelete:null,idPrefix:"token-input-"},n={tokenList:"token-input-list",token:"token-input-token",tokenDelete:"token-input-delete-token",selectedToken:"token-input-selected-token",highlightedToken:"token-input-highlighted-token",dropdown:"token-input-dropdown",dropdownItem:"token-input-dropdown-item",dropdownItem2:"token-input-dropdown-item2",selectedDropdownItem:"token-input-selected-dropdown-item",inputToken:"token-input-input-token"},o={BEFORE:0,AFTER:1,END:2},i={BACKSPACE:8,TAB:9,ENTER:13,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,NUMPAD_ENTER:108,COMMA:188},s={init:function(n,o){var i=e.extend({},t,o||{});return this.each(function(){e(this).data("tokenInputObject",new e.TokenList(this,n,i))})},clear:function(){return this.data("tokenInputObject").clear(),this},add:function(e){return this.data("tokenInputObject").add(e),this},remove:function(e){return this.data("tokenInputObject").remove(e),this}};e.fn.tokenInput=function(e){return s[e]?s[e].apply(this,Array.prototype.slice.call(arguments,1)):s.init.apply(this,arguments)},e.TokenList=function(t,s,a){function l(){if(null!==a.tokenLimit&&R>=a.tokenLimit)return L.hide(),void h();L.focus()}function r(t){var n=e("<li><p>"+t.name+"</p></li>").addClass(a.classes.token).insertBefore(I);e("<span>"+a.deleteText+"</span>").addClass(a.classes.tokenDelete).appendTo(n).click(function(){return f(e(this).parent()),!1});var o={id:t.id,name:t.name};e.data(n.get(0),"tokeninput",t),A=A.slice(0,O).concat([o]).concat(A.slice(O)),O++;var i=e.map(A,function(e){return e.id});return b.val(i.join(a.tokenDelimiter)),R+=1,n}function c(t){var n=a.onAdd;if(R>0&&a.preventDuplicates){var o=null;if(j.children().each(function(){var n=e(this),i=e.data(n.get(0),"tokeninput");if(i&&i.id===t.id)return o=n,!1}),o)return u(o),I.insertAfter(o),void L.focus()}r(t),l(),L.val(""),h(),e.isFunction(n)&&n.call(b,t)}function u(e){e.addClass(a.classes.selectedToken),F=e.get(0),L.val(""),h()}function d(e,t){e.removeClass(a.classes.selectedToken),F=null,t===o.BEFORE?(I.insertBefore(e),O--):t===o.AFTER?(I.insertAfter(e),O++):(I.appendTo(j),O=R),L.focus()}function p(t){var n=F;F&&d(e(F),o.END),n===t.get(0)?d(t,o.END):u(t)}function f(t){var n=e.data(t.get(0),"tokeninput"),o=a.onDelete,i=t.prevAll().length;i>O&&i--,t.remove(),F=null,L.focus(),A=A.slice(0,i).concat(A.slice(i+1)),i<O&&O--;var s=e.map(A,function(e){return e.id});b.val(s.join(a.tokenDelimiter)),R-=1,null!==a.tokenLimit&&L.show().val("").focus(),e.isFunction(o)&&o.call(b,n)}function h(){S.hide().empty(),N=null}function k(){S.css({position:"absolute",top:e(j).offset().top+e(j).outerHeight(),left:e(j).offset().left,zindex:999}).show()}function m(){a.searchingText&&(S.html("<p>"+a.searchingText+"</p>"),k())}function g(){a.hintText&&(S.html("<p>"+a.hintText+"</p>"),k())}function v(e,t){return e.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+t+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>")}function T(t,n){if(n&&n.length){S.empty();var o=e("<ul>").appendTo(S).mouseover(function(t){C(e(t.target).closest("li"))}).mousedown(function(t){return c(e(t.target).closest("li").data("tokeninput")),!1}).hide();e.each(n,function(n,i){var s=e("<li>"+v(i.name,t)+"</li>").appendTo(o);n%2?s.addClass(a.classes.dropdownItem):s.addClass(a.classes.dropdownItem2),0===n&&C(s),e.data(s.get(0),"tokeninput",i)}),k(),a.animateDropdown?o.slideDown("fast"):o.show()}else a.noResultsText&&(S.html("<p>"+a.noResultsText+"</p>"),k())}function C(t){t&&(N&&E(e(N)),t.addClass(a.classes.selectedDropdownItem),N=t.get(0))}function E(e){e.removeClass(a.classes.selectedDropdownItem),N=null}function w(){var t=L.val().toLowerCase();t&&t.length&&(F&&d(e(F),o.AFTER),t.length>=a.minChars?(m(),clearTimeout(D),D=setTimeout(function(){y(t)},a.searchDelay)):h())}function y(t){var n=P.get(t);if(n)T(t,n);else if(a.url){var o={};if(o.data={},a.url.indexOf("?")>-1){var i=a.url.split("?");o.url=i[0];var s=i[1].split("&");e.each(s,function(e,t){var n=t.split("=");o.data[n[0]]=n[1]})}else o.url=a.url;o.data[a.queryParam]=t,o.type=a.method,o.dataType=a.contentType,a.crossDomain&&(o.dataType="jsonp"),o.success=function(n){e.isFunction(a.onResult)&&(n=a.onResult.call(b,n)),P.add(t,a.jsonContainer?n[a.jsonContainer]:n),L.val().toLowerCase()===t&&T(t,a.jsonContainer?n[a.jsonContainer]:n)},e.ajax(o)}else if(a.local_data){var l=e.grep(a.local_data,function(e){return e.name.toLowerCase().indexOf(t.toLowerCase())>-1});e.isFunction(a.onResult)&&(l=a.onResult.call(b,l)),P.add(t,l),T(t,l)}}"string"==typeof s?(a.url=s,void 0===a.crossDomain&&(-1===a.url.indexOf("://")?a.crossDomain=!1:a.crossDomain=location.href.split(/\/+/g)[1]!==a.url.split(/\/+/g)[1])):"object"==typeof s&&(a.local_data=s),a.classes?a.classes=e.extend({},n,a.classes):a.theme?(a.classes={},e.each(n,function(e,t){a.classes[e]=t+"-"+a.theme})):a.classes=n;var D,x,A=[],R=0,P=new e.TokenList.Cache,L=e('<input type="text"  autocomplete="off">').css({outline:"none"}).attr("id",a.idPrefix+t.id).focus(function(){null!==a.tokenLimit&&a.tokenLimit===R||g()}).blur(function(){h(),e(this).val("")}).bind("keyup keydown blur update",function(){if(x!==(x=L.val())){var e=x.replace(/&/g,"&amp;").replace(/\s/g," ").replace(/</g,"&lt;").replace(/>/g,"&gt;");B.html(e),L.width(B.width()+30)}}).keydown(function(t){var n,s;switch(t.keyCode){case i.LEFT:case i.RIGHT:case i.UP:case i.DOWN:if(e(this).val()){var a=null;return(a=t.keyCode===i.DOWN||t.keyCode===i.RIGHT?e(N).next():e(N).prev()).length&&C(a),!1}n=I.prev(),s=I.next(),n.length&&n.get(0)===F||s.length&&s.get(0)===F?t.keyCode===i.LEFT||t.keyCode===i.UP?d(e(F),o.BEFORE):d(e(F),o.AFTER):t.keyCode!==i.LEFT&&t.keyCode!==i.UP||!n.length?t.keyCode!==i.RIGHT&&t.keyCode!==i.DOWN||!s.length||u(e(s.get(0))):u(e(n.get(0)));break;case i.BACKSPACE:if(n=I.prev(),!e(this).val().length)return F?f(e(F)):n.length&&u(e(n.get(0))),!1;1===e(this).val().length?h():setTimeout(function(){w()},5);break;case i.TAB:case i.ENTER:case i.NUMPAD_ENTER:case i.COMMA:if(N)return c(e(N).data("tokeninput")),!1;break;case i.ESCAPE:return h(),!0;default:String.fromCharCode(t.which)&&setTimeout(function(){w()},5)}}),b=e(t).hide().val("").focus(function(){L.focus()}).blur(function(){L.blur()}),F=null,O=0,N=null,j=e("<ul />").addClass(a.classes.tokenList).click(function(t){var n=e(t.target).closest("li");n&&n.get(0)&&e.data(n.get(0),"tokeninput")?p(n):(F&&d(e(F),o.END),L.focus())}).mouseover(function(t){var n=e(t.target).closest("li");n&&F!==this&&n.addClass(a.classes.highlightedToken)}).mouseout(function(t){var n=e(t.target).closest("li");n&&F!==this&&n.removeClass(a.classes.highlightedToken)}).insertBefore(b),I=e("<li />").addClass(a.classes.inputToken).appendTo(j).append(L),S=e("<div>").addClass(a.classes.dropdown).appendTo("body").hide(),B=e("<tester/>").insertAfter(L).css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:L.css("fontSize"),fontFamily:L.css("fontFamily"),fontWeight:L.css("fontWeight"),letterSpacing:L.css("letterSpacing"),whiteSpace:"nowrap"});b.val("");var _=a.prePopulate||b.data("pre");a.processPrePopulate&&e.isFunction(a.onResult)&&(_=a.onResult.call(b,_)),_&&_.length&&e.each(_,function(e,t){r(t),l()}),this.clear=function(){j.children("li").each(function(){0===e(this).children("input").length&&f(e(this))})},this.add=function(e){c(e)},this.remove=function(t){j.children("li").each(function(){if(0===e(this).children("input").length){var n=e(this).data("tokeninput"),o=!0;for(var i in t)if(t[i]!==n[i]){o=!1;break}o&&f(e(this))}})}},e.TokenList.Cache=function(t){var n=e.extend({max_size:500},t),o={},i=0,s=function(){o={},i=0};this.add=function(e,t){i>n.max_size&&s(),o[e]||(i+=1),o[e]=t},this.get=function(e){return o[e]}}}(jQuery);