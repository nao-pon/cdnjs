!function(e){"use strict";function t(s){var n={name:s.contents().eq(0).text().trim(),relationship:(s.parent().parent().is("li")?"1":"0")+(s.siblings("li").length?1:0)+(s.children("ul").length?1:0)};return s[0].id&&(n.id=s[0].id),s.children("ul").children().each(function(){n.children||(n.children=[]),n.children.push(t(e(this)))}),n}function s(e,t){return e.relationship=t+(e.children?1:0),e.children&&e.children.forEach(function(t){s(t,"1"+(e.children.length>1?1:0))}),e}function n(t){var s=t.find("tr:first"),i={id:s.find(".node")[0].id};return s.siblings(":last").children().each(function(){i.children||(i.children=[]),i.children.push(n(e(this)))}),i}function i(e,t){var s={};return(s="parent"===t?e.closest("table").closest("tr").siblings(":first").find(".node"):"children"===t?e.closest("tr").siblings():e.closest("table").parent().siblings()).length?s.is(":visible")?{exist:!0,visible:!0}:{exist:!0,visible:!1}:{exist:!1,visible:!1}}function l(e){var t=e.closest("table").closest("tr").siblings();t.eq(0).find(".spinner").length&&e.closest(".orgchart").data("inAjax",!1),i(e,"siblings").visible&&r(e);var s=t.slice(1);s.css("visibility","hidden");var n=t.eq(0).find(".node"),a=i(n,"parent").visible;n.length&&n.is(":visible")&&n.addClass("slide slide-down").one("transitionend",function(){n.removeClass("slide"),s.removeAttr("style"),t.addClass("hidden")}),n.length&&a&&l(n)}function a(t){var s=t.closest("table").closest("tr").siblings().removeClass("hidden");s.eq(2).children().slice(1,-1).addClass("hidden");var n=s.eq(0).find(".node")[0];v(n),e(n).addClass("slide").removeClass("slide-down").one("transitionend",function(){e(n).removeClass("slide"),f(t)&&p(t.children(".topEdge"))})}function d(e){var t=e.closest("tr").siblings().removeClass("hidden").eq(2).children().find("tr:first").find(".node:visible");v(t.get(0)),t.addClass("slide").removeClass("slide-up").eq(0).one("transitionend",function(){t.removeClass("slide"),f(e)&&p(e.children(".bottomEdge"))})}function r(e){var t=e.closest("table").parent();t.siblings().find(".spinner").length&&e.closest(".orgchart").data("inAjax",!1),t.prevAll().find(".node:visible").addClass("slide slide-right"),t.nextAll().find(".node:visible").addClass("slide slide-left");var s=t.siblings().find(".slide"),n=s.closest(".nodes").prevAll(".lines").css("visibility","hidden");s.eq(0).one("transitionend",function(){n.removeAttr("style"),t.closest(".nodes").prev().children().slice(1,-1).addClass("hidden"),s.removeClass("slide"),t.siblings().find(".node:visible:gt(0)").removeClass("slide-left slide-right").addClass("slide-up"),t.siblings().find(".lines, .nodes").addClass("hidden"),t.siblings().addClass("hidden"),f(e)&&g(e,!0)})}function o(t){var s=t.closest("table").parent().siblings().removeClass("hidden"),n=t.closest("table").closest("tr").siblings();if(n.eq(2).children().slice(1,-1).removeClass("hidden"),!i(t,"parent").visible){n.removeClass("hidden");var l=n.find(".node")[0];v(l),e(l).addClass("slide").removeClass("slide-down").one("transitionend",function(){e(this).removeClass("slide")})}s.find(".node:visible").addClass("slide").removeClass("slide-left slide-right").eq(-1).one("transitionend",function(){s.find(".node:visible").removeClass("slide"),f(t)&&function(e){g(e,!1),e.children(".topEdge").removeClass("fa-chevron-up").addClass("fa-chevron-down")}(t)})}function c(t,s,n){var i=s.closest(".orgchart");return(void 0===i.data("inAjax")||!0!==i.data("inAjax"))&&(t.addClass("hidden"),s.append('<i class="fa fa-circle-o-notch fa-spin spinner"></i>'),s.children().not(".spinner").css("opacity",.2),i.data("inAjax",!0),e(".oc-export-btn"+(""!==n.chartClass?"."+n.chartClass:"")).prop("disabled",!0),!0)}function h(t,s,n){var i=s.closest("div.orgchart");t.removeClass("hidden"),s.find(".spinner").remove(),s.children().removeAttr("style"),i.data("inAjax",!1),e(".oc-export-btn"+(""!==n.chartClass?"."+n.chartClass:"")).prop("disabled",!1)}function f(e){return e.children(".edge").attr("class").indexOf("fa-")>-1}function p(e){e.toggleClass("fa-chevron-up").toggleClass("fa-chevron-down")}function g(e,t){e.children(".leftEdge").toggleClass("fa-chevron-right",!t).toggleClass("fa-chevron-left",t),e.children(".rightEdge").toggleClass("fa-chevron-left",!t).toggleClass("fa-chevron-right",t)}function v(e){e.style.offsetWidth=e.offsetWidth}function b(t,s,n){var v=e.Deferred(),b=e("<div"+(n.draggable?' draggable="true"':"")+">",{id:t[n.nodeId]}).addClass("node"+(s>=n.depth?" slide-up":"")).append('<div class="title">'+t[n.nodeTitle]+"</div>").append(void 0!==n.nodeContent?'<div class="content">'+t[n.nodeContent]+"</div>":""),u=t.relationship;return Number(u.substr(0,1))&&b.append('<i class="edge verticalEdge topEdge fa"></i>'),Number(u.substr(1,1))&&b.append('<i class="edge horizontalEdge rightEdge fa"></i><i class="edge horizontalEdge leftEdge fa"></i>'),Number(u.substr(2,1))&&b.append('<i class="edge verticalEdge bottomEdge fa"></i>').children(".title").prepend('<i class="fa '+n.parentNodeSymbol+' symbol"></i>'),b.on("mouseenter mouseleave",function(t){var s=e(this),n=!1,l=s.children(".topEdge"),a=(s.children(".rightEdge"),s.children(".bottomEdge")),d=s.children(".leftEdge");"mouseenter"===t.type?(l.length&&(n=i(s,"parent").visible,l.toggleClass("fa-chevron-up",!n).toggleClass("fa-chevron-down",n)),a.length&&(n=i(s,"children").visible,a.toggleClass("fa-chevron-down",!n).toggleClass("fa-chevron-up",n)),d.length&&g(s,!i(s,"siblings").visible)):s.children(".edge").removeClass("fa-chevron-up fa-chevron-down fa-chevron-right fa-chevron-left")}),b.on("click",function(t){e(this).closest(".orgchart").find(".focused").removeClass("focused"),e(this).addClass("focused")}),b.on("click",".topEdge",function(t){var s=e(this),d=s.parent(),r=i(d,"parent");if(r.exist){var o=d.closest("table").closest("tr").siblings(":first").find(".node");if(o.is(".slide"))return;r.visible?(l(d),o.one("transitionend",function(){f(d)&&(p(s),g(d,!0))})):a(d)}else{var v=s.parent()[0].id;c(s,d,n)&&e.ajax({url:n.ajaxURL.parent+v+"/"}).done(function(t){d.closest("div.orgchart").data("inAjax")&&(e.isEmptyObject(t)||E.call(d.closest(".orgchart").parent(),t,n))}).fail(function(){console.log("Failed to get parent node data")}).always(function(){h(s,d,n)})}}),b.on("click",".bottomEdge",function(t){var s=e(this),l=s.parent(),a=i(l,"children");if(a.exist){if(l.closest("tr").siblings(":last").find(".node:visible").is(".slide"))return;a.visible?function(e){var t=e.closest("tr").siblings();t.last().find(".spinner").length&&e.closest(".orgchart").data("inAjax",!1);var s=t.last().find(".node:visible"),n=s.closest("table").closest("tr").prevAll(".lines").css("visibility","hidden");s.addClass("slide slide-up").eq(0).one("transitionend",function(){s.removeClass("slide"),n.removeAttr("style").addClass("hidden").siblings(".nodes").addClass("hidden"),f(e)&&p(e.children(".bottomEdge"))})}(l):d(l)}else{var r=s.parent()[0].id;c(s,l,n)&&e.ajax({url:n.ajaxURL.children+r+"/"}).done(function(t,s,i){l.closest(".orgchart").data("inAjax")&&t.children.length&&m(l,t,e.extend({},n,{depth:0}))}).fail(function(e,t,s){console.log("Failed to get children nodes data")}).always(function(){h(s,l,n)})}}),b.on("click",".leftEdge, .rightEdge",function(t){var s=e(this),l=s.parent(),a=i(l,"siblings");if(a.exist){if(l.closest("table").parent().siblings().find(".node:visible").is(".slide"))return;a.visible?r(l):o(l)}else{var d=s.parent()[0].id,f=i(l,"parent").exist?n.ajaxURL.siblings:n.ajaxURL.families;c(s,l,n)&&e.ajax({url:f+d+"/"}).done(function(e,t,s){l.closest(".orgchart").data("inAjax")&&(e.siblings||e.children)&&y(l,e,n)}).fail(function(e,t,s){console.log("Failed to get sibling nodes data")}).always(function(){h(s,l,n)})}}),b.children(".leftEdge").on("mouseenter mouseleave",function(t){if("mouseenter"===t.type){var s=e(this).siblings(".rightEdge");i(e(this),"siblings").visible?s.addClass("rightEdgeMoveLeft"):s.addClass("rightEdgeMoveRight")}else e(this).siblings(".rightEdge").removeClass("rightEdgeMoveRight rightEdgeMoveLeft")}),n.draggable&&b.on("dragstart",function(t){t.originalEvent.dataTransfer.setData("text/html","hack for firefox");var s=e(this),n=s.closest("table").find(".node");s.closest(".orgchart").data("dragged",s).find(".node").each(function(t,s){-1===n.index(s)&&e(s).addClass("allowedDrop")})}).on("dragover",function(t){t.preventDefault();var s=e(this);s.closest(".orgchart").data("dragged").closest("table").find(".node").index(s)>-1&&(t.originalEvent.dataTransfer.dropEffect="none")}).on("dragend",function(t){e(this).closest(".orgchart").find(".allowedDrop").removeClass("allowedDrop")}).on("drop",function(t){var s=e(this),n=s.closest(".orgchart"),i=n.data("dragged");n.find(".allowedDrop").removeClass("allowedDrop");var l=i.closest(".nodes").siblings().eq(0).children();if(s.closest("tr").siblings().length){var a=parseInt(s.parent().attr("colspan"))+2,d='<i class="edge horizontalEdge rightEdge fa"></i><i class="edge horizontalEdge leftEdge fa"></i>';s.closest("tr").next().addBack().children().attr("colspan",a),i.find(".horizontalEdge").length||i.append(d),s.closest("tr").siblings().eq(1).children(":last").before('<td class="left top">&nbsp;</td><td class="right top">&nbsp;</td>').end().next().append(i.closest("table").parent());var r=i.closest("table").parent().siblings().find(".node:first");1===r.length&&r.append(d)}else s.append('<i class="edge verticalEdge bottomEdge fa"></i>').parent().attr("colspan",2).parent().after('<tr class="lines"><td colspan="2"><div class="down"></div></td></tr><tr class="lines"><td class="right">&nbsp;</td><td class="left">&nbsp;</td></tr><tr class="nodes"></tr>').siblings(":last").append(i.find(".horizontalEdge").remove().end().closest("table").parent());var o=parseInt(l.attr("colspan"));if(o>2){l.attr("colspan",o-2).parent().next().children().attr("colspan",o-2).end().next().children().slice(1,3).remove();var c=l.parent().siblings(".nodes").children().find(".node:first");1===c.length&&c.find(".horizontalEdge").remove()}else l.removeAttr("colspan").find(".bottomEdge").remove().end().end().siblings().remove()}),n.createNode&&n.createNode(b,t),v.resolve(b),v.promise()}function u(t,s,n,i,l){var a,d=s[i.nodeChildren],r=!!d&&d.length;if(Object.keys(s).length>1&&(a=e("<table>"),t.append(a),e.when(b(s,n,i)).done(function(e){a.append(e.wrap("<tr><td"+(r?' colspan="'+2*d.length+'"':"")+"></td></tr>").closest("tr")),l&&l()}).fail(function(){console.log("Failed to creat node")})),r){1===Object.keys(s).length&&(a=t);var o=n+1>=i.depth?" hidden":"";a.append('<tr class="lines'+o+'"><td colspan="'+2*d.length+'"><div class="down"></div></td></tr>');for(var c='<tr class="lines'+o+'"><td class="right">&nbsp;</td>',h=1;h<d.length;h++)c+='<td class="left top">&nbsp;</td><td class="right top">&nbsp;</td>';c+='<td class="left">&nbsp;</td></tr>',a.append(c);var f=e('<tr class="nodes'+o+'">');a.append(f),e.each(d,function(){var t=e('<td colspan="2">');f.append(t),u(t,this,n+1,i,l)})}}function C(e,t,s,n){var s=s||this.data("orgchart").options,i=t.children||t.siblings;e.find("td:first").attr("colspan",2*i.length),u(e,{children:i},0,s,n)}function m(e,t,s){var n=0;C.call(e.closest(".orgchart").parent(),e.closest("table"),t,s,function(){++n===t.children.length&&(e.children(".bottomEdge").length||e.append('<i class="edge verticalEdge bottomEdge fa"></i>'),e.find(".symbol").length||e.children(".title").prepend('<i class="fa '+s.parentNodeSymbol+' symbol"></i>'),d(e))})}function E(t,s){var n=this.find(".node:first");(function(t,s,n){var i=this,l=e("<table>");t.relationship="001",e.when(b(t,0,s||this.data("orgchart").options)).done(function(e){l.append(e.removeClass("slide-up").addClass("slide-down").wrap('<tr class="hidden"><td colspan="2"></td></tr>').closest("tr")),l.append('<tr class="lines hidden"><td colspan="2"><div class="down"></div></td></tr>'),l.append('<tr class="lines hidden"><td class="right">&nbsp;</td><td class="left">&nbsp;</td></tr>');var t=i.children(".orgchart");t.prepend(l).children("table:first").append('<tr class="nodes"><td colspan="2"></td></tr>').children().children("tr:last").children().append(t.children("table").last()),n()}).fail(function(){console.log("Failed to create parent node")})}).call(this,t,s,function(){n.children(".topEdge").length||n.children(".title").after('<i class="edge verticalEdge topEdge fa"></i>'),a(n)})}function x(e,t,s){for(var n="",i=0;i<s;i++)n+='<td class="left top">&nbsp;</td><td class="right top">&nbsp;</td>';e.parent().prevAll("tr:gt(0)").children().attr("colspan",2*t).end().next().children(":first").after(n)}function y(t,s,n){(function(t,s,n,i){var n=n||this.data("orgchart").options,l=s.siblings?s.siblings.length:s.children.length,a=t.parent().is("td")?t.closest("tr").children().length:1,d=a+l,r=d>1?Math.floor(d/2-1):0;if(t.parent().is("td")){t.closest("tr").prevAll("tr:last"),t.closest("tr").prevAll("tr:lt(2)").remove();var o=0;C.call(t.closest(".orgchart").parent(),t.parent().closest("table"),s,n,function(){if(++o===l){var e=t.parent().closest("table").children().children("tr:last").children("td");a>1?(x(e.eq(0).before(t.closest("td").siblings().andSelf().unwrap()),d,a),e.addClass("hidden").find(".node").addClass("slide-left")):(x(e.eq(r).after(t.closest("td").unwrap()),d,1),e.not(":eq("+r+"1)").addClass("hidden").slice(0,r).find(".node").addClass("slide-right").end().end().slice(r).find(".node").addClass("slide-left")),i()}})}else{var c=0;u(t.closest(".orgchart"),s,0,n,function(){++c===d&&(x(t.next().children().children("tr:last").children().eq(r).after(e('<td colspan="2">').append(t)),d,1),t.closest("tr").siblings().eq(0).addClass("hidden").find(".node").addClass("slide-down"),t.parent().siblings().addClass("hidden").slice(0,r).find(".node").addClass("slide-right").end().end().slice(r).find(".node").addClass("slide-left"),i())})}}).call(t.closest(".orgchart").parent(),t.closest("table"),s,n,function(){t.children(".leftEdge").length||t.children(".topEdge").after('<i class="edge horizontalEdge rightEdge fa"></i><i class="edge horizontalEdge leftEdge fa"></i>'),o(t)})}e.fn.orgchart=function(l){switch(l){case"buildHierarchy":return u.apply(this,Array.prototype.splice.call(arguments,1));case"addChildren":return m.apply(this,Array.prototype.splice.call(arguments,1));case"addParent":return E.apply(this,Array.prototype.splice.call(arguments,1));case"addSiblings":return y.apply(this,Array.prototype.splice.call(arguments,1));case"removeNodes":return function(e){var t=e.closest("table").parent(),s=t.parent().siblings();t.is("td")?i(e,"siblings").exist?(s.eq(2).children(".top:lt(2)").remove(),s.eq(":lt(2)").children().attr("colspan",s.eq(2).children().length),t.remove()):s.eq(0).children().removeAttr("colspan").find(".bottomEdge").remove().end().end().siblings().remove():t.add(t.siblings()).remove()}.apply(this,Array.prototype.splice.call(arguments,1));case"getHierarchy":return e(this).find(".node:first")[0].id?n.apply(this,[e(this)]):"Error: Nodes of orghcart to be exported must have id attribute!";default:var a=e.extend({nodeTitle:"name",nodeId:"id",nodeChildren:"children",depth:999,chartClass:"",exportButton:!1,exportFilename:"OrgChart",parentNodeSymbol:"fa-users",draggable:!1},l);this.data("orgchart",{options:a})}var d=this,r=a.data,o=e("<div>",{class:"orgchart"+(""!==a.chartClass?" "+a.chartClass:""),click:function(t){e(t.target).closest(".node").length||o.find(".node.focused").removeClass("focused")}});if("object"===e.type(r)?r instanceof e?u(o,t(r.children()),0,a):u(o,a.ajaxURL?r:s(r,"00"),0,a):e.ajax({url:r,beforeSend:function(){o.append('<i class="fa fa-circle-o-notch fa-spin spinner"></i>')}}).done(function(e,t,n){u(o,a.ajaxURL?e:s(e,"00"),0,a)}).fail(function(e,t,s){console.log(s)}).always(function(){o.children(".spinner").remove()}),d.append(o),a.exportButton){var c=e("<button>",{class:"oc-export-btn"+(""!==a.chartClass?" "+a.chartClass:""),text:"Export",click:function(){if(e(this).children(".spinner").length)return!1;var t=d.find(".mask");t.length?t.removeClass("hidden"):d.append('<div class="mask"><i class="fa fa-circle-o-notch fa-spin spinner"></i></div>'),html2canvas(o[0],{onrendered:function(e){d.find(".mask").addClass("hidden").end().find(".oc-download-btn").attr("href",e.toDataURL())[0].click()}})}}),h='<a class="oc-download-btn'+(""!==a.chartClass?" "+a.chartClass:"")+'" download="'+a.exportFilename+'.png"></a>';d.append(c).append(h)}return d}}(jQuery);