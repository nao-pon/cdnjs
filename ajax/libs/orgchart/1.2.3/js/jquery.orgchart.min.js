"use strict";!function(e){"object"==typeof module&&"object"==typeof module.exports?e(require("jquery"),window,document):e(jQuery,window,document)}(function(e,t,s,n){function i(e){return Math.sqrt((e.touches[0].clientX-e.touches[1].clientX)*(e.touches[0].clientX-e.touches[1].clientX)+(e.touches[0].clientY-e.touches[1].clientY)*(e.touches[0].clientY-e.touches[1].clientY))}function a(e,t){var s=e.css("transform");"none"===s?e.css("transform","scale("+t+","+t+")"):-1===s.indexOf("3d")?e.css("transform",s+" scale("+t+","+t+")"):e.css("transform",s+" scale3d("+t+","+t+", 1)")}function l(t){var s={name:t.contents().eq(0).text().trim(),relationship:(t.parent().parent().is("li")?"1":"0")+(t.siblings("li").length?1:0)+(t.children("ul").length?1:0)};return t[0].id&&(s.id=t[0].id),t.children("ul").children().each(function(){s.children||(s.children=[]),s.children.push(l(e(this)))}),s}function d(e,t){return e.relationship=t+(e.children&&e.children.length>0?1:0),e.children&&e.children.forEach(function(t){d(t,"1"+(e.children.length>1?1:0))}),e}function r(t){var s=t.find("tr:first"),n={id:s.find(".node")[0].id};return s.siblings(":last").children().each(function(){n.children||(n.children=[]),n.children.push(r(e(this)))}),n}function o(t){return(t=t||e(this).find(".orgchart")).find(".node:first")[0].id?r(t):"Error: Nodes of orghcart to be exported must have id attribute!"}function c(e,t){var s={};return(s="parent"===t?e.closest("table").closest("tr").siblings(":first").find(".node"):"children"===t?e.closest("tr").siblings():e.closest("table").parent().siblings()).length?s.is(":visible")?{exist:!0,visible:!0}:{exist:!0,visible:!1}:{exist:!1,visible:!1}}function h(e){var t=e.closest("table").closest("tr").siblings();t.eq(0).find(".spinner").length&&e.closest(".orgchart").data("inAjax",!1),c(e,"siblings").visible&&p(e);var s=t.slice(1);s.css("visibility","hidden");var n=t.eq(0).find(".node"),i=c(n,"parent").visible;n.length&&n.is(":visible")&&n.addClass("slide slide-down").one("transitionend",function(){n.removeClass("slide"),s.removeAttr("style"),t.addClass("hidden")}),n.length&&i&&h(n)}function f(t){var s=t.closest("table").closest("tr").siblings().removeClass("hidden");s.eq(2).children().slice(1,-1).addClass("hidden");var n=s.eq(0).find(".node")[0];E(n),e(n).addClass("slide").removeClass("slide-down").one("transitionend",function(){e(n).removeClass("slide"),m(t)&&C(t.children(".topEdge"))})}function g(e){var t=e.closest("tr").siblings(),s=!!t.is(".verticalNodes")?t.removeClass("hidden").find(".node:visible"):t.removeClass("hidden").eq(2).children().find("tr:first").find(".node:visible");E(s.get(0)),s.addClass("slide").removeClass("slide-up").eq(0).one("transitionend",function(){s.removeClass("slide"),m(e)&&C(e.children(".bottomEdge"))})}function p(e,t){var s=e.closest("table").parent();s.siblings().find(".spinner").length&&e.closest(".orgchart").data("inAjax",!1),t?"left"===t?s.prevAll().find(".node:visible").addClass("slide slide-right"):s.nextAll().find(".node:visible").addClass("slide slide-left"):(s.prevAll().find(".node:visible").addClass("slide slide-right"),s.nextAll().find(".node:visible").addClass("slide slide-left"));var n=s.siblings().find(".slide"),i=n.closest(".nodes").prevAll(".lines").css("visibility","hidden");n.eq(0).one("transitionend",function(){i.removeAttr("style");var a=t?"left"===t?s.prevAll(":not(.hidden)"):s.nextAll(":not(.hidden)"):s.siblings();s.closest(".nodes").prev().children(":not(.hidden)").slice(1,t?2*a.length+1:-1).addClass("hidden"),n.removeClass("slide"),a.find(".node:visible:gt(0)").removeClass("slide-left slide-right").addClass("slide-up").end().find(".lines, .nodes, .verticalNodes").addClass("hidden").end().addClass("hidden"),m(e)&&x(e)})}function v(t,s){var n=e();n=s?"left"===s?t.closest("table").parent().prevAll().removeClass("hidden"):t.closest("table").parent().nextAll().removeClass("hidden"):t.closest("table").parent().siblings().removeClass("hidden");var i=t.closest("table").closest("tr").siblings();if(s?i.eq(2).children(".hidden").slice(0,2*n.length).removeClass("hidden"):i.eq(2).children(".hidden").removeClass("hidden"),!c(t,"parent").visible){i.removeClass("hidden");var a=i.find(".node")[0];E(a),e(a).addClass("slide").removeClass("slide-down").one("transitionend",function(){e(this).removeClass("slide")})}n.find(".node:visible").addClass("slide").removeClass("slide-left slide-right").eq(-1).one("transitionend",function(){n.find(".node:visible").removeClass("slide"),m(t)&&(x(t),t.children(".topEdge").removeClass("fa-chevron-up").addClass("fa-chevron-down"))})}function u(t,s,n){var i=s.closest(".orgchart");return(void 0===i.data("inAjax")||!0!==i.data("inAjax"))&&(t.addClass("hidden"),s.append('<i class="fa fa-circle-o-notch fa-spin spinner"></i>'),s.children().not(".spinner").css("opacity",.2),i.data("inAjax",!0),e(".oc-export-btn"+(""!==n.chartClass?"."+n.chartClass:"")).prop("disabled",!0),!0)}function b(t,s,n){var i=s.closest("div.orgchart");t.removeClass("hidden"),s.find(".spinner").remove(),s.children().removeAttr("style"),i.data("inAjax",!1),e(".oc-export-btn"+(""!==n.chartClass?"."+n.chartClass:"")).prop("disabled",!1)}function m(e){return e.children(".edge").attr("class").indexOf("fa-")>-1}function C(e){e.toggleClass("fa-chevron-up").toggleClass("fa-chevron-down")}function x(e){var t=e.closest(".orgchart").data("options");if(t.toggleSiblingsResp&&(void 0===t.ajaxURL||e.closest(".nodes").data("siblingsLoaded"))){var s=e.closest("table").parent().prev();s.length&&(s.is(".hidden")?e.children(".leftEdge").addClass("fa-chevron-left").removeClass("fa-chevron-right"):e.children(".leftEdge").addClass("fa-chevron-right").removeClass("fa-chevron-left"));var n=e.closest("table").parent().next();n.length&&(n.is(".hidden")?e.children(".rightEdge").addClass("fa-chevron-right").removeClass("fa-chevron-left"):e.children(".rightEdge").addClass("fa-chevron-left").removeClass("fa-chevron-right"))}else{var i=e.closest("table").parent().siblings(),a=!!i.length&&!i.is(".hidden");e.children(".leftEdge").toggleClass("fa-chevron-right",a).toggleClass("fa-chevron-left",!a),e.children(".rightEdge").toggleClass("fa-chevron-left",a).toggleClass("fa-chevron-right",!a)}}function E(e){e&&(e.style.offsetWidth=e.offsetWidth)}function y(n,i,a){var l=e.Deferred(),d=e("<div"+(a.draggable?' draggable="true"':"")+(n[a.nodeId]?' id="'+n[a.nodeId]+'"':"")+">").addClass("node "+(n.className||"")+(i>=a.depth?" slide-up":"")).append('<div class="title">'+n[a.nodeTitle]+"</div>").append(void 0!==a.nodeContent?'<div class="content">'+(n[a.nodeContent]||"")+"</div>":""),r=n.relationship||"";return a.verticalDepth&&i+2>a.verticalDepth?i+1>=a.verticalDepth&&Number(r.substr(2,1))&&d.append('<i class="toggleBtn fa fa-minus-square"></i>'):(Number(r.substr(0,1))&&d.append('<i class="edge verticalEdge topEdge fa"></i>'),Number(r.substr(1,1))&&d.append('<i class="edge horizontalEdge rightEdge fa"></i><i class="edge horizontalEdge leftEdge fa"></i>'),Number(r.substr(2,1))&&d.append('<i class="edge verticalEdge bottomEdge fa"></i>').children(".title").prepend('<i class="fa '+a.parentNodeSymbol+' symbol"></i>')),d.on("mouseenter mouseleave",function(t){var s=e(this),n=!1,i=s.children(".topEdge"),a=(s.children(".rightEdge"),s.children(".bottomEdge")),l=s.children(".leftEdge");"mouseenter"===t.type?(i.length&&(n=c(s,"parent").visible,i.toggleClass("fa-chevron-up",!n).toggleClass("fa-chevron-down",n)),a.length&&(n=c(s,"children").visible,a.toggleClass("fa-chevron-down",!n).toggleClass("fa-chevron-up",n)),l.length&&x(s)):s.children(".edge").removeClass("fa-chevron-up fa-chevron-down fa-chevron-right fa-chevron-left")}),d.on("click",function(t){e(this).closest(".orgchart").find(".focused").removeClass("focused"),e(this).addClass("focused")}),d.on("click",".topEdge",function(t){var s=e(this),n=s.parent(),i=c(n,"parent");if(i.exist){var l=n.closest("table").closest("tr").siblings(":first").find(".node");if(l.is(".slide"))return;i.visible?(h(n),l.one("transitionend",function(){m(n)&&(C(s),x(n))})):f(n)}else{var d=s.parent()[0].id;u(s,n,a)&&e.ajax({url:a.ajaxURL.parent+d+"/",dataType:"json"}).done(function(t){n.closest(".orgchart").data("inAjax")&&(e.isEmptyObject(t)||j.call(n.closest(".orgchart").parent(),n,t,a))}).fail(function(){console.log("Failed to get parent node data")}).always(function(){b(s,n,a)})}}),d.on("click",".bottomEdge",function(t){var s=e(this),n=s.parent(),i=c(n,"children");if(i.exist){if(n.closest("tr").siblings(":last").find(".node:visible").is(".slide"))return;i.visible?function(e){var t=e.closest("tr").siblings();t.last().find(".spinner").length&&e.closest(".orgchart").data("inAjax",!1);var s=t.last().find(".node:visible"),n=!!t.last().is(".verticalNodes");if(!n)var i=s.closest("table").closest("tr").prevAll(".lines").css("visibility","hidden");s.addClass("slide slide-up").eq(0).one("transitionend",function(){s.removeClass("slide"),n?t.addClass("hidden"):(i.removeAttr("style").addClass("hidden").siblings(".nodes").addClass("hidden"),t.last().find(".verticalNodes").addClass("hidden")),m(e)&&C(e.children(".bottomEdge"))})}(n):g(n)}else{var l=s.parent()[0].id;u(s,n,a)&&e.ajax({url:a.ajaxURL.children+l+"/",dataType:"json"}).done(function(t,s,i){n.closest(".orgchart").data("inAjax")&&t.children.length&&q(n,t,e.extend({},a,{depth:0}))}).fail(function(e,t,s){console.log("Failed to get children nodes data")}).always(function(){b(s,n,a)})}}),d.on("click",".toggleBtn",function(t){var s=e(this),n=s.parent().next(),i=n.find(".node"),a=n.children().children(".node");a.is(".slide")||(s.toggleClass("fa-plus-square fa-minus-square"),i.eq(0).is(".slide-up")?(n.removeClass("hidden"),E(a.get(0)),a.addClass("slide").removeClass("slide-up").eq(0).one("transitionend",function(){a.removeClass("slide")})):i.addClass("slide slide-up").eq(0).one("transitionend",function(){i.removeClass("slide"),i.closest("ul").addClass("hidden")}).find(".toggleBtn").removeClass("fa-minus-square").addClass("fa-plus-square"))}),d.on("click",".leftEdge, .rightEdge",function(t){var s=e(this),n=s.parent(),i=c(n,"siblings");if(i.exist){if(n.closest("table").parent().siblings().find(".node:visible").is(".slide"))return;if(a.toggleSiblingsResp){var l=n.closest("table").parent().prev(),d=n.closest("table").parent().next();s.is(".leftEdge")?l.is(".hidden")?v(n,"left"):p(n,"left"):d.is(".hidden")?v(n,"right"):p(n,"right")}else i.visible?p(n):v(n)}else{var r=s.parent()[0].id,o=c(n,"parent").exist?a.ajaxURL.siblings:a.ajaxURL.families;u(s,n,a)&&e.ajax({url:o+r+"/",dataType:"json"}).done(function(e,t,s){n.closest(".orgchart").data("inAjax")&&(e.siblings||e.children)&&N(n,e,a)}).fail(function(e,t,s){console.log("Failed to get sibling nodes data")}).always(function(){b(s,n,a)})}}),a.draggable&&d.on("dragstart",function(n){var i=n.originalEvent,l=/firefox/.test(t.navigator.userAgent.toLowerCase());if(l&&i.dataTransfer.setData("text/html","hack for firefox"),"none"!==d.closest(".orgchart").css("transform")){var r,o;s.querySelector(".ghost-node")?(r=d.closest(".orgchart").children(".ghost-node").get(0),o=e(r).children().get(0)):((r=s.createElementNS("http://www.w3.org/2000/svg","svg")).classList.add("ghost-node"),o=s.createElementNS("http://www.w3.org/2000/svg","rect"),r.appendChild(o),d.closest(".orgchart").append(r));var c=d.closest(".orgchart").css("transform").split(","),h=Math.abs(t.parseFloat("t2b"===a.direction||"b2t"===a.direction?c[0].slice(c[0].indexOf("(")+1):c[1]));r.setAttribute("width",d.outerWidth(!1)),r.setAttribute("height",d.outerHeight(!1)),o.setAttribute("x",5*h),o.setAttribute("y",5*h),o.setAttribute("width",120*h),o.setAttribute("height",40*h),o.setAttribute("rx",4*h),o.setAttribute("ry",4*h),o.setAttribute("stroke-width",1*h);var f=i.offsetX*h,g=i.offsetY*h;if("l2r"===a.direction?(f=i.offsetY*h,g=i.offsetX*h):"r2l"===a.direction?(f=d.outerWidth(!1)-i.offsetY*h,g=i.offsetX*h):"b2t"===a.direction&&(f=d.outerWidth(!1)-i.offsetX*h,g=d.outerHeight(!1)-i.offsetY*h),l){o.setAttribute("fill","rgb(255, 255, 255)"),o.setAttribute("stroke","rgb(191, 0, 0)");var p=s.createElement("img");p.src="data:image/svg+xml;utf8,"+(new XMLSerializer).serializeToString(r),i.dataTransfer.setDragImage(p,f,g)}else i.dataTransfer.setDragImage(r,f,g)}var v=e(this),u=v.closest(".nodes").siblings().eq(0).find(".node:first"),b=v.closest("table").find(".node");v.closest(".orgchart").data("dragged",v).find(".node").each(function(t,s){-1===b.index(s)&&(a.dropCriteria?a.dropCriteria(v,u,e(s))&&e(s).addClass("allowedDrop"):e(s).addClass("allowedDrop"))})}).on("dragover",function(t){t.preventDefault();var s=e(this),n=s.closest(".orgchart").data("dragged"),i=n.closest(".nodes").siblings().eq(0).find(".node:first");(n.closest("table").find(".node").index(s)>-1||a.dropCriteria&&!a.dropCriteria(n,i,s))&&(t.originalEvent.dataTransfer.dropEffect="none")}).on("dragend",function(t){e(this).closest(".orgchart").find(".allowedDrop").removeClass("allowedDrop")}).on("drop",function(t){var s=e(this),n=s.closest(".orgchart"),i=n.data("dragged");n.find(".allowedDrop").removeClass("allowedDrop");var a=i.closest(".nodes").siblings().eq(0).children();if(s.closest("tr").siblings().length){var l=parseInt(s.parent().attr("colspan"))+2,d='<i class="edge horizontalEdge rightEdge fa"></i><i class="edge horizontalEdge leftEdge fa"></i>';s.closest("tr").next().addBack().children().attr("colspan",l),i.find(".horizontalEdge").length||i.append(d),s.closest("tr").siblings().eq(1).children(":last").before('<td class="left top">&nbsp;</td><td class="right top">&nbsp;</td>').end().next().append(i.closest("table").parent());var r=i.closest("table").parent().siblings().find(".node:first");1===r.length&&r.append(d)}else s.append('<i class="edge verticalEdge bottomEdge fa"></i>').parent().attr("colspan",2).parent().after('<tr class="lines"><td colspan="2"><div class="down"></div></td></tr><tr class="lines"><td class="right">&nbsp;</td><td class="left">&nbsp;</td></tr><tr class="nodes"></tr>').siblings(":last").append(i.find(".horizontalEdge").remove().end().closest("table").parent());var o=parseInt(a.attr("colspan"));if(o>2){a.attr("colspan",o-2).parent().next().children().attr("colspan",o-2).end().next().children().slice(1,3).remove();var c=a.parent().siblings(".nodes").children().find(".node:first");1===c.length&&c.find(".horizontalEdge").remove()}else a.removeAttr("colspan").find(".bottomEdge").remove().end().end().siblings().remove();n.triggerHandler({type:"nodedropped.orgchart",draggedNode:i,dragZone:a.children(),dropZone:s})}),a.createNode&&a.createNode(d,n),l.resolve(d),l.promise()}function w(t,s,n,i,a){var l,d=s.children,r=!!d&&d.length,o=!!(i.verticalDepth&&n+1>=i.verticalDepth);if(Object.keys(s).length>1&&(l=o?t:e("<table>"),o||t.append(l),e.when(y(s,n,i)).done(function(e){o?l.append(e):l.append(e.wrap("<tr><td"+(r?' colspan="'+2*d.length+'"':"")+"></td></tr>").closest("tr")),a&&a()}).fail(function(){console.log("Failed to creat node")})),r){1===Object.keys(s).length&&(l=t);var c=n+1>=i.depth?" hidden":"",h=!!(i.verticalDepth&&n+2>=i.verticalDepth);h||l.append('<tr class="lines'+c+'"><td colspan="'+2*d.length+'"><div class="down"></div></td></tr>');for(var f='<tr class="lines'+c+'"><td class="right">&nbsp;</td>',g=1;g<d.length;g++)f+='<td class="left top">&nbsp;</td><td class="right top">&nbsp;</td>';f+='<td class="left">&nbsp;</td></tr>';var p;h?(p=e("<ul>"),n+2===i.verticalDepth?l.append('<tr class="verticalNodes"><td></td></tr>').find(".verticalNodes").children().append(p):l.append(p)):(p=e('<tr class="nodes'+c+'">'),l.append(f).append(p)),e.each(d,function(){var t=e(h?"<li>":'<td colspan="2">');p.append(t),w(t,this,n+1,i,a)})}}function A(e,t,s,n){var s=s||e.closest(".orgchart").data("options"),i=t.children||t.siblings;e.find("td:first").attr("colspan",2*i.length),w(e,{children:i},0,s,n)}function q(e,t,s){var s=s||e.closest(".orgchart").data("options"),n=0;A.call(e.closest(".orgchart").parent(),e.closest("table"),t,s,function(){++n===t.children.length&&(e.children(".bottomEdge").length||e.append('<i class="edge verticalEdge bottomEdge fa"></i>'),e.find(".symbol").length||e.children(".title").prepend('<i class="fa '+s.parentNodeSymbol+' symbol"></i>'),g(e))})}function j(t,s,n){(function(t,s,n,i){var a=this,l=e("<table>");s.relationship="001",e.when(y(s,0,n||t.closest(".orgchart").data("options"))).done(function(e){l.append(e.removeClass("slide-up").addClass("slide-down").wrap('<tr class="hidden"><td colspan="2"></td></tr>').closest("tr")),l.append('<tr class="lines hidden"><td colspan="2"><div class="down"></div></td></tr>'),l.append('<tr class="lines hidden"><td class="right">&nbsp;</td><td class="left">&nbsp;</td></tr>');var t=a.children(".orgchart");t.prepend(l).children("table:first").append('<tr class="nodes"><td colspan="2"></td></tr>').children("tr:last").children().append(t.children("table").last()),i()}).fail(function(){console.log("Failed to create parent node")})}).call(this,t,s,n,function(){t.children(".topEdge").length||t.children(".title").after('<i class="edge verticalEdge topEdge fa"></i>'),f(t)})}function D(e,t,s){for(var n="",i=0;i<s;i++)n+='<td class="left top">&nbsp;</td><td class="right top">&nbsp;</td>';e.parent().prevAll("tr:gt(0)").children().attr("colspan",2*t).end().next().children(":first").after(n)}function N(t,s,n){(function(t,s,n,i){var n=n||t.closest(".orgchart").data("options"),a=s.siblings?s.siblings.length:s.children.length,l=t.parent().is("td")?t.closest("tr").children().length:1,d=l+a,r=d>1?Math.floor(d/2-1):0;if(t.parent().is("td")){t.closest("tr").prevAll("tr:last"),t.closest("tr").prevAll("tr:lt(2)").remove();var o=0;A.call(t.closest(".orgchart").parent(),t.parent().closest("table"),s,n,function(){if(++o===a){var e=t.parent().closest("table").children("tr:last").children("td");l>1?(D(e.eq(0).before(t.closest("td").siblings().addBack().unwrap()),d,l),e.addClass("hidden").find(".node").addClass("slide-left")):(D(e.eq(r).after(t.closest("td").unwrap()),d,1),e.not(":eq("+r+"1)").addClass("hidden").slice(0,r).find(".node").addClass("slide-right").end().end().slice(r).find(".node").addClass("slide-left")),i()}})}else{var c=0;w(t.closest(".orgchart"),s,0,n,function(){++c===d&&(D(t.next().children("tr:last").children().eq(r).after(e('<td colspan="2">').append(t)),d,1),t.closest("tr").siblings().eq(0).addClass("hidden").find(".node").addClass("slide-down"),t.parent().siblings().addClass("hidden").slice(0,r).find(".node").addClass("slide-right").end().end().slice(r).find(".node").addClass("slide-left"),i())})}}).call(t.closest(".orgchart").parent(),t.closest("table"),s,n,function(){t.closest(".nodes").data("siblingsLoaded",!0),t.children(".leftEdge").length||t.children(".topEdge").after('<i class="edge horizontalEdge rightEdge fa"></i><i class="edge horizontalEdge leftEdge fa"></i>'),v(t)})}e.fn.orgchart=function(t){switch(t){case"buildHierarchy":return w.apply(this,Array.prototype.splice.call(arguments,1));case"addChildren":return q.apply(this,Array.prototype.splice.call(arguments,1));case"addParent":return j.apply(this,Array.prototype.splice.call(arguments,1));case"addSiblings":return N.apply(this,Array.prototype.splice.call(arguments,1));case"removeNodes":return function(e){var t=e.closest("table").parent(),s=t.parent().siblings();t.is("td")?c(e,"siblings").exist?(s.eq(2).children(".top:lt(2)").remove(),s.eq(":lt(2)").children().attr("colspan",s.eq(2).children().length),t.remove()):s.eq(0).children().removeAttr("colspan").find(".bottomEdge").remove().end().end().siblings().remove():t.add(t.siblings()).remove()}.apply(this,Array.prototype.splice.call(arguments,1));case"getHierarchy":return o.apply(this,Array.prototype.splice.call(arguments,1));default:var n=e.extend({nodeTitle:"name",nodeId:"id",toggleSiblingsResp:!1,depth:999,chartClass:"",exportButton:!1,exportFilename:"OrgChart",parentNodeSymbol:"fa-users",draggable:!1,direction:"t2b",pan:!1,zoom:!1},t)}var r=this,h=n.data,f=e("<div>",{data:{options:n},class:"orgchart"+(""!==n.chartClass?" "+n.chartClass:"")+("t2b"!==n.direction?" "+n.direction:""),click:function(t){e(t.target).closest(".node").length||f.find(".node.focused").removeClass("focused")}});if("object"===e.type(h)?h instanceof e?w(f,l(h.children()),0,n):w(f,n.ajaxURL?h:d(h,"00"),0,n):e.ajax({url:h,dataType:"json",beforeSend:function(){f.append('<i class="fa fa-circle-o-notch fa-spin spinner"></i>')}}).done(function(e,t,s){w(f,n.ajaxURL?e:d(e,"00"),0,n)}).fail(function(e,t,s){console.log(s)}).always(function(){f.children(".spinner").remove()}),r.append(f),n.exportButton&&!r.find(".oc-export-btn").length){var g=e("<button>",{class:"oc-export-btn"+(""!==n.chartClass?" "+n.chartClass:""),text:"Export",click:function(){if(e(this).children(".spinner").length)return!1;var t=r.find(".mask");t.length?t.removeClass("hidden"):r.append('<div class="mask"><i class="fa fa-circle-o-notch fa-spin spinner"></i></div>');var s=r.addClass("canvasContainer").find(".orgchart:visible").get(0),i="l2r"===n.direction||"r2l"===n.direction;html2canvas(s,{width:i?s.clientHeight:s.clientWidth,height:i?s.clientWidth:s.clientHeight,onclone:function(t){e(t).find(".canvasContainer").css("overflow","visible").find(".orgchart:visible:first").css("transform","")},onrendered:function(e){r.find(".mask").addClass("hidden").end().find(".oc-download-btn").attr("href",e.toDataURL())[0].click()}}).then(function(){r.removeClass("canvasContainer")},function(){r.removeClass("canvasContainer")})}}),p='<a class="oc-download-btn'+(""!==n.chartClass?" "+n.chartClass:"")+'" download="'+n.exportFilename+'.png"></a>';r.append(g).append(p)}return n.pan&&(r.css("overflow","hidden"),f.on("mousedown touchstart",function(t){var s=e(this);if(e(t.target).closest(".node").length||t.touches&&t.touches.length>1)s.data("panning",!1);else{s.css("cursor","move").data("panning",!0);var n=0,i=0,a=s.css("transform");if("none"!==a){var l=a.split(",");-1===a.indexOf("3d")?(n=parseInt(l[4]),i=parseInt(l[5])):(n=parseInt(l[12]),i=parseInt(l[13]))}var d=0,r=0;if(t.targetTouches){if(1===t.targetTouches.length)d=t.targetTouches[0].pageX-n,r=t.targetTouches[0].pageY-i;else if(t.targetTouches.length>1)return}else d=t.pageX-n,r=t.pageY-i;f.on("mousemove touchmove",function(e){if(s.data("panning")){var t=0,n=0;if(e.targetTouches){if(1===e.targetTouches.length)t=e.targetTouches[0].pageX-d,n=e.targetTouches[0].pageY-r;else if(e.targetTouches.length>1)return}else t=e.pageX-d,n=e.pageY-r;var i=s.css("transform");if("none"===i)-1===i.indexOf("3d")?s.css("transform","matrix(1, 0, 0, 1, "+t+", "+n+")"):s.css("transform","matrix3d(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, "+t+", "+n+", 0, 1)");else{var a=i.split(",");-1===i.indexOf("3d")?(a[4]=" "+t,a[5]=" "+n+")"):(a[12]=" "+t,a[13]=" "+n),s.css("transform",a.join(","))}}})}}),e(s).on("mouseup touchend",function(e){f.data("panning")&&f.data("panning",!1).css("cursor","default").off("mousemove")})),n.zoom&&(r.on("wheel",function(e){e.preventDefault();var t=1+(e.originalEvent.deltaY>0?-.2:.2);a(f,t)}),r.on("touchstart",function(e){if(e.touches&&2===e.touches.length){f.data("pinching",!0);var t=i(e);f.data("pinchDistStart",t)}}),e(s).on("touchmove",function(e){if(f.data("pinching")){var t=i(e);f.data("pinchDistEnd",t)}}).on("touchend",function(e){if(f.data("pinching")){f.data("pinching",!1);var t=f.data("pinchDistEnd")-f.data("pinchDistStart");t>0?a(f,1.2):t<0&&a(f,.8)}})),r}});