"use strict";!function(e){"object"==typeof module&&"object"==typeof module.exports?e(require("jquery"),window,document):e(jQuery,window,document)}(function(e,t,i,s){var n=function(t,i){this.$chartContainer=e(t),this.opts=i,this.defaultOptions={nodeTitle:"name",nodeId:"id",toggleSiblingsResp:!1,depth:999,chartClass:"",exportButton:!1,exportFilename:"OrgChart",exportFileextension:"png",parentNodeSymbol:"fa-users",draggable:!1,direction:"t2b",pan:!1,zoom:!1,zoominLimit:7,zoomoutLimit:.5}};n.prototype={init:function(s){var n=this;this.options=e.extend({},this.defaultOptions,this.opts,s);var a=this.$chartContainer;this.$chart&&this.$chart.remove();var d=this.options.data,o=this.$chart=e("<div>",{data:{options:this.options},class:"orgchart"+(""!==this.options.chartClass?" "+this.options.chartClass:"")+("t2b"!==this.options.direction?" "+this.options.direction:""),click:function(t){e(t.target).closest(".node").length||o.find(".node.focused").removeClass("focused")}}),l=new MutationObserver(function(e){l.disconnect();e:for(var t=0;t<e.length;t++)for(var i=0;i<e[t].addedNodes.length;i++)if(e[t].addedNodes[i].classList.contains("orgchart")&&n.options.initCompleted&&"function"==typeof n.options.initCompleted){n.options.initCompleted(o),o.triggerHandler({type:"init.orgchart"});break e}});if(l.observe(a[0],{childList:!0}),"object"===e.type(d)?d instanceof e?this.buildHierarchy(o,this.buildJsonDS(d.children()),0,this.options):this.buildHierarchy(o,this.options.ajaxURL?d:this.attachRel(d,"00"),0,this.options):e.ajax({url:d,dataType:"json",beforeSend:function(){o.append('<i class="fa fa-circle-o-notch fa-spin spinner"></i>')}}).done(function(e,t,i){n.buildHierarchy(o,n.options.ajaxURL?e:n.attachRel(e,"00"),0,n.options)}).fail(function(e,t,i){console.log(i)}).always(function(){o.children(".spinner").remove()}),a.append(o),this.options.exportButton&&!a.find(".oc-export-btn").length){var r=e("<button>",{class:"oc-export-btn"+(""!==this.options.chartClass?" "+this.options.chartClass:""),text:"Export",click:function(s){if(s.preventDefault(),e(this).children(".spinner").length)return!1;var d=a.find(".mask");d.length?d.removeClass("hidden"):a.append('<div class="mask"><i class="fa fa-circle-o-notch fa-spin spinner"></i></div>');var o=a.addClass("canvasContainer").find(".orgchart:visible").get(0),l="l2r"===n.options.direction||"r2l"===n.options.direction;html2canvas(o,{width:l?o.clientHeight:o.clientWidth,height:l?o.clientWidth:o.clientHeight,onclone:function(t){e(t).find(".canvasContainer").css("overflow","visible").find(".orgchart:visible:first").css("transform","")},onrendered:function(e){if(a.find(".mask").addClass("hidden"),"pdf"===n.options.exportFileextension.toLowerCase()){var s={},d=Math.floor(.2646*e.width),o=Math.floor(.2646*e.height);(s=d>o?new jsPDF("l","mm",[d,o]):new jsPDF("p","mm",[o,d])).addImage(e.toDataURL(),"png",0,0),s.save(n.options.exportFilename+".pdf")}else{var l="WebkitAppearance"in i.documentElement.style,r=!!t.sidebar,c="Microsoft Internet Explorer"===navigator.appName||"Netscape"===navigator.appName&&navigator.appVersion.indexOf("Edge")>-1;!l&&!r||c?t.navigator.msSaveBlob(e.msToBlob(),n.options.exportFilename+".png"):a.find(".oc-download-btn").attr("href",e.toDataURL())[0].click()}}}).then(function(){a.removeClass("canvasContainer")},function(){a.removeClass("canvasContainer")})}});if(a.append(r),"pdf"!==this.options.exportFileextension.toLowerCase()){var c='<a class="oc-download-btn'+(""!==this.options.chartClass?" "+this.options.chartClass:"")+'" download="'+this.options.exportFilename+'.png"></a>';r.after(c)}}return this.options.pan&&(a.css("overflow","hidden"),o.on("mousedown touchstart",function(t){var i=e(this);if(e(t.target).closest(".node").length||t.touches&&t.touches.length>1)i.data("panning",!1);else{i.css("cursor","move").data("panning",!0);var s=0,n=0,a=i.css("transform");if("none"!==a){var d=a.split(",");-1===a.indexOf("3d")?(s=parseInt(d[4]),n=parseInt(d[5])):(s=parseInt(d[12]),n=parseInt(d[13]))}var l=0,r=0;if(t.targetTouches){if(1===t.targetTouches.length)l=t.targetTouches[0].pageX-s,r=t.targetTouches[0].pageY-n;else if(t.targetTouches.length>1)return}else l=t.pageX-s,r=t.pageY-n;o.on("mousemove touchmove",function(e){if(i.data("panning")){var t=0,s=0;if(e.targetTouches){if(1===e.targetTouches.length)t=e.targetTouches[0].pageX-l,s=e.targetTouches[0].pageY-r;else if(e.targetTouches.length>1)return}else t=e.pageX-l,s=e.pageY-r;var n=i.css("transform");if("none"===n)-1===n.indexOf("3d")?i.css("transform","matrix(1, 0, 0, 1, "+t+", "+s+")"):i.css("transform","matrix3d(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, "+t+", "+s+", 0, 1)");else{var a=n.split(",");-1===n.indexOf("3d")?(a[4]=" "+t,a[5]=" "+s+")"):(a[12]=" "+t,a[13]=" "+s),i.css("transform",a.join(","))}}})}}),e(i).on("mouseup touchend",function(e){o.data("panning")&&o.data("panning",!1).css("cursor","default").off("mousemove")})),this.options.zoom&&(a.on("wheel",function(e){e.preventDefault();var t=1+(e.originalEvent.deltaY>0?-.2:.2);n.setChartScale(o,t)}),a.on("touchstart",function(e){if(e.touches&&2===e.touches.length){o.data("pinching",!0);var t=getPinchDist(e);o.data("pinchDistStart",t)}}),e(i).on("touchmove",function(e){if(o.data("pinching")){var t=getPinchDist(e);o.data("pinchDistEnd",t)}}).on("touchend",function(e){if(o.data("pinching")){o.data("pinching",!1);var t=o.data("pinchDistEnd")-o.data("pinchDistStart");t>0?n.setChartScale(o,1.2):t<0&&n.setChartScale(o,.8)}})),this},getPinchDist:e=>Math.sqrt((e.touches[0].clientX-e.touches[1].clientX)*(e.touches[0].clientX-e.touches[1].clientX)+(e.touches[0].clientY-e.touches[1].clientY)*(e.touches[0].clientY-e.touches[1].clientY)),setChartScale(e,i){var s=e.data("options"),n=e.css("transform"),a="",d=1;"none"===n?e.css("transform","scale("+i+","+i+")"):(a=n.split(","),-1===n.indexOf("3d")?(d=t.parseFloat(a[3])*i)>s.zoomoutLimit&&d<s.zoominLimit&&e.css("transform",n+" scale("+i+","+i+")"):(d=t.parseFloat(a[1])*i)>s.zoomoutLimit&&d<s.zoominLimit&&e.css("transform",n+" scale3d("+i+","+i+", 1)"))},buildJsonDS(t){var i=this,s={name:t.contents().eq(0).text().trim(),relationship:(t.parent().parent().is("li")?"1":"0")+(t.siblings("li").length?1:0)+(t.children("ul").length?1:0)};return t[0].id&&(s.id=t[0].id),t.children("ul").children().each(function(){s.children||(s.children=[]),s.children.push(i.buildJsonDS(e(this)))}),s},attachRel(e,t){var i=this;return e.relationship=t+(e.children&&e.children.length>0?1:0),e.children&&e.children.forEach(function(t){i.attachRel(t,"1"+(e.children.length>1?1:0))}),e},loopChart(t){var i=this,s=t.find("tr:first"),n={id:s.find(".node")[0].id};return s.siblings(":last").children().each(function(){n.children||(n.children=[]),n.children.push(i.loopChart(e(this)))}),n},getHierarchy(e){return(e=e||this.$chart).find(".node:first")[0].id?this.loopChart(e):"Error: Nodes of orghcart to be exported must have id attribute!"},getNodeState(e,t){var i={};return"parent"===t?i=e.closest(".nodes").siblings(":first"):"children"===t?i=e.closest("tr").siblings():"siblings"===t&&(i=e.closest("table").parent().siblings()),i.length?i.is(":visible")?{exist:!0,visible:!0}:{exist:!0,visible:!1}:{exist:!1,visible:!1}},getRelatedNodes:(e,t)=>"parent"===t?e.closest(".nodes").parent().children(":first").find(".node"):"children"===t?e.closest("table").children(":last").children().find(".node:first"):"siblings"===t?e.closest("table").parent().siblings().find(".node:first"):void 0,hideParent(e){var t=e.closest("table").closest("tr").siblings();t.eq(0).find(".spinner").length&&e.closest(".orgchart").data("inAjax",!1),this.getNodeState(e,"siblings").visible&&this.hideSiblings(e);var i=t.slice(1);i.css("visibility","hidden");var s=t.eq(0).find(".node"),n=this.getNodeState(s,"parent").visible;s.length&&s.is(":visible")&&s.addClass("slide slide-down").one("transitionend",function(){s.removeClass("slide"),i.removeAttr("style"),t.addClass("hidden")}),s.length&&n&&this.hideParent(s)},showParent(t){var i=this,s=t.closest("table").closest("tr").siblings().removeClass("hidden");s.eq(2).children().slice(1,-1).addClass("hidden");var n=s.eq(0).find(".node")[0];this.repaint(n),e(n).addClass("slide").removeClass("slide-down").one("transitionend",function(){e(n).removeClass("slide"),i.isInAction(t)&&i.switchVerticalArrow(t.children(".topEdge"))})},hideChildren(e){var t=this,i=e.closest("tr").siblings();i.last().find(".spinner").length&&e.closest(".orgchart").data("inAjax",!1);var s=i.last().find(".node:visible"),n=!!i.last().is(".verticalNodes");if(!n)var a=s.closest("table").closest("tr").prevAll(".lines").css("visibility","hidden");s.addClass("slide slide-up").eq(0).one("transitionend",function(){s.removeClass("slide"),n?i.addClass("hidden"):(a.removeAttr("style").addClass("hidden").siblings(".nodes").addClass("hidden"),i.last().find(".verticalNodes").addClass("hidden")),t.isInAction(e)&&t.switchVerticalArrow(e.children(".bottomEdge"))})},showChildren(e){var t=this,i=e.closest("tr").siblings(),s=!!i.is(".verticalNodes")?i.removeClass("hidden").find(".node:visible"):i.removeClass("hidden").eq(2).children().find(".node:first");this.repaint(s.get(0)),s.addClass("slide").removeClass("slide-up").eq(0).one("transitionend",function(){s.removeClass("slide"),t.isInAction(e)&&t.switchVerticalArrow(e.children(".bottomEdge"))})},hideSiblings(e,t){var i=this,s=e.closest("table").parent();s.siblings().find(".spinner").length&&e.closest(".orgchart").data("inAjax",!1),t?"left"===t?s.prevAll().find(".node:visible").addClass("slide slide-right"):s.nextAll().find(".node:visible").addClass("slide slide-left"):(s.prevAll().find(".node:visible").addClass("slide slide-right"),s.nextAll().find(".node:visible").addClass("slide slide-left"));var n=s.siblings().find(".slide"),a=n.closest(".nodes").prevAll(".lines").css("visibility","hidden");n.eq(0).one("transitionend",function(){a.removeAttr("style");var d=t?"left"===t?s.prevAll(":not(.hidden)"):s.nextAll(":not(.hidden)"):s.siblings();s.closest(".nodes").prev().children(":not(.hidden)").slice(1,t?2*d.length+1:-1).addClass("hidden"),n.removeClass("slide"),d.find(".node:visible:gt(0)").removeClass("slide-left slide-right").addClass("slide-up").end().find(".lines, .nodes, .verticalNodes").addClass("hidden").end().addClass("hidden"),i.isInAction(e)&&i.switchHorizontalArrow(e)})},showSiblings(t,i){var s=this,n=e();n=i?"left"===i?t.closest("table").parent().prevAll().removeClass("hidden"):t.closest("table").parent().nextAll().removeClass("hidden"):t.closest("table").parent().siblings().removeClass("hidden");var a=t.closest("table").closest("tr").siblings();if(i?a.eq(2).children(".hidden").slice(0,2*n.length).removeClass("hidden"):a.eq(2).children(".hidden").removeClass("hidden"),!this.getNodeState(t,"parent").visible){a.removeClass("hidden");var d=a.find(".node")[0];this.repaint(d),e(d).addClass("slide").removeClass("slide-down").one("transitionend",function(){e(this).removeClass("slide")})}n.find(".node:visible").addClass("slide").removeClass("slide-left slide-right").eq(-1).one("transitionend",function(){n.find(".node:visible").removeClass("slide"),s.isInAction(t)&&(s.switchHorizontalArrow(t),t.children(".topEdge").removeClass("fa-chevron-up").addClass("fa-chevron-down"))})},startLoading(t,i,s){var n=i.closest(".orgchart");return(void 0===n.data("inAjax")||!0!==n.data("inAjax"))&&(t.addClass("hidden"),i.append('<i class="fa fa-circle-o-notch fa-spin spinner"></i>'),i.children().not(".spinner").css("opacity",.2),n.data("inAjax",!0),e(".oc-export-btn"+(""!==s.chartClass?"."+s.chartClass:"")).prop("disabled",!0),!0)},endLoading(t,i,s){var n=i.closest("div.orgchart");t.removeClass("hidden"),i.find(".spinner").remove(),i.children().removeAttr("style"),n.data("inAjax",!1),e(".oc-export-btn"+(""!==s.chartClass?"."+s.chartClass:"")).prop("disabled",!1)},isInAction:e=>e.children(".edge").attr("class").indexOf("fa-")>-1,switchVerticalArrow(e){e.toggleClass("fa-chevron-up").toggleClass("fa-chevron-down")},switchHorizontalArrow(e){var t=e.closest(".orgchart").data("options");if(t.toggleSiblingsResp&&(void 0===t.ajaxURL||e.closest(".nodes").data("siblingsLoaded"))){var i=e.closest("table").parent().prev();i.length&&(i.is(".hidden")?e.children(".leftEdge").addClass("fa-chevron-left").removeClass("fa-chevron-right"):e.children(".leftEdge").addClass("fa-chevron-right").removeClass("fa-chevron-left"));var s=e.closest("table").parent().next();s.length&&(s.is(".hidden")?e.children(".rightEdge").addClass("fa-chevron-right").removeClass("fa-chevron-left"):e.children(".rightEdge").addClass("fa-chevron-left").removeClass("fa-chevron-right"))}else{var n=e.closest("table").parent().siblings(),a=!!n.length&&!n.is(".hidden");e.children(".leftEdge").toggleClass("fa-chevron-right",a).toggleClass("fa-chevron-left",!a),e.children(".rightEdge").toggleClass("fa-chevron-left",a).toggleClass("fa-chevron-right",!a)}},repaint(e){e&&(e.style.offsetWidth=e.offsetWidth)},createNode(s,n,a){var d=this;e.each(s.children,function(e,t){t.parentId=s.id});var o=e.Deferred(),l=e("<div"+(a.draggable?' draggable="true"':"")+(s[a.nodeId]?' id="'+s[a.nodeId]+'"':"")+(s.parentId?' data-parent="'+s.parentId+'"':"")+">").addClass("node "+(s.className||"")+(n>=a.depth?" slide-up":"")).append('<div class="title">'+s[a.nodeTitle]+"</div>").append(void 0!==a.nodeContent?'<div class="content">'+(s[a.nodeContent]||"")+"</div>":""),r=s.relationship||"";if(a.verticalDepth&&n+2>a.verticalDepth){if(n+1>=a.verticalDepth&&Number(r.substr(2,1))){var c=n+1>=a.depth?"plus":"minus";l.append('<i class="toggleBtn fa fa-'+c+'-square"></i>')}}else Number(r.substr(0,1))&&l.append('<i class="edge verticalEdge topEdge fa"></i>'),Number(r.substr(1,1))&&l.append('<i class="edge horizontalEdge rightEdge fa"></i><i class="edge horizontalEdge leftEdge fa"></i>'),Number(r.substr(2,1))&&l.append('<i class="edge verticalEdge bottomEdge fa"></i>').children(".title").prepend('<i class="fa '+a.parentNodeSymbol+' symbol"></i>');return l.on("mouseenter mouseleave",function(t){var i=e(this),s=!1,n=i.children(".topEdge"),a=(i.children(".rightEdge"),i.children(".bottomEdge")),o=i.children(".leftEdge");"mouseenter"===t.type?(n.length&&(s=d.getNodeState(i,"parent").visible,n.toggleClass("fa-chevron-up",!s).toggleClass("fa-chevron-down",s)),a.length&&(s=d.getNodeState(i,"children").visible,a.toggleClass("fa-chevron-down",!s).toggleClass("fa-chevron-up",s)),o.length&&d.switchHorizontalArrow(i)):i.children(".edge").removeClass("fa-chevron-up fa-chevron-down fa-chevron-right fa-chevron-left")}),l.on("click",function(t){e(this).closest(".orgchart").find(".focused").removeClass("focused"),e(this).addClass("focused")}),l.on("click",".topEdge",function(t){t.stopPropagation();var i=e(this),n=i.parent(),o=d.getNodeState(n,"parent");if(o.exist){var l=n.closest("table").closest("tr").siblings(":first").find(".node");if(l.is(".slide"))return;o.visible?(d.hideParent(n),l.one("transitionend",function(){d.isInAction(n)&&(d.switchVerticalArrow(i),d.switchHorizontalArrow(n))})):d.showParent(n)}else{var r=i.parent()[0].id;d.startLoading(i,n,a)&&e.ajax({url:e.isFunction(a.ajaxURL.parent)?a.ajaxURL.parent(s):a.ajaxURL.parent+r,dataType:"json"}).done(function(t){n.closest(".orgchart").data("inAjax")&&(e.isEmptyObject(t)||d.addParent(n,t,a))}).fail(function(){console.log("Failed to get parent node data")}).always(function(){d.endLoading(i,n,a)})}}),l.on("click",".bottomEdge",function(t){t.stopPropagation();var i=e(this),n=i.parent(),o=d.getNodeState(n,"children");if(o.exist){if(n.closest("tr").siblings(":last").find(".node:visible").is(".slide"))return;o.visible?d.hideChildren(n):d.showChildren(n)}else{var l=i.parent()[0].id;d.startLoading(i,n,a)&&e.ajax({url:e.isFunction(a.ajaxURL.children)?a.ajaxURL.children(s):a.ajaxURL.children+l,dataType:"json"}).done(function(t,i,s){n.closest(".orgchart").data("inAjax")&&t.children.length&&d.addChildren(n,t,e.extend({},a,{depth:0}))}).fail(function(e,t,i){console.log("Failed to get children nodes data")}).always(function(){d.endLoading(i,n,a)})}}),l.on("click",".toggleBtn",function(t){var i=e(this),s=i.parent().next(),n=s.find(".node"),a=s.children().children(".node");a.is(".slide")||(i.toggleClass("fa-plus-square fa-minus-square"),n.eq(0).is(".slide-up")?(s.removeClass("hidden"),d.repaint(a.get(0)),a.addClass("slide").removeClass("slide-up").eq(0).one("transitionend",function(){a.removeClass("slide")})):(n.addClass("slide slide-up").eq(0).one("transitionend",function(){n.removeClass("slide"),n.closest("ul").addClass("hidden")}),n.find(".toggleBtn").removeClass("fa-minus-square").addClass("fa-plus-square")))}),l.on("click",".leftEdge, .rightEdge",function(t){t.stopPropagation();var i=e(this),n=i.parent(),o=d.getNodeState(n,"siblings");if(o.exist){if(n.closest("table").parent().siblings().find(".node:visible").is(".slide"))return;if(a.toggleSiblingsResp){var l=n.closest("table").parent().prev(),r=n.closest("table").parent().next();i.is(".leftEdge")?l.is(".hidden")?d.showSiblings(n,"left"):d.hideSiblings(n,"left"):r.is(".hidden")?d.showSiblings(n,"right"):d.hideSiblings(n,"right")}else o.visible?d.hideSiblings(n):d.showSiblings(n)}else{var c=i.parent()[0].id,h=d.getNodeState(n,"parent").exist?e.isFunction(a.ajaxURL.siblings)?a.ajaxURL.siblings(s):a.ajaxURL.siblings+c:e.isFunction(a.ajaxURL.families)?a.ajaxURL.families(s):a.ajaxURL.families+c;d.startLoading(i,n,a)&&e.ajax({url:h,dataType:"json"}).done(function(e,t,i){n.closest(".orgchart").data("inAjax")&&(e.siblings||e.children)&&d.addSiblings(n,e,a)}).fail(function(e,t,i){console.log("Failed to get sibling nodes data")}).always(function(){d.endLoading(i,n,a)})}}),a.draggable&&l.on("dragstart",function(s){var n=s.originalEvent,d=/firefox/.test(t.navigator.userAgent.toLowerCase());if(d&&n.dataTransfer.setData("text/html","hack for firefox"),"none"!==l.closest(".orgchart").css("transform")){var o,r;i.querySelector(".ghost-node")?(o=l.closest(".orgchart").children(".ghost-node").get(0),r=e(o).children().get(0)):((o=i.createElementNS("http://www.w3.org/2000/svg","svg")).classList.add("ghost-node"),r=i.createElementNS("http://www.w3.org/2000/svg","rect"),o.appendChild(r),l.closest(".orgchart").append(o));var c=l.closest(".orgchart").css("transform").split(","),h=Math.abs(t.parseFloat("t2b"===a.direction||"b2t"===a.direction?c[0].slice(c[0].indexOf("(")+1):c[1]));o.setAttribute("width",l.outerWidth(!1)),o.setAttribute("height",l.outerHeight(!1)),r.setAttribute("x",5*h),r.setAttribute("y",5*h),r.setAttribute("width",120*h),r.setAttribute("height",40*h),r.setAttribute("rx",4*h),r.setAttribute("ry",4*h),r.setAttribute("stroke-width",1*h);var p=n.offsetX*h,g=n.offsetY*h;if("l2r"===a.direction?(p=n.offsetY*h,g=n.offsetX*h):"r2l"===a.direction?(p=l.outerWidth(!1)-n.offsetY*h,g=n.offsetX*h):"b2t"===a.direction&&(p=l.outerWidth(!1)-n.offsetX*h,g=l.outerHeight(!1)-n.offsetY*h),d){r.setAttribute("fill","rgb(255, 255, 255)"),r.setAttribute("stroke","rgb(191, 0, 0)");var f=i.createElement("img");f.src="data:image/svg+xml;utf8,"+(new XMLSerializer).serializeToString(o),n.dataTransfer.setDragImage(f,p,g)}else n.dataTransfer.setDragImage(o,p,g)}var v=e(this),u=v.closest(".nodes").siblings().eq(0).find(".node:first"),b=v.closest("table").find(".node");v.closest(".orgchart").data("dragged",v).find(".node").each(function(t,i){-1===b.index(i)&&(a.dropCriteria?a.dropCriteria(v,u,e(i))&&e(i).addClass("allowedDrop"):e(i).addClass("allowedDrop"))})}).on("dragover",function(t){t.preventDefault(),e(this).is(".allowedDrop")||(t.originalEvent.dataTransfer.dropEffect="none")}).on("dragend",function(t){e(this).closest(".orgchart").find(".allowedDrop").removeClass("allowedDrop")}).on("drop",function(t){var i=e(this),s=i.closest(".orgchart"),n=s.data("dragged");s.find(".allowedDrop").removeClass("allowedDrop");var a=n.closest(".nodes").siblings().eq(0).children();if(i.closest("tr").siblings().length){var d=parseInt(i.parent().attr("colspan"))+2,o='<i class="edge horizontalEdge rightEdge fa"></i><i class="edge horizontalEdge leftEdge fa"></i>';i.closest("tr").next().addBack().children().attr("colspan",d),n.find(".horizontalEdge").length||n.append(o),i.closest("tr").siblings().eq(1).children(":last").before('<td class="leftLine topLine">&nbsp;</td><td class="rightLine topLine">&nbsp;</td>').end().next().append(n.closest("table").parent());var l=n.closest("table").parent().siblings().find(".node:first");1===l.length&&l.append(o)}else i.append('<i class="edge verticalEdge bottomEdge fa"></i>').parent().attr("colspan",2).parent().after('<tr class="lines"><td colspan="2"><div class="downLine"></div></td></tr><tr class="lines"><td class="rightLine">&nbsp;</td><td class="leftLine">&nbsp;</td></tr><tr class="nodes"></tr>').siblings(":last").append(n.find(".horizontalEdge").remove().end().closest("table").parent());var r=parseInt(a.attr("colspan"));if(r>2){a.attr("colspan",r-2).parent().next().children().attr("colspan",r-2).end().next().children().slice(1,3).remove();var c=a.parent().siblings(".nodes").children().find(".node:first");1===c.length&&c.find(".horizontalEdge").remove()}else a.removeAttr("colspan").find(".bottomEdge").remove().end().end().siblings().remove();s.triggerHandler({type:"nodedropped.orgchart",draggedNode:n,dragZone:a.children(),dropZone:i})}),a.createNode&&a.createNode(l,s),o.resolve(l),o.promise()},buildHierarchy(t,i,s,n,a){var d,o=this,l=i.children,r=!!l&&l.length,c=!!(n.verticalDepth&&s+1>=n.verticalDepth);if(Object.keys(i).length>1&&(d=c?t:e("<table>"),c||t.append(d),e.when(this.createNode(i,s,n)).done(function(e){c?d.append(e):d.append(e.wrap("<tr><td"+(r?' colspan="'+2*l.length+'"':"")+"></td></tr>").closest("tr")),a&&a()}).fail(function(){console.log("Failed to creat node")})),r){1===Object.keys(i).length&&(d=t);var h=s+1>=n.depth||i.collapsed?" hidden":"",p=!!(n.verticalDepth&&s+2>=n.verticalDepth);p||d.append('<tr class="lines'+h+'"><td colspan="'+2*l.length+'"><div class="downLine"></div></td></tr>');for(var g='<tr class="lines'+h+'"><td class="rightLine">&nbsp;</td>',f=1;f<l.length;f++)g+='<td class="leftLine topLine">&nbsp;</td><td class="rightLine topLine">&nbsp;</td>';g+='<td class="leftLine">&nbsp;</td></tr>';var v;p?(v=e("<ul>"),h&&v.addClass(h),s+2===n.verticalDepth?d.append('<tr class="verticalNodes'+h+'"><td></td></tr>').find(".verticalNodes").children().append(v):d.append(v)):(v=e('<tr class="nodes'+h+'">'),d.append(g).append(v)),e.each(l,function(){var t=e(p?"<li>":'<td colspan="2">');v.append(t),o.buildHierarchy(t,this,s+1,n,a)})}},buildChildNode(e,t,i,s){var i=i||e.closest(".orgchart").data("options"),n=t.children||t.siblings;e.find("td:first").attr("colspan",2*n.length),this.buildHierarchy(e,{children:n},0,i,s)},addChildren(e,t,i){var s=this,i=i||e.closest(".orgchart").data("options"),n=0;this.buildChildNode(e.closest("table"),t,i,function(){++n===t.children.length&&(e.children(".bottomEdge").length||e.append('<i class="edge verticalEdge bottomEdge fa"></i>'),e.find(".symbol").length||e.children(".title").prepend('<i class="fa '+i.parentNodeSymbol+' symbol"></i>'),s.showChildren(e))})},buildParentNode(t,i,s,n){var a=this,d=e("<table>");i.relationship=i.relationship||"001",e.when(this.createNode(i,0,s||t.closest(".orgchart").data("options"))).done(function(e){d.append(e.removeClass("slide-up").addClass("slide-down").wrap('<tr class="hidden"><td colspan="2"></td></tr>').closest("tr")),d.append('<tr class="lines hidden"><td colspan="2"><div class="downLine"></div></td></tr>');d.append('<tr class="lines hidden"><td class="rightLine">&nbsp;</td><td class="leftLine">&nbsp;</td></tr>');var t=a.$chart;t.prepend(d).children("table:first").append('<tr class="nodes"><td colspan="2"></td></tr>').children("tr:last").children().append(t.children("table").last()),n()}).fail(function(){console.log("Failed to create parent node")})},addParent(e,t,i){var s=this;this.buildParentNode(e,t,i,function(){e.children(".topEdge").length||e.children(".title").after('<i class="edge verticalEdge topEdge fa"></i>'),s.showParent(e)})},complementLine(e,t,i){for(var s="",n=0;n<i;n++)s+='<td class="leftLine topLine">&nbsp;</td><td class="rightLine topLine">&nbsp;</td>';e.parent().prevAll("tr:gt(0)").children().attr("colspan",2*t).end().next().children(":first").after(s)},buildSiblingNode(t,i,s,n){var a=this,s=s||t.closest(".orgchart").data("options"),d=i.siblings?i.siblings.length:i.children.length,o=t.parent().is("td")?t.closest("tr").children().length:1,l=o+d,r=l>1?Math.floor(l/2-1):0;if(t.parent().is("td")){t.closest("tr").prevAll("tr:last");t.closest("tr").prevAll("tr:lt(2)").remove();var c=0;this.buildChildNode(t.parent().closest("table"),i,s,function(){if(++c===d){var e=t.parent().closest("table").children("tr:last").children("td");o>1?(a.complementLine(e.eq(0).before(t.closest("td").siblings().addBack().unwrap()),l,o),e.addClass("hidden").find(".node").addClass("slide-left")):(a.complementLine(e.eq(r).after(t.closest("td").unwrap()),l,1),e.not(":eq("+r+"1)").addClass("hidden").slice(0,r).find(".node").addClass("slide-right").end().end().slice(r).find(".node").addClass("slide-left")),n()}})}else{var h=0;this.buildHierarchy(t.closest(".orgchart"),i,0,s,function(){++h===l&&(a.complementLine(t.next().children("tr:last").children().eq(r).after(e('<td colspan="2">').append(t)),l,1),t.closest("tr").siblings().eq(0).addClass("hidden").find(".node").addClass("slide-down"),t.parent().siblings().addClass("hidden").slice(0,r).find(".node").addClass("slide-right").end().end().slice(r).find(".node").addClass("slide-left"),n())})}},addSiblings(e,t,i){var s=this;this.buildSiblingNode(e.closest("table"),t,i,function(){e.closest(".nodes").data("siblingsLoaded",!0),e.children(".leftEdge").length||e.children(".topEdge").after('<i class="edge horizontalEdge rightEdge fa"></i><i class="edge horizontalEdge leftEdge fa"></i>'),s.showSiblings(e)})},removeNodes(e){var t=e.closest("table").parent(),i=t.parent().siblings();t.is("td")?this.getNodeState(e,"siblings").exist?(i.eq(2).children(".topLine:lt(2)").remove(),i.slice(0,2).children().attr("colspan",i.eq(2).children().length),t.remove()):i.eq(0).children().removeAttr("colspan").find(".bottomEdge").remove().end().end().siblings().remove():t.add(t.siblings()).remove()}},e.fn.orgchart=function(e){return new n(this,e).init()}});