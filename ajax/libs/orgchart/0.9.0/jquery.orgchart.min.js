"use strict";!function(e){function t(e){if(e.children(".spinner").length>0)return{};var t=e.closest("table").parent();return t.is("td")?t.closest("tr").siblings().is(":visible")?{exist:!0,visible:!0}:{exist:!0,visible:!1}:{exist:!1,visible:!1}}function n(e){if(e.children(".spinner").length>0)return{};var t=e.closest("table").parent("td").siblings();return t.length>0?t.is(":visible")?{exist:!0,visible:!0}:{exist:!0,visible:!1}:{exist:!1,visible:!1}}function i(e,s){var r=e.closest("table").parent();r.parent().siblings(".node-cells").find(".spinner").length>0&&e.closest("div.orgchart").data("inAjax",!1),n(e).visible&&a(e,!1);var d=r.parent().siblings(),l=d.slice(1);l.css("visibility","hidden");var o=l.eq(0).outerHeight()+l.eq(1).outerHeight(),c=d.eq(0).find("div.node"),p=t(c).visible;return c.length>0&&c.is(":visible")&&c.animate({opacity:0,top:+o},300,function(){c.removeAttr("style"),l.removeAttr("style"),d.hide(),!c.closest("table").parent().is(".orgchart")&&p||s.resolve()}),c.length>0&&p&&i(c,s),s.promise()}function s(t,n,i,s){n.length>0&&e.when(n.find("div.node").animate({opacity:0,left:i},300)).done(function(){n.hide(),t&&n.closest(".orgchart").css("opacity",0),n.parent().prev().prev().removeAttr("style");var e=n.parent().prev().children();e.eq(0).removeAttr("style"),e.eq(e.length-1).removeAttr("style"),s.resolve()})}function a(t,n){var i=e.Deferred(),a=t.closest("table").parent();a.siblings().find(".spinner").length>0&&t.closest("div.orgchart").data("inAjax",!1);var r=t.outerWidth();a.parent().prev().prev().css("visibility","hidden");var d=a.parent().prev().children();return d.slice(1,d.length-1).hide(),d.eq(0).css("visibility","hidden"),d.eq(d.length-1).css("visibility","hidden"),s(n,a.prevAll(),+r,i),s(n,a.nextAll(),-r,i),i.promise()}function r(t,n,i){var s=n.closest("div.orgchart");return(void 0===s.data("inAjax")||!0!==s.data("inAjax"))&&(t.hide(),n.append('<i class="fa fa-circle-o-notch fa-spin spinner"></i>'),n.children().not(".spinner").css("opacity",.2),s.data("inAjax",!0),e(".oc-export-btn"+(""!==i.chartClass?"."+i.chartClass:"")).prop("disabled",!0),!0)}function d(t,n,i){var s=n.closest("div.orgchart");t.show(),n.find(".spinner").remove(),n.children().removeAttr("style"),s.data("inAjax",!1),e(".oc-export-btn"+(""!==i.chartClass?"."+i.chartClass:"")).prop("disabled",!1)}function l(e){return e.children(".edge").attr("class").indexOf("fa-")>-1}function o(e){e.toggleClass("fa-chevron-up").toggleClass("fa-chevron-down")}function c(e){p(e,!1),e.children(".topEdge").removeClass("fa-chevron-up").addClass("fa-chevron-down"),e.children(".topEdge").data("parentState").visible=!0}function p(e,t){t?(e.children(".leftEdge").removeClass("fa-chevron-right").addClass("fa-chevron-left"),e.children(".rightEdge").removeClass("fa-chevron-left").addClass("fa-chevron-right")):(e.children(".leftEdge").removeClass("fa-chevron-left").addClass("fa-chevron-right"),e.children(".rightEdge").removeClass("fa-chevron-right").addClass("fa-chevron-left"))}function h(s,h){var f=e("<div>",{id:s[h.nodeId]}).addClass("node").append('<div class="title">'+s[h.nodeTitle]+"</div>").append(void 0!==h.nodeContent?'<div class="content">'+s[h.nodeContent]+"</div>":"");return Number(s[h.nodeRelationship].substr(0,1))&&f.append('<i class="edge verticalEdge topEdge fa"></i>'),Number(s[h.nodeRelationship].substr(1,1))&&f.append('<i class="edge horizontalEdge rightEdge fa"></i><i class="edge horizontalEdge leftEdge fa"></i>'),Number(s[h.nodeRelationship].substr(2,1))&&(f.find(".title").prepend('<i class="fa fa-users symbol"></i>'),f.append('<i class="edge verticalEdge bottomEdge fa"></i>')),f.on("mouseenter mouseleave",function(i){var s,a=e(this),r=(a.children(".edge"),a.children(".topEdge")),d=a.children(".rightEdge"),l=a.children(".bottomEdge"),o=a.children(".leftEdge");"mouseenter"===i.type?(r.length&&(s=t(a),e.isEmptyObject(s)||r.data("parentState",s),r.data("parentState").visible?r.removeClass("fa-chevron-up").addClass("fa-chevron-down"):r.removeClass("fa-chevron-down").addClass("fa-chevron-up")),l.length&&(s=function(e){if(e.children(".spinner").length>0)return{};var t=e.closest("tr").siblings();return t.length>0?t.is(":visible")?{exist:!0,visible:!0}:{exist:!0,visible:!1}:{exist:!1,visible:!1}}(a),e.isEmptyObject(s)||l.data("childrenState",s),l.data("childrenState").visible?l.removeClass("fa-chevron-down").addClass("fa-chevron-up"):l.removeClass("fa-chevron-up").addClass("fa-chevron-down")),o.length&&(s=n(a),e.isEmptyObject(s)||(d.data("siblingsState",s),o.data("siblingsState",s)),o.data("siblingsState").visible?p(a,!1):p(a,!0))):(r.add(l).removeClass("fa-chevron-up fa-chevron-down"),d.add(o).removeClass("fa-chevron-right fa-chevron-left"))}),f.on("click",function(t){var n=e(this);n.closest(".orgchart").find(".focused").removeClass("focused"),n.addClass("focused")}),f.children(".topEdge").on("click",function(t){var n=e(this),s=n.parent(),a=n.data("parentState");if(s.children(".spinner").length>0)return!1;if(a.exist){if(s.closest("table").closest("tr").siblings(":first").find("div.node").is(":animated"))return;if(a.visible){var c=e.Deferred();e.when(i(s,c)).done(function(){a.visible=!1,s.children(".leftEdge").length>0&&(s.children(".leftEdge").data("siblingsState").visible=!1,s.children(".rightEdge").data("siblingsState").visible=!1),l(s)&&(o(n),p(s,!0))}).fail(function(){console.log("failed to adjust the position of org-chart!")})}else e.when(function(t){var n=e.Deferred(),i=t.closest("table").closest("tr").siblings().show();return i.eq(2).children().slice(1,i.eq(2).children().length-1).hide(),n.resolve(),i.eq(0).find("div.node").animate({opacity:1,top:0},300,function(){e(this).removeAttr("style")}),n.promise()}(s)).done(function(){a.visible=!0,o(n)}).fail(function(){console.log("failed to adjust the position of org-chart!")})}else{var f=n.parent()[0].id;r(n,s,h)&&e.ajax({url:h.ajaxURL.parent+f+"/",dataType:"json"}).done(function(t,i,r){!0===s.closest("div.orgchart").data("inAjax")&&(e.isEmptyObject(t)||e.when(g(t,n.closest("table"),h)).done(function(){a.visible=!0,l(s)&&o(n)}).fail(function(){console.log("failed to adjust the position of org-chart!")}),a.exist=!0),d(n,s,h)}).fail(function(e,t,i){console.log(i),a.exist=!0,d(n,s,h)})}}),f.children(".bottomEdge").on("click",function(t){var n=e(this),i=n.parent(),s=n.data("childrenState");if(i.children(".spinner").length>0)return!1;if(s.exist){if(i.closest("tr").siblings(":last").find("div.node").is(":animated"))return;s.visible?e.when(function(t){var n=e.Deferred();t.closest("tr").siblings(":last").find(".spinner").length>0&&t.closest("div.orgchart").data("inAjax",!1);var i=t.closest("tr").siblings(":lt(2)");i.css("visibility","hidden");var s=i.eq(0).outerHeight()+i.eq(1).outerHeight();return e.when(t.closest("tr").siblings(":last").find("div.node").animate({opacity:0,top:-s},300)).done(function(){i.removeAttr("style"),t.closest("tr").siblings().hide(),n.resolve()}),n.promise()}(i)).done(function(){s.visible=!1,l(i)&&o(n)}).fail(function(){console.log("failed to adjust the position of org-chart!")}):e.when(function(t){var n=e.Deferred(),i=t.closest("tr").siblings().show();n.resolve();var s=i.eq(2).children("td").length>1?i.eq(2).find("div.node"):i.eq(2).find("tr:first").find("div.node");return e.when(s.animate({opacity:1,top:0},300)).done(function(){s.removeAttr("style")}),s.each(function(t,n){e(n).closest("tr").siblings().hide()}),n.promise()}(i)).done(function(){s.visible=!0,o(n)}).fail(function(){console.log("failed to adjust the position of org-chart!")})}else{var a=n.parent()[0].id;r(n,i,h)&&e.ajax({url:h.ajaxURL.children+a+"/",dataType:"json"}).done(function(t,a,r){if(!0===i.closest("div.orgchart").data("inAjax")){if(0!==t.children.length){var c=t.children.length,p=e.Deferred(),f=0;e.when(v(t,n.closest("tbody"),!1,h,function(){if(++f===c+1)return p.resolve(),p.promise()})).done(function(){s.visible=!0,l(i)&&o(n)}).fail(function(){console.log("failed to adjust the position of org-chart!")})}s.exist=!0}d(n,i,h)}).fail(function(e,t,a){console.log(a),s.exist=!0,d(n,i,h)})}}),f.children(".leftEdge, .rightEdge").on("click",function(t){var n=e(this),i=n.parent(),s=n.data("siblingsState");if(i.children(".spinner").length>0)return!1;if(s.exist){if(i.closest("table").parent().siblings().find("div.node").is(":animated"))return;s.visible?e.when(a(i,!0)).done(function(){setTimeout(function(){i.closest(".orgchart").css("opacity",""),s.visible=!1,l(i)&&p(i,!0)},0)}).fail(function(){console.log("failed to adjust the position of org-chart!")}):e.when(function(t){var n=e.Deferred(),i=t.closest("table").parent().siblings().show(),s=t.closest("table").closest("tr").siblings(),a=s.eq(2).children();return a.slice(1,a.length-1).show(),t.children(".topEdge").data("parentState").visible?i.each(function(t,n){e(n).find("div.node").closest("tr").siblings().hide()}):s.show(),n.resolve(),i.find("div.node").animate({opacity:1,left:0},300),n.promise()}(i)).done(function(){s.visible=!0,c(i)}).fail(function(){console.log("failed to adjust the position of org-chart!")})}else{var o=n.parent()[0].id,f=!n.siblings(".topEdge").data("parentState").exist?h.ajaxURL.families:h.ajaxURL.siblings;r(n,i,h)&&e.ajax({url:f+o+"/",dataType:"json"}).done(function(t,a,r){!0===i.closest("div.orgchart").data("inAjax")&&((t.siblings||t.children)&&e.when(b(t,n.closest("table"),h)).done(function(){s.visible=!0,l(i)&&c(i)}).fail(function(){console.log("failed to adjust the position of org-chart!")}),i.children(".topEdge").data("parentState").exist=!0,s.exist=!0,n.is(".leftEdge")?n.siblings(".rightEdge").data("siblingsState",{exist:!0,visible:!0}):n.siblings(".leftEdge").data("siblingsState",{exist:!0,visible:!0})),d(n,i,h)}).fail(function(e,t,a){console.log(a),s.exist=!0,d(n,i,h)})}}),f.children(".leftEdge").hover(function(){var t=e(this).siblings(".rightEdge");n(e(this)).visible?t.addClass("rightEdgeTransitionToLeft"):t.addClass("rightEdgeTransitionToRight")},function(){e(this).siblings(".rightEdge").removeClass("rightEdgeTransitionToRight rightEdgeTransitionToLeft")}),h.createNode&&h.createNode(f,s),f}function f(t,n,i,s,a){var r=e("<table cellpadding='0' cellspacing='0' border='0'/>"),d=e("<tbody/>"),l=e("<tr/>").addClass("node-cells"),o=e("<td/>").addClass("node-cell").attr("colspan",2),c=t[s.nodeChildren];c&&c.length>1&&o.attr("colspan",2*c.length);var p=h(t,s);if(o.append(p),l.append(o),d.append(l),c&&c.length>0){var v,g=e("<tr/>"),u=e("<td/>").attr("colspan",2*c.length);g.append(u);var b=e("<div></div>").addClass("down");u.append(b),i+1<s.depth?d.append(g):d.append(g.hide());var m=e("<tr/>");e.each(c,function(){var t=e("<td>&nbsp;</td>").addClass("right top"),n=e("<td>&nbsp;</td>").addClass("left top");m.append(t).append(n)}),m.find("td:first").removeClass("top").end().find("td:last").removeClass("top"),i+1<s.depth?d.append(m):d.append(m.hide()),v=e("<tr/>"),e.each(c,function(){var t=e("<td class='node-container'/>");t.attr("colspan",2),a?f(this,t,i+1,s,a):f(this,t,i+1,s),i+1<s.depth?v.append(t):v.append(t).hide()}),d.append(v)}r.append(d),n.append(r),a&&a()}function v(t,n,i,s,a){var r,d,l=t.children||t.siblings;if(i){r=e("<table cellpadding='0' cellspacing='0' border='0'/>"),d=e("<tbody/>");var o=e("<tr/>").addClass("node-cells"),c=e("<td/>").addClass("node-cell").attr("colspan",2),p=h(t,s);c.append(p),o.append(c),d.append(o)}else n.children("tr:first").children("td:first").attr("colspan",2*l.length);if(l&&l.length>0){var f=e("<tr/>"),g=e("<td/>").attr("colspan",2*l.length);f.append(g);var u=e("<div></div>").addClass("down");g.append(u),i?d.append(f):n.append(f);var b=e("<tr/>");e.each(l,function(){var t=e("<td>&nbsp;</td>").addClass("right top"),n=e("<td>&nbsp;</td>").addClass("left top");b.append(t).append(n)}),b.find("td:first").removeClass("top").end().find("td:last").removeClass("top"),i?d.append(b):n.append(b);var m=e("<tr/>");e.each(l,function(){var t=e("<td class='node-container'/>");t.attr("colspan",2),a?v(this,t,!0,s,a):v(this,t,!0,s),m.append(t)}),i?d.append(m):n.append(m)}i&&(r.append(d),n.append(r)),a&&a()}function g(t,n,i){var s=e.Deferred(),a=e("<table cellpadding='0' cellspacing='0' border='0'/>"),r=e("<tbody/>"),d=e("<tr/>").addClass("node-cells"),l=e("<td/>").addClass("node-cell").attr("colspan",2),o=h(t,i);l.append(o),d.append(l),r.append(d);var c=e("<tr/>"),p=e("<td/>").attr("colspan",2);c.append(p);var f=e("<div></div>").addClass("down");p.append(f),r.append(c);var v=e("<tr/>"),g=e("<td>&nbsp;</td>").addClass("right top"),u=e("<td>&nbsp;</td>").addClass("left top");return v.append(g).append(u),v.find("td:first").removeClass("top").end().find("td:last").removeClass("top"),r.append(v),n.closest("div.orgchart").prepend(a.append(r)).find("tbody:first").append(e("<tr/>").append(e('<td class="node-container" colspan="2" />').append(n))),s.resolve(),s.promise()}function u(t,n){t.parent().prevAll("tr:gt(0)").children("td").attr("colspan",2*(n+1)).end().next().children("td").eq(0).after(e('<td class="left top">&nbsp;</td><td class="right top">&nbsp;</td>'))}function b(t,n,i){var s=e.Deferred(),a=t.siblings?t.siblings.length:t.children.length,r=a>1?Math.floor(a/2-1):0;if(n.parent().is("td.node-container")){var d=n.closest("tr").prevAll("tr:last");d.is(":hidden")&&d.show(),n.closest("tr").prevAll("tr:lt(2)").remove();var l=0;v(t,n.closest("tbody"),!1,i,function(){if(++l===a+1)return u(n.closest("tbody").children("tr:last").children("td").eq(r).after(n.closest("td").unwrap()),a),s.resolve(),s.promise()})}else{var o=0;f(t,n.closest("div.orgchart"),0,i,function(){if(++o===a+1)return u(n.next().children("tbody:first").children("tr:last").children("td").eq(r).after(e('<td class="node-container" colspan="2" />').append(n)),a),s.resolve(),s.promise()})}}e.fn.orgchart=function(t){var n=e.extend({nodeRelationship:"relationship",nodeChildren:"children",depth:999,chartClass:"",exportButton:!1,exportFilename:"OrgChart"},t);switch(t){case"buildNode":return f.apply(this,Array.prototype.splice.call(arguments,1));case"buildChildNode":return v.apply(this,Array.prototype.splice.call(arguments,1));case"buildParentNode":return g.apply(this,Array.prototype.splice.call(arguments,1));case"buildSiblingNode":return b.apply(this,Array.prototype.splice.call(arguments,1))}var i=this,s=n.data,a=e("<div>",{class:"orgchart"+(""!==n.chartClass?" "+n.chartClass:""),click:function(t){e(t.target).closest(".node").length||a.find(".node.focused").removeClass("focused")}});if("object"===e.type(s)?f(s,a,0,n):e.ajax({url:s,dataType:"json",beforeSend:function(){a.append('<i class="fa fa-circle-o-notch fa-spin spinner"></i>')}}).done(function(e,t,i){f(e,a,0,n)}).fail(function(e,t,n){console.log(n)}).always(function(){a.children(".spinner").remove()}),i.append(a),n.exportButton){var r=e("<button>",{class:"oc-export-btn"+(""!==n.chartClass?" "+n.chartClass:""),text:"Export",click:function(){if(e(this).children(".spinner").length>0)return!1;var t=i.find(".mask");t.length?t.removeClass("hidden"):i.append('<div class="mask"><i class="fa fa-circle-o-notch fa-spin spinner"></i></div>'),html2canvas(a[0],{onrendered:function(e){i.find(".mask").addClass("hidden").end().find(".oc-download-btn").attr("href",e.toDataURL())[0].click()}})}}),d='<a class="oc-download-btn'+(""!==n.chartClass?" "+n.chartClass:"")+'" download="'+n.exportFilename+'.png"></a>';i.append(r).append(d)}return i}}(jQuery);