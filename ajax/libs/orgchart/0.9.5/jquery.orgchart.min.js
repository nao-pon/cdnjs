!function(e){"use strict";function s(e,s){var n={};return(n="parent"===s?e.closest("table").closest("tr").siblings(":first").find(".node"):"children"===s?e.closest("tr").siblings():e.closest("table").parent().siblings()).length?n.is(":visible")?{exist:!0,visible:!0}:{exist:!0,visible:!1}:{exist:!1,visible:!1}}function n(e){var t=e.closest("table").closest("tr").siblings();t.eq(0).find(".spinner").length&&e.closest(".orgchart").data("inAjax",!1),s(e,"siblings").visible&&l(e);var i=t.slice(1);i.css("visibility","hidden");var a=t.eq(0).find(".node"),d=s(a,"parent").visible;a.length&&a.is(":visible")&&a.addClass("slide slide-down").one("transitionend",function(){a.removeClass("slide"),i.removeAttr("style"),t.addClass("hidden")}),a.length&&d&&n(a)}function t(s){var n=s.closest("table").closest("tr").siblings().removeClass("hidden");n.eq(2).children().slice(1,-1).addClass("hidden");var t=n.eq(0).find(".node")[0];f(t),e(t).addClass("slide").removeClass("slide-down").one("transitionend",function(){e(t).removeClass("slide"),o(s)&&c(s.children(".topEdge"))})}function i(e){var s=e.closest("tr").siblings().removeClass("hidden").eq(2).children().find("tr:first").find(".node:visible");f(s.get(0)),s.addClass("slide").removeClass("slide-up").eq(0).one("transitionend",function(){s.removeClass("slide"),o(e)&&c(e.children(".bottomEdge"))})}function l(e){var s=e.closest("table").parent();s.siblings().find(".spinner").length&&e.closest(".orgchart").data("inAjax",!1),s.prevAll().find(".node:visible").addClass("slide slide-right"),s.nextAll().find(".node:visible").addClass("slide slide-left");var n=s.siblings().find(".slide"),t=n.closest(".nodes").prevAll(".lines").css("visibility","hidden");n.eq(0).one("transitionend",function(){t.removeAttr("style"),s.closest(".nodes").prev().children().slice(1,-1).addClass("hidden"),n.removeClass("slide"),s.siblings().find(".node:visible:gt(0)").removeClass("slide-left slide-right").addClass("slide-up"),s.siblings().find(".lines, .nodes").addClass("hidden"),s.siblings().addClass("hidden"),o(e)&&h(e,!0)})}function a(n){var t=n.closest("table").parent().siblings().removeClass("hidden"),i=n.closest("table").closest("tr").siblings();if(i.eq(2).children().slice(1,-1).removeClass("hidden"),!s(n,"parent").visible){i.removeClass("hidden");var l=i.find(".node")[0];f(l),e(l).addClass("slide").removeClass("slide-down").one("transitionend",function(){e(this).removeClass("slide")})}t.find(".node:visible").addClass("slide").removeClass("slide-left slide-right").eq(0).one("transitionend",function(){t.find(".node:visible").removeClass("slide"),o(n)&&function(e){h(e,!1),e.children(".topEdge").removeClass("fa-chevron-up").addClass("fa-chevron-down")}(n)})}function d(s,n,t){var i=n.closest(".orgchart");return(void 0===i.data("inAjax")||!0!==i.data("inAjax"))&&(s.addClass("hidden"),n.append('<i class="fa fa-circle-o-notch fa-spin spinner"></i>'),n.children().not(".spinner").css("opacity",.2),i.data("inAjax",!0),e(".oc-export-btn"+(""!==t.chartClass?"."+t.chartClass:"")).prop("disabled",!0),!0)}function r(s,n,t){var i=n.closest("div.orgchart");s.removeClass("hidden"),n.find(".spinner").remove(),n.children().removeAttr("style"),i.data("inAjax",!1),e(".oc-export-btn"+(""!==t.chartClass?"."+t.chartClass:"")).prop("disabled",!1)}function o(e){return e.children(".edge").attr("class").indexOf("fa-")>-1}function c(e){e.toggleClass("fa-chevron-up").toggleClass("fa-chevron-down")}function h(e,s){e.children(".leftEdge").toggleClass("fa-chevron-right",!s).toggleClass("fa-chevron-left",s),e.children(".rightEdge").toggleClass("fa-chevron-left",!s).toggleClass("fa-chevron-right",s)}function f(e){e.style.offsetWidth=e.offsetWidth}function p(f,p,g){var v=e.Deferred(),C=e("<div>",{id:f[g.nodeId]}).addClass("node"+(p>=g.depth?" slide-up":"")).append('<div class="title">'+f[g.nodeTitle]+"</div>").append(void 0!==g.nodeContent?'<div class="content">'+f[g.nodeContent]+"</div>":""),E=f[g.nodeRelationship];return Number(E.substr(0,1))&&C.append('<i class="edge verticalEdge topEdge fa"></i>'),Number(E.substr(1,1))&&C.append('<i class="edge horizontalEdge rightEdge fa"></i><i class="edge horizontalEdge leftEdge fa"></i>'),Number(E.substr(2,1))&&C.append('<i class="edge verticalEdge bottomEdge fa"></i>').children(".title").prepend('<i class="fa '+g.parentNodeSymbol+' symbol"></i>'),C.on("mouseenter mouseleave",function(n){var t=e(this),i=!1,l=t.children(".topEdge"),a=(t.children(".rightEdge"),t.children(".bottomEdge")),d=t.children(".leftEdge");"mouseenter"===n.type?(l.length&&(i=s(t,"parent").visible,l.toggleClass("fa-chevron-up",!i).toggleClass("fa-chevron-down",i)),a.length&&(i=s(t,"children").visible,a.toggleClass("fa-chevron-down",!i).toggleClass("fa-chevron-up",i)),d.length&&h(t,!s(t,"siblings").visible)):t.children(".edge").removeClass("fa-chevron-up fa-chevron-down fa-chevron-right fa-chevron-left")}),C.on("click",function(s){e(this).closest(".orgchart").find(".focused").removeClass("focused"),e(this).addClass("focused")}),C.on("click",".topEdge",function(i){var l=e(this),a=l.parent(),f=s(a,"parent");if(f.exist){var p=a.closest("table").closest("tr").siblings(":first").find(".node");if(p.is(".slide"))return;f.visible?(n(a),p.one("transitionend",function(){o(a)&&(c(l),h(a,!0))})):t(a)}else{var v=l.parent()[0].id;d(l,a,g)&&e.ajax({url:g.ajaxURL.parent+v+"/"}).done(function(s){a.closest("div.orgchart").data("inAjax")&&(e.isEmptyObject(s)||b(a,s,g))}).fail(function(){console.log("Failed to get parent node data")}).always(function(){r(l,a,g)})}}),C.children(".bottomEdge").on("click",function(n){var t=e(this),l=t.parent(),a=s(l,"children");if(a.exist){if(l.closest("tr").siblings(":last").find(".node:visible").is(".slide"))return;a.visible?function(e){var s=e.closest("tr").siblings();s.last().find(".spinner").length&&e.closest(".orgchart").data("inAjax",!1);var n=s.last().find(".node:visible"),t=n.closest("table").closest("tr").prevAll(".lines").css("visibility","hidden");n.addClass("slide slide-up").eq(0).one("transitionend",function(){n.removeClass("slide"),t.removeAttr("style").addClass("hidden").siblings(".nodes").addClass("hidden"),o(e)&&c(e.children(".bottomEdge"))})}(l):i(l)}else{var h=t.parent()[0].id;d(t,l,g)&&e.ajax({url:g.ajaxURL.children+h+"/"}).done(function(s,n,t){l.closest(".orgchart").data("inAjax")&&s.children.length&&u(l,s,e.extend({},g,{depth:0}))}).fail(function(e,s,n){console.log("Failed to get children nodes data")}).always(function(){r(t,l,g)})}}),C.on("click",".leftEdge, .rightEdge",function(n){var t=e(this),i=t.parent(),o=s(i,"siblings");if(o.exist){if(i.closest("table").parent().siblings().find(".node:visible").is(".slide"))return;o.visible?l(i):a(i)}else{var c=t.parent()[0].id,h=s(i,"parent").exist?g.ajaxURL.siblings:g.ajaxURL.families;d(t,i,g)&&e.ajax({url:h+c+"/"}).done(function(e,s,n){i.closest(".orgchart").data("inAjax")&&(e.siblings||e.children)&&m(i,e,g)}).fail(function(e,s,n){console.log("Failed to get sibling nodes data")}).always(function(){r(t,i,g)})}}),C.children(".leftEdge").on("mouseenter mouseleave",function(n){if("mouseenter"===n.type){var t=e(this).siblings(".rightEdge");s(e(this),"siblings").visible?t.addClass("rightEdgeMoveLeft"):t.addClass("rightEdgeMoveRight")}else e(this).siblings(".rightEdge").removeClass("rightEdgeMoveRight rightEdgeMoveLeft")}),g.createNode&&g.createNode(C,f),v.resolve(C),v.promise()}function g(s,n,t,i,l){var a,d=n[i.nodeChildren],r=!!d&&d.length;if(Object.keys(n).length>1&&(a=e("<table>"),s.append(a),e.when(p(n,t,i)).done(function(e){a.append(e.wrap("<tr><td"+(r?' colspan="'+2*d.length+'"':"")+"></td></tr>").closest("tr")),l&&l()}).fail(function(){console.log("Failed to creat node")})),r){1===Object.keys(n).length&&(a=s);var o=t+1>=i.depth?" hidden":"";a.append('<tr class="lines'+o+'"><td colspan="'+2*d.length+'"><div class="down"></div></td></tr>');for(var c='<tr class="lines'+o+'"><td class="right">&nbsp;</td>',h=1;h<d.length;h++)c+='<td class="left top">&nbsp;</td><td class="right top">&nbsp;</td>';c+='<td class="left">&nbsp;</td></tr>',a.append(c);var f=e('<tr class="nodes'+o+'">');a.append(f),e.each(d,function(){var s=e('<td colspan="2">');f.append(s),g(s,this,t+1,i,l)})}}function v(e,s,n,t){var i=s.children||s.siblings;e.find("td:first").attr("colspan",2*i.length),g(e,{children:i},0,n,t)}function u(e,s,n){var t=0;v.call(e.closest(".orgchart").parent(),e.closest("table"),s,n,function(){++t===s.children.length&&i(e)})}function b(s,n,i){(function(s,n,t){var i=this,l=e("<table>");s[n&&n.nodeRelationship?n.nodeRelationship:"relationship"]="001",e.when(p(s,0,n||this.data("orgchart").options)).done(function(e){l.append(e.removeClass("slide-up").addClass("slide-down").wrap('<tr class="hidden"><td colspan="2"></td></tr>').closest("tr")),l.append('<tr class="lines hidden"><td colspan="2"><div class="down"></div></td></tr>'),l.append('<tr class="lines hidden"><td class="right">&nbsp;</td><td class="left">&nbsp;</td></tr>');var s=i.children(".orgchart");s.prepend(l).children("table:first").append('<tr class="nodes"><td colspan="2"></td></tr>').children().children("tr:last").children().append(s.children("table").last()),t()}).fail(function(){console.log("Failed to create parent node")})}).call(s.closest(".orgchart").parent(),n,i,function(){s.children(".topEdge").length||s.children(".title").after('<i class="edge verticalEdge topEdge fa"></i>'),t(s)})}function C(e,s,n){for(var t="",i=0;i<n;i++)t+='<td class="left top">&nbsp;</td><td class="right top">&nbsp;</td>';e.parent().prevAll("tr:gt(0)").children().attr("colspan",2*s).end().next().children(":first").after(t)}function m(s,n,t){(function(s,n,t,i){var t=t||this.data("orgchart").options,l=n.siblings?n.siblings.length:n.children.length,a=s.parent().is("td")?s.closest("tr").children().length:1,d=a+l,r=d>1?Math.floor(d/2-1):0;if(s.parent().is("td")){var o=s.closest("tr").prevAll("tr:last");o.is(":hidden")&&o.removeClass("hidden"),s.closest("tr").prevAll("tr:lt(2)").remove();var c=0;v.call(s.closest(".orgchart").parent(),s.parent().closest("table"),n,t,function(){if(++c===l){var e=s.parent().closest("table").children().children("tr:last").children("td");a>1?C(e.eq(0).before(s.closest("td").siblings().andSelf().unwrap()),d,a):(C(e.eq(r).after(s.closest("td").unwrap()),d,1),e.not(":eq("+r+"1)").addClass("hidden").slice(0,r).find(".node").addClass("slide-right").end().end().slice(r).find(".node").addClass("slide-left")),i()}})}else{var h=0;g(s.closest(".orgchart"),n,0,t,function(){++h===d&&(C(s.next().children().children("tr:last").children().eq(r).after(e('<td colspan="2">').append(s)),d,1),s.closest("tr").siblings().eq(0).addClass("hidden").find(".node").addClass("slide-down"),s.parent().siblings().addClass("hidden").slice(0,r).find(".node").addClass("slide-right").end().end().slice(r).find(".node").addClass("slide-left"),i())})}}).call(s.closest(".orgchart").parent(),s.closest("table"),n,t,function(){s.children(".leftEdge").length||s.children(".topEdge").after('<i class="edge horizontalEdge rightEdge fa"></i>').siblings(".bottomEdge").after('<i class="edge horizontalEdge leftEdge fa"></i>'),a(s)})}e.fn.orgchart=function(s){switch(s){case"buildHierarchy":return g.apply(this,Array.prototype.splice.call(arguments,1));case"addChildren":return u.apply(this,Array.prototype.splice.call(arguments,1));case"addParent":return b.apply(this,Array.prototype.splice.call(arguments,1));case"addSiblings":return m.apply(this,Array.prototype.splice.call(arguments,1));default:var n=e.extend({nodeRelationship:"relationship",nodeChildren:"children",depth:999,chartClass:"",exportButton:!1,exportFilename:"OrgChart",parentNodeSymbol:"fa-users"},s);this.data("orgchart",{options:n})}var t=this,i=n.data,l=e("<div>",{class:"orgchart"+(""!==n.chartClass?" "+n.chartClass:""),click:function(s){e(s.target).closest(".node").length||l.find(".node.focused").removeClass("focused")}});if("object"===e.type(i)?g(l,i,0,n):e.ajax({url:i,beforeSend:function(){l.append('<i class="fa fa-circle-o-notch fa-spin spinner"></i>')}}).done(function(e,s,t){g(l,e,0,n)}).fail(function(e,s,n){console.log(n)}).always(function(){l.children(".spinner").remove()}),t.append(l),n.exportButton){var a=e("<button>",{class:"oc-export-btn"+(""!==n.chartClass?" "+n.chartClass:""),text:"Export",click:function(){if(e(this).children(".spinner").length)return!1;var s=t.find(".mask");s.length?s.removeClass("hidden"):t.append('<div class="mask"><i class="fa fa-circle-o-notch fa-spin spinner"></i></div>'),html2canvas(l[0],{onrendered:function(e){t.find(".mask").addClass("hidden").end().find(".oc-download-btn").attr("href",e.toDataURL())[0].click()}})}}),d='<a class="oc-download-btn'+(""!==n.chartClass?" "+n.chartClass:"")+'" download="'+n.exportFilename+'.png"></a>';t.append(a).append(d)}return t}}(jQuery);