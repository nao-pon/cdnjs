!function(e){"use strict";function t(e,t){var n={};return(n="parent"===t?e.closest("table").parent().closest("tr").siblings():"children"===t?e.closest("tr").siblings():e.closest("table").parent().siblings()).length?n.is(":visible")?{exist:!0,visible:!0}:{exist:!0,visible:!1}:{exist:!1,visible:!1}}function n(e,i){e.closest("table").closest("tr").siblings(":first").find(".spinner").length&&e.closest("div.orgchart").data("inAjax",!1),t(e,"siblings").visible&&s(e,!1);var a=e.closest("table").closest("tr").siblings(),r=a.slice(1);r.css("visibility","hidden");var l=r.eq(0).outerHeight()+r.eq(1).outerHeight(),o=a.eq(0).find("div.node"),d=t(o,"parent").visible;return o.length&&o.is(":visible")&&o.animate({opacity:0,top:+l},300,function(){o.removeAttr("style"),r.removeAttr("style"),a.addClass("hidden"),!o.closest("table").parent().is(".orgchart")&&d||i.resolve()}),o.length&&d&&n(o,i),i.promise()}function i(t,n,i,s){n.length>0&&e.when(n.find("div.node").animate({opacity:0,left:i},300)).done(function(){n.addClass("hidden"),t&&n.closest(".orgchart").css("opacity",0),n.parent().prev().prev().removeAttr("style");var e=n.parent().prev().children();e.eq(0).removeAttr("style"),e.eq(e.length-1).removeAttr("style"),s.resolve()})}function s(t,n){var s=e.Deferred(),a=t.closest("table").parent();a.siblings().find(".spinner").length&&t.closest("div.orgchart").data("inAjax",!1);var r=t.outerWidth();a.parent().prev().prev().css("visibility","hidden");var l=a.parent().prev().children();return l.slice(1,l.length-1).addClass("hidden"),l.eq(0).css("visibility","hidden"),l.eq(l.length-1).css("visibility","hidden"),i(n,a.prevAll(),+r,s),i(n,a.nextAll(),-r,s),s.promise()}function a(t,n,i){var s=n.closest("div.orgchart");return(void 0===s.data("inAjax")||!0!==s.data("inAjax"))&&(t.addClass("hidden"),n.append('<i class="fa fa-circle-o-notch fa-spin spinner"></i>'),n.children().not(".spinner").css("opacity",.2),s.data("inAjax",!0),e(".oc-export-btn"+(""!==i.chartClass?"."+i.chartClass:"")).prop("disabled",!0),!0)}function r(t,n,i){var s=n.closest("div.orgchart");t.removeClass("hidden"),n.find(".spinner").remove(),n.children().removeAttr("style"),s.data("inAjax",!1),e(".oc-export-btn"+(""!==i.chartClass?"."+i.chartClass:"")).prop("disabled",!1)}function l(e){return e.children(".edge").attr("class").indexOf("fa-")>-1}function o(e){e.toggleClass("fa-chevron-up").toggleClass("fa-chevron-down")}function d(e){c(e,!1),e.children(".topEdge").removeClass("fa-chevron-up").addClass("fa-chevron-down"),e.children(".topEdge").data("parentState").visible=!0}function c(e,t){t?(e.children(".leftEdge").removeClass("fa-chevron-right").addClass("fa-chevron-left"),e.children(".rightEdge").removeClass("fa-chevron-left").addClass("fa-chevron-right")):(e.children(".leftEdge").removeClass("fa-chevron-left").addClass("fa-chevron-right"),e.children(".rightEdge").removeClass("fa-chevron-right").addClass("fa-chevron-left"))}function h(i,h){var f=e.Deferred(),p=e("<div>",{id:i[h.nodeId]}).addClass("node").append('<div class="title">'+i[h.nodeTitle]+"</div>").append(void 0!==h.nodeContent?'<div class="content">'+i[h.nodeContent]+"</div>":""),u=i[h.nodeRelationship];return Number(u.substr(0,1))&&p.append('<i class="edge verticalEdge topEdge fa"></i>'),Number(u.substr(1,1))&&p.append('<i class="edge horizontalEdge rightEdge fa"></i><i class="edge horizontalEdge leftEdge fa"></i>'),Number(u.substr(2,1))&&(p.find(".title").prepend('<i class="fa '+h.parentNodeSymbol+' symbol"></i>'),p.append('<i class="edge verticalEdge bottomEdge fa"></i>')),p.on("mouseenter mouseleave",function(n){var i,s=e(this),a=(s.children(".edge"),s.children(".topEdge")),r=s.children(".rightEdge"),l=s.children(".bottomEdge"),o=s.children(".leftEdge");"mouseenter"===n.type?(a.length&&(i=t(s,"parent"),e.isEmptyObject(i)||a.data("parentState",i),a.data("parentState").visible?a.removeClass("fa-chevron-up").addClass("fa-chevron-down"):a.removeClass("fa-chevron-down").addClass("fa-chevron-up")),l.length&&(i=t(s,"children"),e.isEmptyObject(i)||l.data("childrenState",i),l.data("childrenState").visible?l.removeClass("fa-chevron-down").addClass("fa-chevron-up"):l.removeClass("fa-chevron-up").addClass("fa-chevron-down")),o.length&&(i=t(s,"siblings"),e.isEmptyObject(i)||(r.data("siblingsState",i),o.data("siblingsState",i)),o.data("siblingsState").visible?c(s,!1):c(s,!0))):(a.add(l).removeClass("fa-chevron-up fa-chevron-down"),r.add(o).removeClass("fa-chevron-right fa-chevron-left"))}),p.on("click",function(t){var n=e(this);n.closest(".orgchart").find(".focused").removeClass("focused"),n.addClass("focused")}),p.on("click",".topEdge",function(t){var i=e(this),s=i.parent(),d=i.data("parentState");if(s.children(".spinner").length)return!1;if(d.exist){if(s.closest("table").closest("tr").siblings(":first").find("div.node").is(":animated"))return;if(d.visible){var f=e.Deferred();e.when(n(s,f)).done(function(){d.visible=!1,s.children(".leftEdge").length&&(s.children(".leftEdge").data("siblingsState").visible=!1,s.children(".rightEdge").data("siblingsState").visible=!1),l(s)&&(o(i),c(s,!0))}).fail(function(){console.log("failed to adjust the position of org-chart!")})}else e.when(function(t){var n=e.Deferred(),i=t.closest("table").closest("tr").siblings().removeClass("hidden");return i.eq(2).children().slice(1,i.eq(2).children().length-1).addClass("hidden"),n.resolve(),i.eq(0).find("div.node").animate({opacity:1,top:0},300,function(){e(this).removeAttr("style")}),n.promise()}(s)).done(function(){d.visible=!0,o(i)}).fail(function(){console.log("failed to adjust the position of org-chart!")})}else{var p=i.parent()[0].id;a(i,s,h)&&e.ajax({url:h.ajaxURL.parent+p+"/",dataType:"json"}).done(function(t,n,i){s.closest("div.orgchart").data("inAjax")&&(e.isEmptyObject(t)||v(s,t,h),d.exist=!0)}).fail(function(e,t,n){console.log("Failed to get parent node data"),d.exist=!0}).always(function(){r(i,s,h)})}}),p.children(".bottomEdge").on("click",function(t){var n=e(this),i=n.parent(),s=n.data("childrenState");if(i.children(".spinner").length)return!1;if(s.exist){if(i.closest("tr").siblings(":last").find("div.node").is(":animated"))return;s.visible?e.when(function(t){var n=e.Deferred();t.closest("tr").siblings(":last").find(".spinner").length&&t.closest("div.orgchart").data("inAjax",!1);var i=t.closest("tr").siblings(":lt(2)");i.css("visibility","hidden");var s=i.eq(0).outerHeight()+i.eq(1).outerHeight();return e.when(t.closest("tr").siblings(":last").find("div.node").animate({opacity:0,top:-s},300)).done(function(){i.removeAttr("style"),t.closest("tr").siblings().addClass("hidden"),n.resolve()}),n.promise()}(i)).done(function(){s.visible=!1,l(i)&&o(n)}).fail(function(){console.log("failed to adjust the position of org-chart!")}):e.when(function(t){var n=e.Deferred(),i=t.closest("tr").siblings().removeClass("hidden");n.resolve();var s=i.eq(2).children("td").length>1?i.eq(2).find("div.node"):i.eq(2).find("tr:first").find("div.node");return e.when(s.animate({opacity:1,top:0},300)).done(function(){s.removeAttr("style")}),s.each(function(t,n){e(n).closest("tr").siblings().addClass("hidden")}),n.promise()}(i)).done(function(){s.visible=!0,o(n)}).fail(function(){console.log("failed to adjust the position of org-chart!")})}else{var d=n.parent()[0].id;a(n,i,h)&&e.ajax({url:h.ajaxURL.children+d+"/",dataType:"json"}).done(function(t,a,l){i.closest("div.orgchart").data("inAjax")&&t.children.length&&e.when(g(i,t,h)).done(function(){s.exist=!0,r(n,i,h)}).fail(function(){console.log("Failed to add children nodes")})}).fail(function(e,t,n){console.log("Failed to get children nodes data"),s.exist=!0}).always(function(){r(n,i,h)})}}),p.on("click",".leftEdge, .rightEdge",function(t){var n=e(this),i=n.parent(),o=n.data("siblingsState");if(i.children(".spinner").length)return!1;if(o.exist){if(i.closest("table").parent().siblings().find("div.node").is(":animated"))return;o.visible?e.when(s(i,!0)).done(function(){setTimeout(function(){i.closest(".orgchart").css("opacity",""),o.visible=!1,l(i)&&c(i,!0)},0)}).fail(function(){console.log("failed to adjust the position of org-chart!")}):e.when(function(t){var n=e.Deferred(),i=t.closest("table").parent().siblings().removeClass("hidden"),s=t.closest("table").closest("tr").siblings(),a=s.eq(2).children();return a.slice(1,a.length-1).removeClass("hidden"),t.children(".topEdge").data("parentState").visible?i.each(function(t,n){e(n).find("div.node").closest("tr").siblings().addClass("hidden")}):s.removeClass("hidden"),n.resolve(),i.find("div.node").animate({opacity:1,left:0},300),n.promise()}(i)).done(function(){o.visible=!0,d(i)}).fail(function(){console.log("failed to adjust the position of org-chart!")})}else{var f=n.parent()[0].id,p=!n.siblings(".topEdge").data("parentState").exist?h.ajaxURL.families:h.ajaxURL.siblings;a(n,i,h)&&e.ajax({url:p+f+"/",dataType:"json"}).done(function(e,t,s){i.closest("div.orgchart").data("inAjax")&&((e.siblings||e.children)&&b(i,e,h),i.children(".topEdge").data("parentState").exist=!0,o.exist=!0,n.is(".leftEdge")?n.siblings(".rightEdge").data("siblingsState",{exist:!0,visible:!0}):n.siblings(".leftEdge").data("siblingsState",{exist:!0,visible:!0}))}).fail(function(e,t,n){console.log("Failed to get sibling nodes data"),o.exist=!0}).always(function(){r(n,i,h)})}}),p.children(".leftEdge").on("mouseenter mouseleave",function(n){if("mouseenter"===n.type){var i=e(this).siblings(".rightEdge");t(e(this),"siblings").visible?i.addClass("rightEdgeMoveLeft"):i.addClass("rightEdgeMoveRight")}else e(this).siblings(".rightEdge").removeClass("rightEdgeMoveRight rightEdgeMoveLeft")}),h.createNode&&h.createNode(p,i),f.resolve(p),f.promise()}function f(t,n,i,s,a){var r,l=n[s.nodeChildren],o=!!l&&l.length;if(Object.keys(n).length>1&&(r=e("<table>"),t.append(r),e.when(h(n,s)).done(function(e){r.append(e.wrap("<tr><td"+(o?' colspan="'+2*l.length+'"':"")+"></td></tr>").closest("tr")),a&&a()}).fail(function(){console.log("Failed to creat node")})),o){1===Object.keys(n).length&&(r=t);var d=i+1>=s.depth?' class="hidden"':"";r.append("<tr"+d+'><td colspan="'+2*l.length+'"><div class="down"></div></td></tr>');for(var c="<tr"+d+'><td class="right">&nbsp;</td>',p=1;p<l.length;p++)c+='<td class="left top">&nbsp;</td><td class="right top">&nbsp;</td>';c+='<td class="left">&nbsp;</td></tr>',r.append(c);var g=e("<tr"+d+">");r.append(g),e.each(l,function(){var t=e('<td colspan="2">');g.append(t),f(t,this,i+1,s,a)})}}function p(e,t,n,i){var s=t.children||t.siblings;e.find("td:first").attr("colspan",2*s.length),f(e,{children:s},0,n,i)}function g(t,n,i){var s=e.Deferred(),a=0;e.when(p.call(t.closest(".orgchart").parent(),t.closest("table"),n,i,function(){if(++a===n.children.length+1)return s.resolve(),s.promise()})).done(function(){t.children(".bottomEdge").data("childrenState",{exist:!0,visible:!0}),l(t)&&o(t.children(".bottomEdge"))}).fail(function(){console.log("failed to add children nodes")})}function v(t,n,i){(function(t,n,i){var s=this,a=e("<table>");t[n&&n.nodeRelationship?n.nodeRelationship:"relationship"]="001",e.when(h(t,n||this.data("orgchart").options)).done(function(e){a.append(e.wrap('<tr><td colspan="2"></td></tr>').closest("tr")),a.append('<tr><td colspan="2"><div class="down"></div></td></tr>'),a.append('<tr><td class="right">&nbsp;</td><td class="left">&nbsp;</td></tr>');var t=s.children(".orgchart");t.prepend(a).children("table:first").append('<tr><td colspan="2"></td></tr>').children().children("tr:last").children().append(t.children("table").last()),i()}).fail(function(){console.log("Failed to create parent node")})}).call(t.closest(".orgchart").parent(),n,i,function(){t.children(".title").after('<i class="edge verticalEdge topEdge fa"></i>').data("parentState",{exist:!0,visible:!0}),l(t)&&o(t.children(".topEdge"))})}function u(t,n,i){for(var s="",a=0;a<i;a++)s+='<td class="left top">&nbsp;</td><td class="right top">&nbsp;</td>';t.parent().prevAll("tr:gt(0)").children().attr("colspan",2*n).end().next().children(":first").after(e(s))}function b(t,n,i){e.when(function(t,n,i){var s=e.Deferred(),i=i||this.data("orgchart").options,a=n.siblings?n.siblings.length:n.children.length,r=t.parent().is("td")?t.closest("tr").children().length:1,l=r+a,o=l>1?Math.floor(l/2-1):0;if(t.parent().is("td")){var d=t.closest("tr").prevAll("tr:last");d.is(":hidden")&&d.removeClass("hidden"),t.closest("tr").prevAll("tr:lt(2)").remove();var c=0;p.call(t.closest(".orgchart").parent(),t.parent().closest("table"),n,i,function(){if(++c===a)return r>1?u(t.parent().closest("table").children().children("tr:last").children("td:first").before(t.closest("td").siblings().andSelf().unwrap()),l,r):u(t.parent().closest("table").children().children("tr:last").children("td").eq(o).after(t.closest("td").unwrap()),l,1),s.resolve(),s.promise()})}else{var h=0;f(t.closest("div.orgchart"),n,0,i,function(){if(++h===l)return u(t.next().children().children("tr:last").children().eq(o).after(e('<td colspan="2">').append(t)),l,1),s.resolve(),s.promise()})}}.call(t.closest(".orgchart").parent(),t.closest("table"),n,i)).done(function(){t.children(".leftEdge").length||t.children(".topEdge").after('<i class="edge horizontalEdge rightEdge fa"></i>').siblings(".bottomEdge").after('<i class="edge horizontalEdge leftEdge fa"></i>'),t.children(".rightEdge, .leftEdge").data("siblingsState",{exist:!0,visible:!0}),l(t)&&d(t)}).fail(function(){console.log("failed to adjust the position of org-chart!")})}e.fn.orgchart=function(t){switch(t){case"buildHierarchy":return f.apply(this,Array.prototype.splice.call(arguments,1));case"addChildren":return g.apply(this,Array.prototype.splice.call(arguments,1));case"addParent":return v.apply(this,Array.prototype.splice.call(arguments,1));case"addSiblings":return b.apply(this,Array.prototype.splice.call(arguments,1));default:var n=e.extend({nodeRelationship:"relationship",nodeChildren:"children",depth:999,chartClass:"",exportButton:!1,exportFilename:"OrgChart",parentNodeSymbol:"fa-users"},t);this.data("orgchart",{options:n})}var i=this,s=n.data,a=e("<div>",{class:"orgchart"+(""!==n.chartClass?" "+n.chartClass:""),click:function(t){e(t.target).closest(".node").length||a.find(".node.focused").removeClass("focused")}});if("object"===e.type(s)?f(a,s,0,n):e.ajax({url:s,dataType:"json",beforeSend:function(){a.append('<i class="fa fa-circle-o-notch fa-spin spinner"></i>')}}).done(function(e,t,i){f(a,e,0,n)}).fail(function(e,t,n){console.log(n)}).always(function(){a.children(".spinner").remove()}),i.append(a),n.exportButton){var r=e("<button>",{class:"oc-export-btn"+(""!==n.chartClass?" "+n.chartClass:""),text:"Export",click:function(){if(e(this).children(".spinner").length>0)return!1;var t=i.find(".mask");t.length?t.removeClass("hidden"):i.append('<div class="mask"><i class="fa fa-circle-o-notch fa-spin spinner"></i></div>'),html2canvas(a[0],{onrendered:function(e){i.find(".mask").addClass("hidden").end().find(".oc-download-btn").attr("href",e.toDataURL())[0].click()}})}}),l='<a class="oc-download-btn'+(""!==n.chartClass?" "+n.chartClass:"")+'" download="'+n.exportFilename+'.png"></a>';i.append(r).append(l)}return i}}(jQuery);