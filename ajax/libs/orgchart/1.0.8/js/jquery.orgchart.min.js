"use strict";!function(e){"object"==typeof module&&"object"==typeof module.exports?e(require("jquery"),window,document):e(jQuery,window,document)}(function(e,n,t,s){function i(n){var t={name:n.contents().eq(0).text().trim(),relationship:(n.parent().parent().is("li")?"1":"0")+(n.siblings("li").length?1:0)+(n.children("ul").length?1:0)};return n[0].id&&(t.id=n[0].id),n.children("ul").children().each(function(){t.children||(t.children=[]),t.children.push(i(e(this)))}),t}function a(e,n){return e.relationship=n+(e.children?1:0),e.children&&e.children.forEach(function(n){a(n,"1"+(e.children.length>1?1:0))}),e}function l(n){var t=n.find("tr:first"),s={id:t.find(".node")[0].id};return t.siblings(":last").children().each(function(){s.children||(s.children=[]),s.children.push(l(e(this)))}),s}function d(n){return(n=n||e(this).find(".orgchart")).find(".node:first")[0].id?l(n):"Error: Nodes of orghcart to be exported must have id attribute!"}function r(e,n){var t={};return(t="parent"===n?e.closest("table").closest("tr").siblings(":first").find(".node"):"children"===n?e.closest("tr").siblings():e.closest("table").parent().siblings()).length?t.is(":visible")?{exist:!0,visible:!0}:{exist:!0,visible:!1}:{exist:!1,visible:!1}}function o(e){var n=e.closest("table").closest("tr").siblings();n.eq(0).find(".spinner").length&&e.closest(".orgchart").data("inAjax",!1),r(e,"siblings").visible&&p(e);var t=n.slice(1);t.css("visibility","hidden");var s=n.eq(0).find(".node"),i=r(s,"parent").visible;s.length&&s.is(":visible")&&s.addClass("slide slide-down").one("transitionend",function(){s.removeClass("slide"),t.removeAttr("style"),n.addClass("hidden")}),s.length&&i&&o(s)}function c(n){var t=n.closest("table").closest("tr").siblings().removeClass("hidden");t.eq(2).children().slice(1,-1).addClass("hidden");var s=t.eq(0).find(".node")[0];C(s),e(s).addClass("slide").removeClass("slide-down").one("transitionend",function(){e(s).removeClass("slide"),u(n)&&b(n.children(".topEdge"))})}function h(e){var n=e.closest("tr").siblings().removeClass("hidden").eq(2).children().find("tr:first").find(".node:visible");C(n.get(0)),n.addClass("slide").removeClass("slide-up").eq(0).one("transitionend",function(){n.removeClass("slide"),u(e)&&b(e.children(".bottomEdge"))})}function p(e){var n=e.closest("table").parent();n.siblings().find(".spinner").length&&e.closest(".orgchart").data("inAjax",!1),n.prevAll().find(".node:visible").addClass("slide slide-right"),n.nextAll().find(".node:visible").addClass("slide slide-left");var t=n.siblings().find(".slide"),s=t.closest(".nodes").prevAll(".lines").css("visibility","hidden");t.eq(0).one("transitionend",function(){s.removeAttr("style"),n.closest(".nodes").prev().children().slice(1,-1).addClass("hidden"),t.removeClass("slide"),n.siblings().find(".node:visible:gt(0)").removeClass("slide-left slide-right").addClass("slide-up"),n.siblings().find(".lines, .nodes").addClass("hidden"),n.siblings().addClass("hidden"),u(e)&&m(e,!0)})}function f(n){var t=n.closest("table").parent().siblings().removeClass("hidden"),s=n.closest("table").closest("tr").siblings();if(s.eq(2).children().slice(1,-1).removeClass("hidden"),!r(n,"parent").visible){s.removeClass("hidden");var i=s.find(".node")[0];C(i),e(i).addClass("slide").removeClass("slide-down").one("transitionend",function(){e(this).removeClass("slide")})}t.find(".node:visible").addClass("slide").removeClass("slide-left slide-right").eq(-1).one("transitionend",function(){t.find(".node:visible").removeClass("slide"),u(n)&&function(e){m(e,!1),e.children(".topEdge").removeClass("fa-chevron-up").addClass("fa-chevron-down")}(n)})}function g(n,t,s){var i=t.closest(".orgchart");return(void 0===i.data("inAjax")||!0!==i.data("inAjax"))&&(n.addClass("hidden"),t.append('<i class="fa fa-circle-o-notch fa-spin spinner"></i>'),t.children().not(".spinner").css("opacity",.2),i.data("inAjax",!0),e(".oc-export-btn"+(""!==s.chartClass?"."+s.chartClass:"")).prop("disabled",!0),!0)}function v(n,t,s){var i=t.closest("div.orgchart");n.removeClass("hidden"),t.find(".spinner").remove(),t.children().removeAttr("style"),i.data("inAjax",!1),e(".oc-export-btn"+(""!==s.chartClass?"."+s.chartClass:"")).prop("disabled",!1)}function u(e){return e.children(".edge").attr("class").indexOf("fa-")>-1}function b(e){e.toggleClass("fa-chevron-up").toggleClass("fa-chevron-down")}function m(e,n){e.children(".leftEdge").toggleClass("fa-chevron-right",!n).toggleClass("fa-chevron-left",n),e.children(".rightEdge").toggleClass("fa-chevron-left",!n).toggleClass("fa-chevron-right",n)}function C(e){e.style.offsetWidth=e.offsetWidth}function x(n,t,s){var i=e.Deferred(),a=e("<div"+(s.draggable?' draggable="true"':"")+(n[s.nodeId]?' id="'+n[s.nodeId]+'"':"")+">").addClass("node "+(n.className||"")+(t>=s.depth?" slide-up":"")).append('<div class="title">'+n[s.nodeTitle]+"</div>").append(void 0!==s.nodeContent?'<div class="content">'+n[s.nodeContent]+"</div>":""),l=n.relationship;return Number(l.substr(0,1))&&a.append('<i class="edge verticalEdge topEdge fa"></i>'),Number(l.substr(1,1))&&a.append('<i class="edge horizontalEdge rightEdge fa"></i><i class="edge horizontalEdge leftEdge fa"></i>'),Number(l.substr(2,1))&&a.append('<i class="edge verticalEdge bottomEdge fa"></i>').children(".title").prepend('<i class="fa '+s.parentNodeSymbol+' symbol"></i>'),a.on("mouseenter mouseleave",function(n){var t=e(this),s=!1,i=t.children(".topEdge"),a=(t.children(".rightEdge"),t.children(".bottomEdge")),l=t.children(".leftEdge");"mouseenter"===n.type?(i.length&&(s=r(t,"parent").visible,i.toggleClass("fa-chevron-up",!s).toggleClass("fa-chevron-down",s)),a.length&&(s=r(t,"children").visible,a.toggleClass("fa-chevron-down",!s).toggleClass("fa-chevron-up",s)),l.length&&m(t,!r(t,"siblings").visible)):t.children(".edge").removeClass("fa-chevron-up fa-chevron-down fa-chevron-right fa-chevron-left")}),a.on("click",function(n){e(this).closest(".orgchart").find(".focused").removeClass("focused"),e(this).addClass("focused")}),a.on("click",".topEdge",function(n){var t=e(this),i=t.parent(),a=r(i,"parent");if(a.exist){var l=i.closest("table").closest("tr").siblings(":first").find(".node");if(l.is(".slide"))return;a.visible?(o(i),l.one("transitionend",function(){u(i)&&(b(t),m(i,!0))})):c(i)}else{var d=t.parent()[0].id;g(t,i,s)&&e.ajax({url:s.ajaxURL.parent+d+"/",dataType:"json"}).done(function(n){i.closest(".orgchart").data("inAjax")&&(e.isEmptyObject(n)||j.call(i.closest(".orgchart").parent(),i,n,s))}).fail(function(){console.log("Failed to get parent node data")}).always(function(){v(t,i,s)})}}),a.on("click",".bottomEdge",function(n){var t=e(this),i=t.parent(),a=r(i,"children");if(a.exist){if(i.closest("tr").siblings(":last").find(".node:visible").is(".slide"))return;a.visible?function(e){var n=e.closest("tr").siblings();n.last().find(".spinner").length&&e.closest(".orgchart").data("inAjax",!1);var t=n.last().find(".node:visible"),s=t.closest("table").closest("tr").prevAll(".lines").css("visibility","hidden");t.addClass("slide slide-up").eq(0).one("transitionend",function(){t.removeClass("slide"),s.removeAttr("style").addClass("hidden").siblings(".nodes").addClass("hidden"),u(e)&&b(e.children(".bottomEdge"))})}(i):h(i)}else{var l=t.parent()[0].id;g(t,i,s)&&e.ajax({url:s.ajaxURL.children+l+"/",dataType:"json"}).done(function(n,t,a){i.closest(".orgchart").data("inAjax")&&n.children.length&&w(i,n,e.extend({},s,{depth:0}))}).fail(function(e,n,t){console.log("Failed to get children nodes data")}).always(function(){v(t,i,s)})}}),a.on("click",".leftEdge, .rightEdge",function(n){var t=e(this),i=t.parent(),a=r(i,"siblings");if(a.exist){if(i.closest("table").parent().siblings().find(".node:visible").is(".slide"))return;a.visible?p(i):f(i)}else{var l=t.parent()[0].id,d=r(i,"parent").exist?s.ajaxURL.siblings:s.ajaxURL.families;g(t,i,s)&&e.ajax({url:d+l+"/",dataType:"json"}).done(function(e,n,t){i.closest(".orgchart").data("inAjax")&&(e.siblings||e.children)&&q(i,e,s)}).fail(function(e,n,t){console.log("Failed to get sibling nodes data")}).always(function(){v(t,i,s)})}}),s.draggable&&a.on("dragstart",function(n){n.originalEvent.dataTransfer.setData("text/html","hack for firefox");var t=e(this),s=t.closest("table").find(".node");t.closest(".orgchart").data("dragged",t).find(".node").each(function(n,t){-1===s.index(t)&&e(t).addClass("allowedDrop")})}).on("dragover",function(n){n.preventDefault();var t=e(this);t.closest(".orgchart").data("dragged").closest("table").find(".node").index(t)>-1&&(n.originalEvent.dataTransfer.dropEffect="none")}).on("dragend",function(n){e(this).closest(".orgchart").find(".allowedDrop").removeClass("allowedDrop")}).on("drop",function(n){var t=e(this),s=t.closest(".orgchart"),i=s.data("dragged");s.find(".allowedDrop").removeClass("allowedDrop");var a=i.closest(".nodes").siblings().eq(0).children();if(t.closest("tr").siblings().length){var l=parseInt(t.parent().attr("colspan"))+2,d='<i class="edge horizontalEdge rightEdge fa"></i><i class="edge horizontalEdge leftEdge fa"></i>';t.closest("tr").next().addBack().children().attr("colspan",l),i.find(".horizontalEdge").length||i.append(d),t.closest("tr").siblings().eq(1).children(":last").before('<td class="left top">&nbsp;</td><td class="right top">&nbsp;</td>').end().next().append(i.closest("table").parent());var r=i.closest("table").parent().siblings().find(".node:first");1===r.length&&r.append(d)}else t.append('<i class="edge verticalEdge bottomEdge fa"></i>').parent().attr("colspan",2).parent().after('<tr class="lines"><td colspan="2"><div class="down"></div></td></tr><tr class="lines"><td class="right">&nbsp;</td><td class="left">&nbsp;</td></tr><tr class="nodes"></tr>').siblings(":last").append(i.find(".horizontalEdge").remove().end().closest("table").parent());var o=parseInt(a.attr("colspan"));if(o>2){a.attr("colspan",o-2).parent().next().children().attr("colspan",o-2).end().next().children().slice(1,3).remove();var c=a.parent().siblings(".nodes").children().find(".node:first");1===c.length&&c.find(".horizontalEdge").remove()}else a.removeAttr("colspan").find(".bottomEdge").remove().end().end().siblings().remove();s.triggerHandler({type:"nodedropped.orgchart",draggedNode:i,dragZone:a.children(),dropZone:t})}),s.createNode&&s.createNode(a,n),i.resolve(a),i.promise()}function y(n,t,s,i,a){var l,d=t[i.nodeChildren],r=!!d&&d.length;if(Object.keys(t).length>1&&(l=e("<table>"),n.append(l),e.when(x(t,s,i)).done(function(e){l.append(e.wrap("<tr><td"+(r?' colspan="'+2*d.length+'"':"")+"></td></tr>").closest("tr")),a&&a()}).fail(function(){console.log("Failed to creat node")})),r){1===Object.keys(t).length&&(l=n);var o=s+1>=i.depth?" hidden":"";l.append('<tr class="lines'+o+'"><td colspan="'+2*d.length+'"><div class="down"></div></td></tr>');for(var c='<tr class="lines'+o+'"><td class="right">&nbsp;</td>',h=1;h<d.length;h++)c+='<td class="left top">&nbsp;</td><td class="right top">&nbsp;</td>';c+='<td class="left">&nbsp;</td></tr>',l.append(c);var p=e('<tr class="nodes'+o+'">');l.append(p),e.each(d,function(){var n=e('<td colspan="2">');p.append(n),y(n,this,s+1,i,a)})}}function E(e,n,t,s){var t=t||e.closest(".orgchart").data("options"),i=n.children||n.siblings;e.find("td:first").attr("colspan",2*i.length),y(e,{children:i},0,t,s)}function w(e,n,t){var s=0;E.call(e.closest(".orgchart").parent(),e.closest("table"),n,t,function(){++s===n.children.length&&(e.children(".bottomEdge").length||e.append('<i class="edge verticalEdge bottomEdge fa"></i>'),e.find(".symbol").length||e.children(".title").prepend('<i class="fa '+t.parentNodeSymbol+' symbol"></i>'),h(e))})}function j(n,t,s){(function(n,t,s,i){var a=this,l=e("<table>");t.relationship="001",e.when(x(t,0,s||n.closest(".orgchart").data("options"))).done(function(e){l.append(e.removeClass("slide-up").addClass("slide-down").wrap('<tr class="hidden"><td colspan="2"></td></tr>').closest("tr")),l.append('<tr class="lines hidden"><td colspan="2"><div class="down"></div></td></tr>'),l.append('<tr class="lines hidden"><td class="right">&nbsp;</td><td class="left">&nbsp;</td></tr>');var n=a.children(".orgchart");n.prepend(l).children("table:first").append('<tr class="nodes"><td colspan="2"></td></tr>').children().children("tr:last").children().append(n.children("table").last()),i()}).fail(function(){console.log("Failed to create parent node")})}).call(this,n,t,s,function(){n.children(".topEdge").length||n.children(".title").after('<i class="edge verticalEdge topEdge fa"></i>'),c(n)})}function A(e,n,t){for(var s="",i=0;i<t;i++)s+='<td class="left top">&nbsp;</td><td class="right top">&nbsp;</td>';e.parent().prevAll("tr:gt(0)").children().attr("colspan",2*n).end().next().children(":first").after(s)}function q(n,t,s){(function(n,t,s,i){var s=s||n.closest(".orgchart").data("options"),a=t.siblings?t.siblings.length:t.children.length,l=n.parent().is("td")?n.closest("tr").children().length:1,d=l+a,r=d>1?Math.floor(d/2-1):0;if(n.parent().is("td")){n.closest("tr").prevAll("tr:last"),n.closest("tr").prevAll("tr:lt(2)").remove();var o=0;E.call(n.closest(".orgchart").parent(),n.parent().closest("table"),t,s,function(){if(++o===a){var e=n.parent().closest("table").children().children("tr:last").children("td");l>1?(A(e.eq(0).before(n.closest("td").siblings().andSelf().unwrap()),d,l),e.addClass("hidden").find(".node").addClass("slide-left")):(A(e.eq(r).after(n.closest("td").unwrap()),d,1),e.not(":eq("+r+"1)").addClass("hidden").slice(0,r).find(".node").addClass("slide-right").end().end().slice(r).find(".node").addClass("slide-left")),i()}})}else{var c=0;y(n.closest(".orgchart"),t,0,s,function(){++c===d&&(A(n.next().children().children("tr:last").children().eq(r).after(e('<td colspan="2">').append(n)),d,1),n.closest("tr").siblings().eq(0).addClass("hidden").find(".node").addClass("slide-down"),n.parent().siblings().addClass("hidden").slice(0,r).find(".node").addClass("slide-right").end().end().slice(r).find(".node").addClass("slide-left"),i())})}}).call(n.closest(".orgchart").parent(),n.closest("table"),t,s,function(){n.children(".leftEdge").length||n.children(".topEdge").after('<i class="edge horizontalEdge rightEdge fa"></i><i class="edge horizontalEdge leftEdge fa"></i>'),f(n)})}e.fn.orgchart=function(n){switch(n){case"buildHierarchy":return y.apply(this,Array.prototype.splice.call(arguments,1));case"addChildren":return w.apply(this,Array.prototype.splice.call(arguments,1));case"addParent":return j.apply(this,Array.prototype.splice.call(arguments,1));case"addSiblings":return q.apply(this,Array.prototype.splice.call(arguments,1));case"removeNodes":return function(e){var n=e.closest("table").parent(),t=n.parent().siblings();n.is("td")?r(e,"siblings").exist?(t.eq(2).children(".top:lt(2)").remove(),t.eq(":lt(2)").children().attr("colspan",t.eq(2).children().length),n.remove()):t.eq(0).children().removeAttr("colspan").find(".bottomEdge").remove().end().end().siblings().remove():n.add(n.siblings()).remove()}.apply(this,Array.prototype.splice.call(arguments,1));case"getHierarchy":return d.apply(this,Array.prototype.splice.call(arguments,1));default:var s=e.extend({nodeTitle:"name",nodeId:"id",nodeChildren:"children",depth:999,chartClass:"",exportButton:!1,exportFilename:"OrgChart",parentNodeSymbol:"fa-users",draggable:!1,direction:"t2b",panzoom:!1},n)}var l=this,o=s.data,c=e("<div>",{data:{options:s},class:"orgchart"+(""!==s.chartClass?" "+s.chartClass:"")+("t2b"!==s.direction?" "+s.direction:""),click:function(n){e(n.target).closest(".node").length||c.find(".node.focused").removeClass("focused")}});if("object"===e.type(o)?o instanceof e?y(c,i(o.children()),0,s):y(c,s.ajaxURL?o:a(o,"00"),0,s):e.ajax({url:o,dataType:"json",beforeSend:function(){c.append('<i class="fa fa-circle-o-notch fa-spin spinner"></i>')}}).done(function(e,n,t){y(c,s.ajaxURL?e:a(e,"00"),0,s)}).fail(function(e,n,t){console.log(t)}).always(function(){c.children(".spinner").remove()}),l.append(c),s.exportButton&&!l.find(".oc-export-btn").length){var h=e("<button>",{class:"oc-export-btn"+(""!==s.chartClass?" "+s.chartClass:""),text:"Export",click:function(){if(e(this).children(".spinner").length)return!1;var n=l.find(".mask");n.length?n.removeClass("hidden"):l.append('<div class="mask"><i class="fa fa-circle-o-notch fa-spin spinner"></i></div>'),html2canvas(l.find(".orgchart:visible").get(0),{onrendered:function(e){l.find(".mask").addClass("hidden").end().find(".oc-download-btn").attr("href",e.toDataURL())[0].click()}})}}),p='<a class="oc-download-btn'+(""!==s.chartClass?" "+s.chartClass:"")+'" download="'+s.exportFilename+'.png"></a>';l.append(h).append(p)}return s.panzoom&&(l.css("overflow","hidden"),c.on("mousedown",function(n){var s=e(this);if(e(n.target).closest(".node").length)s.data("panning",!1);else{s.css("cursor","move").data("panning",!0);var i=0,a=0,l=s.css("transform");if("none"!==l){var d=l.split(",");-1===l.indexOf("3d")?(i=parseInt(d[4]),a=parseInt(d[5])):(i=parseInt(d[12]),a=parseInt(d[13]))}var r=n.pageX-i,o=n.pageY-a;e(t).on("mousemove",function(e){var n=e.pageX-r,t=e.pageY-o,i=s.css("transform");if("none"===i)-1===i.indexOf("3d")?s.css("transform","matrix(1, 0, 0, 1, "+n+", "+t+")"):s.css("transform","matrix3d(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, "+n+", "+t+", 0, 1)");else{var a=i.split(",");-1===i.indexOf("3d")?(a[4]=" "+n,a[5]=" "+t+")"):(a[12]=" "+n,a[13]=" "+t),s.css("transform",a.join(","))}})}}),e(t).on("mouseup",function(){c.data("panning")&&(c.css("cursor","default"),e(this).off("mousemove"))}),l.on("wheel",function(e){e.preventDefault();var n=c.css("transform"),t=1+(e.originalEvent.deltaY>0?-.2:.2);"none"===n?c.css("transform","scale("+t+","+t+")"):-1===n.indexOf("3d")?c.css("transform",n+" scale("+t+","+t+")"):c.css("transform",n+" scale3d("+t+","+t+", 1)")})),l}});