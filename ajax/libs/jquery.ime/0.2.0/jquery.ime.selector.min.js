!function(e){"use strict";function t(i,n){this.$element=e(i),this.options=e.extend({},t.defaults,n),this.active=!1,this.$imeSetting=null,this.$menu=null,this.inputmethod=null,this.timer=null,this.init(),this.listen()}var i,n;t.prototype={constructor:t,init:function(){this.prepareSelectorMenu(),this.position(),this.$imeSetting.hide()},prepareSelectorMenu:function(){this.$imeSetting=e(i),this.$menu=e('<div class="imeselector-menu" role="menu">'),this.$menu.append(e("<h3>").addClass("ime-list-title autonym"),e("<ul>").addClass("ime-list"),e('<div class="ime-disable selectable-row">').append(e("<span>").attr({class:"ime-disable-link","data-i18n":"jquery-ime-disable-text"}).addClass("ime-checked").text("System input method"),e("<span>").addClass("ime-disable-shortcut").text("CTRL+M")),e("<h3>").addClass("ime-lang-title").attr("data-i18n","jquery-ime-other-languages").text("Other languages")),this.prepareLanguageList(),this.$menu.append(this.helpLink()),e.i18n&&this.$menu.i18n(),this.$imeSetting.append(this.$menu),e("body").append(this.$imeSetting)},stopTimer:function(){this.timer&&(clearTimeout(this.timer),this.timer=null),this.$imeSetting.stop(!0,!0)},resetTimer:function(){var e=this;this.stopTimer(),this.timer=setTimeout(function(){e.$imeSetting.animate({opacity:0,marginTop:"-20px"},500,function(){e.$imeSetting.hide(),e.$imeSetting.css("opacity",1),e.$imeSetting.css("margin-top",0)})},this.options.timeout)},focus:function(){e("div.imeselector").hide(),e("div.imeselector-menu").removeClass("ime-open"),this.$imeSetting.show(),this.resetTimer()},show:function(){return this.$menu.addClass("ime-open"),this.stopTimer(),this.$imeSetting.show(),!1},hide:function(){return this.$menu.removeClass("ime-open"),this.resetTimer(),!1},toggle:function(){this.$menu.hasClass("ime-open")?this.hide():this.show()},listen:function(){var t=this;t.$imeSetting.on("click.ime",function(i){return e(i.target).hasClass("imeselector-toggle")&&t.toggle(),!1}),t.$element.on("blur.ime",function(){t.$imeSetting.hasClass("ime-onfocus")||(t.$imeSetting.hide(),t.hide())}),e("html").click(function(){t.hide()}),this.$menu.on("click",function(e){e.stopPropagation()}),t.$imeSetting.mouseenter(function(){t.stopTimer(),t.$imeSetting.addClass("ime-onfocus")}).mouseleave(function(){t.resetTimer(),t.$imeSetting.removeClass("ime-onfocus")}),t.$menu.on("click.ime","li",function(){return t.$element.focus(),!1}),t.$menu.on("click.ime","li.ime-im",function(){return t.selectIM(e(this).data("ime-inputmethod")),t.$element.trigger("setim.ime",e(this).data("ime-inputmethod")),!1}),t.$menu.on("click.ime","li.ime-lang",function(){var i=t.selectLanguage(e(this).attr("lang"));return t.$element.trigger("setim.ime",i),!1}),t.$menu.on("click.ime","div.ime-disable",function(){return t.disableIM(),!1}),t.$menu.on("click.ime",".ime-help-link",function(e){e.stopPropagation()}),t.$element.on("focus.ime",function(e){t.selectLanguage(t.decideLanguage()),t.focus(),e.stopPropagation()}),t.$element.attrchange(function(){t.$element.is(":hidden")&&t.$imeSetting.hide()}),t.$element.on("mouseup.ime",e.proxy(this.position,this)),t.$element.on("keydown.ime",e.proxy(this.keydown,this)),e(window).resize(function(){t.position()})},keydown:function(t){var i,n,s,a=e(t.target).data("ime");return this.focus(),!function(e){return e.ctrlKey&&!e.altKey&&77===e.which}(t)||(a.isActive()?(this.disableIM(),this.$element.trigger("setim.ime","system")):null!==this.inputmethod?(this.selectIM(this.inputmethod.id),this.$element.trigger("setim.ime",this.inputmethod.id)):(s=this.decideLanguage(),this.selectLanguage(s),!a.isActive()&&e.ime.languages[s]&&((n=e.ime.preferences.getPreviousInputMethods())[0]?this.selectIM(n[0]):(i=e.ime.languages[s].inputmethods[0],this.selectIM(i)))),t.preventDefault(),t.stopPropagation(),!1)},position:function(){var t,i,n,s,a,o,m,l,r,u=this,h="rtl"===this.$element.css("direction"),c=e(window);this.focus(),a=(s=this.$element.offset()).top+this.$element.outerHeight(),o=s.left,h||(o=s.left+this.$element.outerWidth()-this.$imeSetting.outerWidth()),c.height()+e(document).scrollTop()-a<this.$imeSetting.outerHeight()&&(a=s.top-this.$imeSetting.outerHeight(),(i=this.$menu.outerHeight()+this.$imeSetting.outerHeight())<a&&this.$menu.addClass("ime-position-top").css("top",-i)),m=a,l=o,this.$element.parents().each(function(){if("fixed"===e(this).css("position"))return u.$imeSetting.css("position","fixed"),m-=e(document).scrollTop(),l-=e(document).scrollLeft(),!1}),this.$imeSetting.css({top:m,left:l}),t=this.$menu.width(),r=o-e(document).scrollLeft()+t>c.width(),(t>o||h&&r)&&(h?r?(this.$menu.addClass("ime-right"),n=this.$imeSetting.outerWidth()-t):n=0:(this.$menu.addClass("ime-right"),n=s.left),this.$menu.css("left",n))},selectLanguage:function(t){var i,n,s;return t=t&&t.toLowerCase(),i=this.$element.data("ime"),n=e.ime.preferences.getIM(t),s=e.ime.languages[t],this.setMenuTitle(this.getAutonym(t)),!!s&&(i.getLanguage()===t?(i.inputmethod&&i.inputmethod.id!==n&&this.selectIM(e.ime.preferences.getIM(t)),e.ime.preferences.getIM(t)):(this.$menu.find("li.ime-lang").show(),this.$menu.find("li[lang="+t+"]").hide(),this.prepareInputMethods(t),this.hide(),i.setLanguage(t),this.inputmethod=null,this.selectIM(e.ime.preferences.getIM(t)),e.ime.preferences.getIM(t)))},getAutonym:function(t){return e.ime.languages[t]&&e.ime.languages[t].autonym},setMenuTitle:function(e){this.$menu.find(".ime-list-title").text(e)},decideLanguage:function(){return e.ime.preferences.getLanguage()?e.ime.preferences.getLanguage():this.$element.attr("lang")&&e.ime.languages[this.$element.attr("lang")]?this.$element.attr("lang"):e.ime.preferences.getDefaultLanguage()},selectIM:function(t){var i,n=this;t&&(this.$menu.find(".ime-checked").removeClass("ime-checked"),this.$menu.find("li[data-ime-inputmethod="+t+"]").addClass("ime-checked"),i=this.$element.data("ime"),"system"!==t?i.load(t).done(function(){n.inputmethod=e.ime.inputmethods[t],n.hide(),i.enable(),i.setIM(t),n.$imeSetting.find("a.ime-name").text(e.ime.sources[t].name),n.position(),e.ime.preferences.save()}):this.disableIM())},disableIM:function(){this.$menu.find(".ime-checked").removeClass("ime-checked"),this.$menu.find("div.ime-disable").addClass("ime-checked"),this.$element.data("ime").disable(),this.$imeSetting.find("a.ime-name").text(""),this.hide(),this.position(),e.ime.preferences.save()},prepareLanguageList:function(){var t,i,n,s,a,o,m;i=e('<div class="ime-language-list-wrapper">'),n=e('<ul class="ime-language-list">'),s=e.isFunction(this.options.languages)?this.options.languages():this.options.languages;for(t in s)m=s[t],e.ime.languages[m]&&(a=e("<a>").attr("href","#").text(this.getAutonym(m)).addClass("selectable-row-item autonym"),(o=e('<li class="ime-lang selectable-row">').attr("lang",m)).append(a),n.append(o));i.append(n),this.$menu.append(i),this.options.languageSelector&&this.$menu.append(this.options.languageSelector())},prepareInputMethods:function(t){var i=e.ime.languages[t],n=this.$menu.find(".ime-list"),s=this;n.empty(),e.each(i.inputmethods,function(t,i){var a,o,m,l;(m=e.ime.sources[i])&&(l=m.name,a=e("<a>").attr("href","#").text(l).addClass("selectable-row-item"),o=e("<li>").attr("data-ime-inputmethod",i).addClass("ime-im selectable-row").append('<span class="ime-im-check"></span>',a),s.options.helpHandler&&o.append(s.options.helpHandler.call(s,i)),n.append(o))})},helpLink:function(){return e('<div class="ime-help-link selectable-row">').append(e("<a>").text("Help").addClass("selectable-row-item").attr({href:"http://github.com/wikimedia/jquery.ime",target:"_blank","data-i18n":"jquery-ime-help"}))}},t.defaults={defaultLanguage:"en",timeout:2500},e.fn.imeselector=function(i){return this.each(function(){var n=e(this),s=n.data("imeselector");s||n.data("imeselector",s=new t(this,i)),"string"==typeof i&&s[i].call(n)})},e.fn.imeselector.Constructor=t,i='<div class="imeselector imeselector-toggle"><a class="ime-name imeselector-toggle" href="#"></a><b class="ime-setting-caret imeselector-toggle"></b></div>',n=window.MutationObserver||window.WebKitMutationObserver||window.MozMutationObserver,e.fn.attrchange=function(e){var t;return n?(t=new n(function(t){t.forEach(function(t){e.call(t.target,t.attributeName)})}),this.each(function(){t.observe(this,{subtree:!1,attributes:!0})})):function(){var e=document.createElement("p"),t=!1;if(e.addEventListener)e.addEventListener("DOMAttrModified",function(){t=!0},!1);else{if(!e.attachEvent)return!1;e.attachEvent("onDOMAttrModified",function(){t=!0})}return e.setAttribute("id","target"),t}()?this.on("DOMAttrModified",function(t){e.call(this,t.originalEvent.attrName)}):"onpropertychange"in document.body?this.on("propertychange",function(){e.call(this,window.event.propertyName)}):void 0}}(jQuery);